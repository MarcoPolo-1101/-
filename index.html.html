<html lang="zh-CN"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marco Polo ç®¡ç†ç³»ç»Ÿ</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    
    <!-- Supabaseå®¢æˆ·ç«¯ä¿®å¤å·¥å…· -->
    <script src="fix-supabase-client.js"></script>
    
    <!-- Supabaseå®¢æˆ·ç«¯ - åŸºäºfetch APIå®ç° -->
    <script>
        // å…¨å±€Supabaseé…ç½®è·å–å‡½æ•°
        function getSupabaseConfig() {
            try {
                const config = localStorage.getItem('supabaseConfig');
                return config ? JSON.parse(config) : { url: '', key: '', enabled: false };
            } catch (error) {
                console.error('è·å–Supabaseé…ç½®å¤±è´¥:', error);
                return { url: '', key: '', enabled: false };
            }
        }
        
        // ç”¨æˆ·æƒé™æ§åˆ¶å‡½æ•°
        function applyUserPermissions(user) {
            const isAdmin = user && user.type === 'admin';
            
            console.log(`ğŸ”’ åº”ç”¨ç”¨æˆ·æƒé™: ${user?.username || 'æœªç™»å½•'} (${isAdmin ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·'})`);
            
            // å¯¼èˆªèœå•æƒé™æ§åˆ¶
            const adminOnlyPages = ['users-page', 'logs-page', 'settings-page'];
            adminOnlyPages.forEach(pageId => {
                // æ¡Œé¢å¯¼èˆª
                const desktopNavItem = document.querySelector(`.nav-item[data-page="${pageId}"]`);
                if (desktopNavItem) {
                    desktopNavItem.style.display = isAdmin ? 'flex' : 'none';
                }
                
                // ç§»åŠ¨ç«¯å¯¼èˆª
                const mobileNavItem = document.querySelectorAll('.mobile-nav .nav-item[data-page="' + pageId + '"]');
                mobileNavItem.forEach(item => {
                    item.style.display = isAdmin ? 'flex' : 'none';
                });
            });
            
            // äº§å“ç®¡ç†é¡µé¢æƒé™æ§åˆ¶
            if (!isAdmin) {
                // éšè—æ·»åŠ äº§å“æŒ‰é’®
                const addProductBtn = document.getElementById('add-product-btn');
                if (addProductBtn) {
                    addProductBtn.style.display = 'none';
                }
                
                // éšè—äº§å“è¡¨æ ¼ä¸­çš„ç¼–è¾‘å’Œåˆ é™¤æŒ‰é’®
                const productActionBtns = document.querySelectorAll('.product-action-btn');
                productActionBtns.forEach(btn => {
                    btn.style.display = 'none';
                });
                
                // éšè—æ‰¹é‡æ“ä½œæŒ‰é’®
                const batchActionBtns = document.querySelectorAll('#batch-delete-btn, #batch-export-btn');
                batchActionBtns.forEach(btn => {
                    btn.style.display = 'none';
                });
            }
        }
        
        // æ˜¾ç¤ºé€šçŸ¥çš„å·¥å…·å‡½æ•°
        function showNotification(title, message, type = 'info') {
            // åˆ›å»ºé€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 max-w-sm bg-white dark:bg-dark-1 shadow-lg rounded-lg p-4 z-50 transform transition-all duration-300 translate-x-full`;
            
            // è®¾ç½®é€šçŸ¥å†…å®¹
            const typeClasses = {
                success: 'text-success border-l-success',
                error: 'text-danger border-l-danger',
                warning: 'text-warning border-l-warning',
                info: 'text-primary border-l-primary'
            };
            
            notification.innerHTML = `
                <div class="flex items-start">
                    <div class="flex-shrink-0 w-6 h-6 flex items-center justify-center rounded-full ${type === 'success' ? 'bg-success/10 text-success' : type === 'error' ? 'bg-danger/10 text-danger' : type === 'warning' ? 'bg-warning/10 text-warning' : 'bg-primary/10 text-primary'}">
                        <i class="fa fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : type === 'warning' ? 'exclamation' : 'info'} text-sm"></i>
                    </div>
                    <div class="ml-3 flex-1">
                        <h3 class="text-sm font-medium ${typeClasses[type]}">${title}</h3>
                        <div class="mt-1 text-sm text-dark-3">${message}</div>
                    </div>
                    <button class="ml-4 text-dark-3 hover:text-dark">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            `;
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(notification);
            
            // æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // è‡ªåŠ¨å…³é—­
            const timer = setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 5000);
            
            // ç‚¹å‡»å…³é—­
            notification.querySelector('button').addEventListener('click', () => {
                clearTimeout(timer);
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            });
        }
        
        // åˆ›å»ºåŸºäºfetch APIçš„çœŸå®Supabaseå®¢æˆ·ç«¯
        function createFetchBasedSupabaseClient(supabaseUrl, supabaseKey) {
            console.log('ğŸ”§ åˆ›å»ºåŸºäºfetch APIçš„Supabaseå®¢æˆ·ç«¯');
            
            // Supabase REST APIåŸºç¡€URL
            const restUrl = `${supabaseUrl}/rest/v1`;
            
            // é»˜è®¤è¯·æ±‚å¤´
            const defaultHeaders = {
                'apikey': supabaseKey,
                'Authorization': `Bearer ${supabaseKey}`,
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            };
            
            // æ„å»ºæŸ¥è¯¢å­—ç¬¦ä¸²
            function buildQueryString(params) {
                return Object.keys(params)
                    .filter(key => params[key] !== undefined && params[key] !== null)
                    .map(key => `${encodeURIComponent(key)}=${encodeURIComponent(params[key])}`)
                    .join('&');
            }
            
            // æ‰§è¡Œfetchè¯·æ±‚
            async function executeFetch(endpoint, options = {}) {
                try {
                    const url = `${restUrl}${endpoint}`;
                    const fetchOptions = {
                        ...options,
                        headers: {
                            ...defaultHeaders,
                            ...options.headers
                        }
                    };
                    
                    console.log(`ğŸ“¡ å‘é€è¯·æ±‚åˆ°Supabase: ${url}`);
                    console.log('è¯·æ±‚é€‰é¡¹:', fetchOptions);
                    
                    const response = await fetch(url, fetchOptions);
                    console.log(`ğŸ“¡ Supabaseå“åº”çŠ¶æ€: ${response.status}`);
                    
                    // æ£€æŸ¥å“åº”çŠ¶æ€
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.message || `è¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
                    }
                    
                    // å¯¹äº204 No Contentå“åº”ï¼Œç›´æ¥è¿”å›ç©ºå¯¹è±¡
                    if (response.status === 204) {
                        return { data: null, error: null };
                    }
                    
                    // è§£æJSONå“åº”
                    const data = await response.json();
                    console.log('ğŸ“¡ Supabaseå“åº”æ•°æ®:', data);
                    
                    return { data, error: null };
                } catch (error) {
                    console.error('âŒ Supabaseè¯·æ±‚å¤±è´¥:', error);
                    return { data: null, error };
                }
            }
            
            return {
                from: function(tableName) {
                    console.log(`ğŸ¯ è®¿é—®Supabaseè¡¨: ${tableName}`);
                    
                    // è¡¨æ“ä½œå¯¹è±¡
                    const tableOperations = {
                        // æŸ¥è¯¢æ•°æ®
                        select: function(columns = '*') {
                            console.log(`ğŸ“‹ æŸ¥è¯¢ ${tableName} è¡¨ï¼Œå­—æ®µ: ${columns}`);
                            
                            let queryParams = { select: columns };
                            let queryConditions = [];
                            
                            // æŸ¥è¯¢æ„å»ºå™¨å¯¹è±¡
                            const queryBuilder = {
                                // é™åˆ¶è¿”å›æ•°é‡
                                limit: async function(count) {
                                    console.log(`ğŸ“ é™åˆ¶è¿”å› ${count} æ¡è®°å½•`);
                                    queryParams.limit = count;
                                    
                                    const queryString = buildQueryString(queryParams);
                                    const endpoint = `/${tableName}?${queryString}`;
                                    
                                    return await executeFetch(endpoint);
                                },
                                
                                // ä¸ç­‰äºæ¡ä»¶
                                neq: function(column, value) {
                                    console.log(`ğŸš« æ¡ä»¶ ${column} != ${value}`);
                                    queryConditions.push(`${column}=neq.${value}`);
                                    return this;
                                },
                                
                                // æ‰§è¡ŒæŸ¥è¯¢ï¼ˆä¸å¸¦limitæ—¶ä½¿ç”¨ï¼‰
                                execute: async function() {
                                    // åˆå¹¶æŸ¥è¯¢æ¡ä»¶
                                    const allParams = { ...queryParams };
                                    queryConditions.forEach((condition, index) => {
                                        allParams[`or.${index}`] = condition;
                                    });
                                    
                                    const queryString = buildQueryString(allParams);
                                    const endpoint = `/${tableName}?${queryString}`;
                                    
                                    return await executeFetch(endpoint);
                                }
                            };
                            
                            // è¿”å›æŸ¥è¯¢æ„å»ºå™¨å¯¹è±¡ï¼Œæ”¯æŒé“¾å¼è°ƒç”¨
                            return queryBuilder;
                        },
                        
                        // æ’å…¥æ•°æ®
                        insert: async function(data) {
                            console.log(`â• æ’å…¥æ•°æ®åˆ° ${tableName} è¡¨`);
                            console.log('æ’å…¥æ•°æ®:', data);
                            
                            const endpoint = `/${tableName}`;
                            const options = {
                                method: 'POST',
                                body: JSON.stringify(data)
                            };
                            
                            return await executeFetch(endpoint, options);
                        },
                        
                        // æ›´æ–°æ•°æ®
                        update: async function(data) {
                            console.log(`ğŸ”„ æ›´æ–° ${tableName} è¡¨æ•°æ®`);
                            console.log('æ›´æ–°æ•°æ®:', data);
                            
                            const endpoint = `/${tableName}`;
                            const options = {
                                method: 'PATCH',
                                body: JSON.stringify(data)
                            };
                            
                            return await executeFetch(endpoint, options);
                        },
                        
                        // åˆ é™¤æ•°æ®
                        delete: function() {
                            console.log(`ğŸ—‘ï¸ åˆ é™¤ ${tableName} è¡¨æ•°æ®`);
                            
                            return {
                                // ä¸ç­‰äºæ¡ä»¶åˆ é™¤
                                neq: async function(column, value) {
                                    console.log(`ğŸ—‘ï¸ åˆ é™¤æ¡ä»¶ ${column} != ${value}`);
                                    
                                    const endpoint = `/${tableName}?${column}=neq.${value}`;
                                    const options = { method: 'DELETE' };
                                    
                                    return await executeFetch(endpoint, options);
                                }
                            };
                        }
                    };
                    
                    return tableOperations;
                }
            };
        }
        
        // åˆå§‹åŒ–Supabaseå®¢æˆ·ç«¯
        async function initializeSupabaseClient() {
            try {
                console.log('ğŸ”„ åˆå§‹åŒ–Supabaseå®¢æˆ·ç«¯...');
                
                // è·å–Supabaseé…ç½®
                const supabaseConfig = getSupabaseConfig();
                
                if (!supabaseConfig.url || !supabaseConfig.key) {
                    console.warn('âš ï¸ Supabaseé…ç½®ä¸å®Œæ•´ï¼Œè¯·æ£€æŸ¥è®¾ç½®');
                    showNotification('Supabaseé…ç½®ä¸å®Œæ•´', 'è¯·åœ¨ç³»ç»Ÿè®¾ç½®ä¸­é…ç½®Supabase URLå’ŒAPIå¯†é’¥', 'warning');
                    return null;
                }
                
                console.log(`ğŸ¯ å°è¯•è¿æ¥åˆ°Supabase: ${supabaseConfig.url}`);
                
                // åˆ›å»ºåŸºäºfetch APIçš„Supabaseå®¢æˆ·ç«¯
                const supabase = createFetchBasedSupabaseClient(
                    supabaseConfig.url,
                    supabaseConfig.key
                );
                
                console.log('âœ… Supabaseå®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ');
                return supabase;
            } catch (error) {
                console.error('âŒ Supabaseå®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥:', error);
                showNotification('Supabaseè¿æ¥å¤±è´¥', error.message, 'error');
                return null;
            }
        }
        
        // å…¨å±€æ•°æ®æ“ä½œå‡½æ•°
        const DataService = {
            // è·å–Supabaseå®¢æˆ·ç«¯
            async getSupabaseClient() {
                if (window.supabase) {
                    return window.supabase;
                }
                
                // åŠ¨æ€åˆå§‹åŒ–å®¢æˆ·ç«¯
                const client = await initializeSupabaseClient();
                if (client) {
                    window.supabase = client;
                }
                return client;
            },
            
            // äº§å“ç®¡ç†
            products: {
                // è·å–æ‰€æœ‰äº§å“
                async getAll() {
                    const supabase = await DataService.getSupabaseClient();
                    if (!supabase) {
                        return { data: [], error: new Error('Supabaseå®¢æˆ·ç«¯æœªåˆå§‹åŒ–') };
                    }
                    
                    try {
                        return await supabase.from('products').select('*').execute();
                    } catch (error) {
                        console.error('è·å–äº§å“åˆ—è¡¨å¤±è´¥:', error);
                        return { data: [], error };
                    }
                },
                
                // æ·»åŠ äº§å“
                async add(productData) {
                    const supabase = await DataService.getSupabaseClient();
                    if (!supabase) {
                        return { error: new Error('Supabaseå®¢æˆ·ç«¯æœªåˆå§‹åŒ–') };
                    }
                    
                    try {
                        return await supabase.from('products').insert(productData);
                    } catch (error) {
                        console.error('æ·»åŠ äº§å“å¤±è´¥:', error);
                        return { error };
                    }
                },
                
                // æ›´æ–°äº§å“
                async update(productData) {
                    const supabase = await DataService.getSupabaseClient();
                    if (!supabase) {
                        return { error: new Error('Supabaseå®¢æˆ·ç«¯æœªåˆå§‹åŒ–') };
                    }
                    
                    try {
                        return await supabase.from('products').update(productData);
                    } catch (error) {
                        console.error('æ›´æ–°äº§å“å¤±è´¥:', error);
                        return { error };
                    }
                },
                
                // åˆ é™¤äº§å“
                async delete(id) {
                    const supabase = await DataService.getSupabaseClient();
                    if (!supabase) {
                        return { error: new Error('Supabaseå®¢æˆ·ç«¯æœªåˆå§‹åŒ–') };
                    }
                    
                    try {
                        return await supabase.from('products').delete().neq('id', id);
                    } catch (error) {
                        console.error('åˆ é™¤äº§å“å¤±è´¥:', error);
                        return { error };
                    }
                }
            },
            
            // ç”¨æˆ·ç®¡ç†
            users: {
                // è·å–æ‰€æœ‰ç”¨æˆ·
                async getAll() {
                    const supabase = await DataService.getSupabaseClient();
                    if (!supabase) {
                        return { data: [], error: new Error('Supabaseå®¢æˆ·ç«¯æœªåˆå§‹åŒ–') };
                    }
                    
                    try {
                        return await supabase.from('users').select('*').execute();
                    } catch (error) {
                        console.error('è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
                        return { data: [], error };
                    }
                },
                
                // æ·»åŠ ç”¨æˆ·
                async add(userData) {
                    const supabase = await DataService.getSupabaseClient();
                    if (!supabase) {
                        return { error: new Error('Supabaseå®¢æˆ·ç«¯æœªåˆå§‹åŒ–') };
                    }
                    
                    try {
                        return await supabase.from('users').insert(userData);
                    } catch (error) {
                        console.error('æ·»åŠ ç”¨æˆ·å¤±è´¥:', error);
                        return { error };
                    }
                },
                
                // æ›´æ–°ç”¨æˆ·
                async update(userData) {
                    const supabase = await DataService.getSupabaseClient();
                    if (!supabase) {
                        return { error: new Error('Supabaseå®¢æˆ·ç«¯æœªåˆå§‹åŒ–') };
                    }
                    
                    try {
                        return await supabase.from('users').update(userData);
                    } catch (error) {
                        console.error('æ›´æ–°ç”¨æˆ·å¤±è´¥:', error);
                        return { error };
                    }
                },
                
                // åˆ é™¤ç”¨æˆ·
                async delete(id) {
                    const supabase = await DataService.getSupabaseClient();
                    if (!supabase) {
                        return { error: new Error('Supabaseå®¢æˆ·ç«¯æœªåˆå§‹åŒ–') };
                    }
                    
                    try {
                        return await supabase.from('users').delete().neq('id', id);
                    } catch (error) {
                        console.error('åˆ é™¤ç”¨æˆ·å¤±è´¥:', error);
                        return { error };
                    }
                }
            },
            
            // èƒŒæ™¯è®¾ç½®ç®¡ç†
            backgrounds: {
                // è·å–æ‰€æœ‰èƒŒæ™¯è®¾ç½®
                async getAll() {
                    const supabase = await DataService.getSupabaseClient();
                    if (!supabase) {
                        return { data: [], error: new Error('Supabaseå®¢æˆ·ç«¯æœªåˆå§‹åŒ–') };
                    }
                    
                    try {
                        return await supabase.from('backgrounds').select('*').execute();
                    } catch (error) {
                        console.error('è·å–èƒŒæ™¯è®¾ç½®å¤±è´¥:', error);
                        return { data: [], error };
                    }
                },
                
                // æ·»åŠ æˆ–æ›´æ–°èƒŒæ™¯è®¾ç½®
                async save(backgroundData) {
                    const supabase = await DataService.getSupabaseClient();
                    if (!supabase) {
                        return { error: new Error('Supabaseå®¢æˆ·ç«¯æœªåˆå§‹åŒ–') };
                    }
                    
                    try {
                        const data = {
                            ...backgroundData,
                            updated_at: new Date().toISOString()
                        };
                        
                        // å°è¯•æ›´æ–°ï¼Œå¦‚æœæ²¡æœ‰è®°å½•åˆ™æ’å…¥
                        const updateResult = await supabase.from('backgrounds')
                            .update(data)
                            .eq('user_id', backgroundData.user_id || 'default');
                        
                        if (updateResult.error && updateResult.error.code === 'PGRST116') {
                            // æ²¡æœ‰æ‰¾åˆ°è®°å½•ï¼Œæ‰§è¡Œæ’å…¥
                            return await supabase.from('backgrounds').insert(data);
                        }
                        
                        return updateResult;
                    } catch (error) {
                        console.error('ä¿å­˜èƒŒæ™¯è®¾ç½®å¤±è´¥:', error);
                        return { error };
                    }
                },
                
                // è·å–ç‰¹å®šç”¨æˆ·çš„èƒŒæ™¯è®¾ç½®
                async getByUserId(userId) {
                    const supabase = await DataService.getSupabaseClient();
                    if (!supabase) {
                        return { data: null, error: new Error('Supabaseå®¢æˆ·ç«¯æœªåˆå§‹åŒ–') };
                    }
                    
                    try {
                        const result = await supabase.from('backgrounds')
                            .select('*')
                            .eq('user_id', userId || 'default')
                            .single()
                            .execute();
                        
                        return result;
                    } catch (error) {
                        console.error('è·å–ç”¨æˆ·èƒŒæ™¯è®¾ç½®å¤±è´¥:', error);
                        return { data: null, error };
                    }
                }
            }
        };
        
        // æ£€æŸ¥ç½‘ç»œè¿æ¥çŠ¶æ€
        async function checkNetworkConnection() {
            try {
                // æ£€æŸ¥URLå‚æ•°æ˜¯å¦æŒ‡å®šäº†æœ¬åœ°æ¨¡å¼
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('mode') === 'local') {
                    console.log('ğŸŒ ä»¥æœ¬åœ°æ¨¡å¼å¯åŠ¨ç³»ç»Ÿ');
                    return false; // ä¸éœ€è¦è¿æ¥ç½‘ç»œ
                }
                
                console.log('ğŸŒ æ­£åœ¨æ£€æŸ¥ç½‘ç»œè¿æ¥...');
                
                // æ£€æŸ¥åŸºæœ¬ç½‘ç»œè¿æ¥
                if (!navigator.onLine) {
                    console.warn('âš ï¸ ç½‘ç»œè¿æ¥ä¸å¯ç”¨');
                    return false;
                }
                
                // æ£€æŸ¥Supabaseé…ç½®
                const supabaseConfig = getSupabaseConfig();
                
                // å¦‚æœSupabaseæœªé…ç½®æˆ–æœªå¯ç”¨ï¼Œè¿”å›falseä»¥ä½¿ç”¨æœ¬åœ°æ¨¡å¼
                if (!supabaseConfig.enabled || !supabaseConfig.url || !supabaseConfig.key) {
                    console.warn('âš ï¸ Supabaseæœªé…ç½®æˆ–æœªå¯ç”¨');
                    return false;
                }
                
                // æ£€æŸ¥Supabase APIæ˜¯å¦å¯è®¿é—®
                try {
                    const response = await fetch(`${supabaseConfig.url}/rest/v1`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'apikey': supabaseConfig.key,
                            'Authorization': `Bearer ${supabaseConfig.key}`
                        },
                        timeout: 3000
                    });
                    
                    if (response.ok) {
                        console.log('âœ… Supabase APIå¯è®¿é—®');
                        return true;
                    } else {
                        console.warn(`âš ï¸ Supabase APIè¿”å›çŠ¶æ€ç : ${response.status}`);
                        
                        // å°è¯•è·å–æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                        try {
                            const errorData = await response.json();
                            console.warn('âŒ Supabase APIé”™è¯¯è¯¦æƒ…:', errorData);
                        } catch (e) {
                            console.warn('âŒ æ— æ³•è§£æSupabase APIé”™è¯¯å“åº”');
                        }
                        
                        return false;
                    }
                } catch (error) {
                    console.warn('âš ï¸ æ— æ³•è¿æ¥åˆ°Supabase API:', error.message);
                    return false;
                }
            } catch (error) {
                console.error('âŒ ç½‘ç»œæ£€æŸ¥å¤±è´¥:', error);
                return false;
            }
        }
        
        // æ˜¾ç¤ºé”™è¯¯é¡µé¢
        function showErrorPage(errorMessage) {
            document.body.innerHTML = `
                <div class="min-h-screen bg-light flex items-center justify-center p-4">
                    <div class="max-w-md w-full text-center">
                        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-danger/10 text-danger mb-4">
                            <i class="fa fa-exclamation-triangle text-2xl"></i>
                        </div>
                        <h1 class="text-2xl font-bold text-dark mb-2">è¿æ¥æœåŠ¡å¤±è´¥</h1>
                        <p class="text-dark-3 mb-6">${errorMessage}</p>
                        
                        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                            <h2 class="text-lg font-semibold mb-3">å¯èƒ½çš„åŸå› ï¼š</h2>
                            <ul class="text-left text-sm text-dark-3 space-y-2">
                                <li class="flex items-start">
                                    <i class="fa fa-circle text-xs text-danger mt-1 mr-2"></i>
                                    <span>ç½‘ç»œè¿æ¥ä¸ç¨³å®šæˆ–æ–­å¼€</span>
                                </li>
                                <li class="flex items-start">
                                    <i class="fa fa-circle text-xs text-danger mt-1 mr-2"></i>
                                    <span>æœåŠ¡åœ°å€é…ç½®é”™è¯¯</span>
                                </li>
                                <li class="flex items-start">
                                    <i class="fa fa-circle text-xs text-danger mt-1 mr-2"></i>
                                    <span>è®¿é—®å¯†é’¥æ— æ•ˆ</span>
                                </li>
                                <li class="flex items-start">
                                    <i class="fa fa-circle text-xs text-danger mt-1 mr-2"></i>
                                    <span>è¿œç¨‹æœåŠ¡æš‚æ—¶ä¸å¯ç”¨</span>
                                </li>
                            </ul>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button id="use-local-mode" class="btn btn-success flex-1">
                                <i class="fa fa-database mr-2"></i> ä½¿ç”¨æœ¬åœ°æ¨¡å¼
                            </button>
                            <button id="retry-connection" class="btn btn-primary flex-1">
                                <i class="fa fa-refresh mr-2"></i> é‡è¯•è¿æ¥
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // ç»‘å®šäº‹ä»¶
            document.getElementById('use-local-mode').addEventListener('click', function() {
                // ä¿å­˜é…ç½®ï¼Œç¦ç”¨è¿œç¨‹æœåŠ¡
                const config = {
                    url: '',
                    key: '',
                    enabled: false
                };
                localStorage.setItem('supabaseConfig', JSON.stringify(config));
                
                // é‡æ–°åŠ è½½é¡µé¢
                window.location.href = 'index.html?mode=local';
            });
            
            document.getElementById('retry-connection').addEventListener('click', function() {
                // é‡æ–°åŠ è½½é¡µé¢
                window.location.reload();
            });
        }
        
        // ç¡®ä¿createFetchBasedSupabaseClientå‡½æ•°åœ¨å…¨å±€ä½œç”¨åŸŸå¯ç”¨
        window.createFetchBasedSupabaseClient = createFetchBasedSupabaseClient;
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ–Marco Poloç®¡ç†ç³»ç»Ÿ...');
            
            try {
                // æ£€æŸ¥ç½‘ç»œè¿æ¥
                const isConnected = await checkNetworkConnection();
                
                if (!isConnected) {
                    console.warn('ğŸŒ ç½‘ç»œè¿æ¥ä¸å¯ç”¨ï¼Œæ˜¾ç¤ºé”™è¯¯é¡µé¢');
                    showErrorPage('æ— æ³•è¿æ¥åˆ°è¿œç¨‹æœåŠ¡ï¼Œè¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥æˆ–æœåŠ¡é…ç½®ã€‚');
                    return;
                }
                
                console.log('âœ… ç½‘ç»œè¿æ¥æ­£å¸¸ï¼Œç»§ç»­åˆå§‹åŒ–');
            // å®¢æˆ·ç«¯å°†åœ¨éœ€è¦æ—¶åŠ¨æ€åˆå§‹åŒ–
        });
    </script>
    
    <!-- Tailwind é…ç½® -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e40af',
                        secondary: '#64748b',
                        success: '#059669',
                        warning: '#d97706',
                        danger: '#dc2626',
                        light: '#f3f4f6',
                        dark: '#1f2937',
                        'light-1': '#f9fafb',
                        'light-2': '#e5e7eb',
                        'dark-1': '#374151',
                        'dark-2': '#4b5563',
                        'dark-3': '#6b7280'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    },
                    boxShadow: {
                        card: '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)'
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .transition-all-300 {
                transition: all 0.3s ease;
            }
            .page-transition {
                transition: opacity 0.3s ease, transform 0.3s ease;
            }
            .page-transition.hidden {
                opacity: 0;
                transform: translateX(10px);
            }
            .bg-grid {
                background-size: 20px 20px;
                background-image: 
                    linear-gradient(to right, #e5e7eb 1px, transparent 1px),
                    linear-gradient(to bottom, #e5e7eb 1px, transparent 1px);
            }
            .badge {
                @apply inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium;
            }
            .badge-primary {
                @apply bg-primary/10 text-primary;
            }
            .badge-secondary {
                @apply bg-secondary/10 text-secondary;
            }
            .badge-success {
                @apply bg-success/10 text-success;
            }
            .badge-warning {
                @apply bg-warning/10 text-warning;
            }
            .badge-danger {
                @apply bg-danger/10 text-danger;
            }
            .btn {
                @apply inline-flex items-center justify-center px-4 py-2 rounded-md font-medium transition-all-300 focus:outline-none focus:ring-2 focus:ring-offset-2;
            }
            .btn-primary {
                @apply bg-primary text-white hover:bg-primary/90 focus:ring-primary/50;
            }
            .btn-secondary {
                @apply bg-light-2 text-dark-2 hover:bg-light-2/80 focus:ring-dark-2/30;
            }
            .btn-success {
                @apply bg-success text-white hover:bg-success/90 focus:ring-success/50;
            }
            .btn-warning {
                @apply bg-warning text-white hover:bg-warning/90 focus:ring-warning/50;
            }
            .btn-danger {
                @apply bg-danger text-white hover:bg-danger/90 focus:ring-danger/50;
            }
            .input-field {
                @apply w-full px-3 py-2 border border-light-2 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all-300;
            }
            .form-label {
                @apply block text-sm font-medium text-dark-2 mb-1;
            }
            .form-group {
                @apply mb-4;
            }
            .tab {
                @apply px-4 py-2 text-sm font-medium rounded-md transition-all-300;
            }
            .tab:not(.active) {
                @apply text-dark-3 hover:text-dark-1 hover:bg-light-1;
            }
            .tab.active {
                @apply bg-primary text-white;
            }
            .loading-spinner {
                @apply w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin;
            }
        }
    </style>
    
    <!-- æ·±è‰²æ¨¡å¼å’Œä¸»é¢˜é¢œè‰²æ ·å¼ -->
    <style>
        /* æ·±è‰²æ¨¡å¼æ ·å¼ */
        .dark-mode {
            background-color: #374151;
            color: #f9fafb;
        }
        .dark-mode .bg-white {
            background-color: #4b5563;
        }
        .dark-mode .text-dark {
            color: #f9fafb;
        }
        .dark-mode .text-dark-1 {
            color: #f3f4f6;
        }
        .dark-mode .text-dark-2 {
            color: #e5e7eb;
        }
        .dark-mode .text-dark-3 {
            color: rgba(229, 231, 235, 0.7);
        }
        .dark-mode .bg-light-1 {
            background-color: #6b7280;
        }
        .dark-mode .bg-light-2 {
            background-color: #4b5563;
        }
        .dark-mode .border-light-2 {
            border-color: #6b7280;
        }
        .dark-mode .btn-secondary {
            background-color: #6b7280;
            color: #e5e7eb;
        }
        .dark-mode .btn-secondary:hover {
            background-color: rgba(107, 114, 128, 0.8);
        }
        .dark-mode .input-field {
            background-color: #4b5563;
            border-color: #6b7280;
            color: #f9fafb;
        }
        .dark-mode .tab:not(.active) {
            color: rgba(229, 231, 235, 0.7);
        }
        .dark-mode .tab:not(.active):hover {
            color: #f9fafb;
            background-color: #6b7280;
        }
        
        /* ä¸»é¢˜é¢œè‰²æ ·å¼ - ä½¿ç”¨CSSå˜é‡ */
        :root {
            --color-primary: #1e40af;
            --color-primary-light: #3b82f6;
            --color-primary-dark: #1e3a8a;
        }
        
        .theme-primary {
            --color-primary: #1e40af;
            --color-primary-light: #3b82f6;
            --color-primary-dark: #1e3a8a;
        }
        
        .theme-secondary {
            --color-primary: #64748b;
            --color-primary-light: #94a3b8;
            --color-primary-dark: #475569;
        }
        
        .theme-success {
            --color-primary: #059669;
            --color-primary-light: #10b981;
            --color-primary-dark: #047857;
        }
        
        .theme-warning {
            --color-primary: #d97706;
            --color-primary-light: #f59e0b;
            --color-primary-dark: #b45309;
        }
        
        .theme-danger {
            --color-primary: #dc2626;
            --color-primary-light: #ef4444;
            --color-primary-dark: #b91c1c;
        }
        
        /* åº”ç”¨ä¸»é¢˜é¢œè‰² */
        .btn-primary,
        .tab.active,
        .bg-primary {
            background-color: var(--color-primary) !important;
        }
        
        .text-primary,
        .badge-primary {
            color: var(--color-primary) !important;
        }
        
        .focus\:ring-primary\/50:focus {
            box-shadow: 0 0 0 2px rgba(30, 64, 175, 0.5) !important;
        }
        
        .focus\:border-primary:focus {
            border-color: var(--color-primary) !important;
        }
    </style>
</head>
<body class="bg-light min-h-screen">
    <!-- ç™»å½•é¡µé¢ -->
    <div id="login-page" class="bg-gradient-to-br from-primary/5 to-primary/10 flex items-center justify-center min-h-screen p-4">
        <div class="bg-transparent backdrop-blur-xl rounded-lg shadow-lg p-8 w-full max-w-md border border-white/10">
            <div class="text-center mb-8">
                <h1 class="text-2xl font-bold text-dark">Marco Polo ç®¡ç†ç³»ç»Ÿ</h1>
                <p class="text-dark-3 mt-2">é«˜æ•ˆç®¡ç†æ‚¨çš„ç“·ç –ä¸šåŠ¡</p>
            </div>
            
            <div id="login-form" class="space-y-6">
                <div>
                    <label for="username" class="form-label">ç”¨æˆ·å</label>
                    <input type="text" id="username" class="input-field" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                </div>
                
                <div>
                    <label for="password" class="form-label">å¯†ç </label>
                    <input type="password" id="password" class="input-field" placeholder="è¯·è¾“å…¥å¯†ç ">
                </div>
                
                <div>
                    <button type="button" id="login-button" class="w-full btn-primary flex justify-center items-center">
                        <span>ç™»å½•</span>
                    </button>
                </div>
                
                <div class="text-center text-sm text-dark-3 mt-4">
                    <p>
</p>
                </div>
            </div>
            
            <div id="login-error" class="mt-4 text-danger text-sm hidden">
                <span>ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•</span>
            </div>
        </div>
    </div>

    <!-- ä¸»åº”ç”¨ -->
    <div id="app" class="hidden">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <header class="bg-white/10 backdrop-blur-xl shadow-sm relative">
            <div class="container mx-auto px-4 py-3">
                <!-- ç§»åŠ¨ç«¯èœå•æŒ‰é’® -->
                <button id="mobile-menu-toggle" class="md:hidden absolute top-4 left-4 z-30 text-dark-3 hover:text-dark">
                    <i class="fa fa-bars text-xl"></i>
                </button>

                
                <!-- æ ‡é¢˜ - å±…ä¸­æ˜¾ç¤ºï¼ˆç§»åŠ¨ç«¯å·¦ç§»ï¼‰ -->
                <div class="absolute top-4 left-1/2 transform -translate-x-1/2 md:left-1/2 md:transform md:-translate-x-1/2 z-20">
                    <h1 class="text-xl font-bold text-dark" style="font-size: 18px;">Marco Polo ç®¡ç†ç³»ç»Ÿ</h1>
                </div>
                
                <div class="flex flex-col items-center pt-16">
                    
                    <!-- å¯¼èˆªèœå• - å“åº”å¼å¸ƒå±€ -->
                    <nav id="main-nav" class="flex flex-wrap items-center space-x-1 justify-start w-full md:flex-row md:flex-wrap hidden md:flex">
                        <a href="#" class="nav-item flex items-center px-4 py-2 rounded-md text-dark-1 hover:bg-light-1" data-page="products-page">
                            <i class="fa fa-cubes w-5 text-center mr-2"></i>
                            <span>äº§å“ç®¡ç†</span>
                        </a>
                        <a href="#" class="nav-item flex items-center px-4 py-2 rounded-md text-dark-1 hover:bg-light-1" data-page="calculator-page">
                            <i class="fa fa-calculator w-5 text-center mr-2"></i>
                            <span>ç®—ç –è®¡ç®—å™¨</span>
                        </a>
                        <a href="#" class="nav-item flex items-center px-4 py-2 rounded-md text-dark-1 hover:bg-light-1" data-page="users-page">
                            <i class="fa fa-users w-5 text-center mr-2"></i>
                            <span>ç”¨æˆ·ç®¡ç†</span>
                        </a>
                        <a href="#" class="nav-item flex items-center px-4 py-2 rounded-md text-dark-1 hover:bg-light-1" data-page="logs-page">
                            <i class="fa fa-history w-5 text-center mr-2"></i>
                            <span>æ“ä½œæ—¥å¿—</span>
                        </a>
                        <a href="#" class="nav-item flex items-center px-4 py-2 rounded-md text-dark-1 hover:bg-light-1" data-page="settings-page">
                            <i class="fa fa-cog w-5 text-center mr-2"></i>
                            <span>ç³»ç»Ÿè®¾ç½®</span>
                        </a>
                        <!-- ç”¨æˆ·ä¿¡æ¯ - ç§»åˆ°ç³»ç»Ÿè®¾ç½®åé¢ -->
                        <div class="relative ml-4">
                            <button id="user-menu-btn" class="flex items-center space-x-2 text-dark-3 hover:text-dark">
                                <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center text-primary">
                                    <i class="fa fa-user"></i>
                                </div>
                                <span id="current-username" class="hidden sm:inline">ç³»ç»Ÿç®¡ç†å‘˜</span>
                                <i class="fa fa-chevron-down text-xs"></i>
                            </button>
                            
                            <div id="user-menu" class="absolute right-0 mt-2 w-48 bg-white/10 backdrop-blur-xl rounded-md shadow-lg py-1 hidden z-10">
                                <a href="#" class="block px-4 py-2 text-sm text-dark-2 hover:bg-light-1" id="logout-btn">
                                    <i class="fa fa-sign-out mr-2"></i> é€€å‡ºç™»å½•
                                </a>
                            </div>
                        </div>
                    </nav>
                    
                    <!-- ç§»åŠ¨ç«¯ä¸‹æ‹‰èœå• -->
                    <div id="mobile-nav" class="md:hidden w-full bg-white/10 backdrop-blur-xl rounded-md shadow-md mt-2 hidden">
                        <div class="p-2 flex flex-col space-y-1">
                            <a href="#" class="nav-item flex items-center px-4 py-2 rounded-md text-dark-1 hover:bg-light-1" data-page="products-page">
                                <i class="fa fa-cubes w-5 text-center mr-2"></i>
                                <span>äº§å“ç®¡ç†</span>
                            </a>
                            <a href="#" class="nav-item flex items-center px-4 py-2 rounded-md text-dark-1 hover:bg-light-1" data-page="calculator-page">
                                <i class="fa fa-calculator w-5 text-center mr-2"></i>
                                <span>ç®—ç –è®¡ç®—å™¨</span>
                            </a>
                            <a href="#" class="nav-item flex items-center px-4 py-2 rounded-md text-dark-1 hover:bg-light-1" data-page="users-page">
                                <i class="fa fa-users w-5 text-center mr-2"></i>
                                <span>ç”¨æˆ·ç®¡ç†</span>
                            </a>
                            <a href="#" class="nav-item flex items-center px-4 py-2 rounded-md text-dark-1 hover:bg-light-1" data-page="logs-page">
                                <i class="fa fa-history w-5 text-center mr-2"></i>
                                <span>æ“ä½œæ—¥å¿—</span>
                            </a>
                            <a href="#" class="nav-item flex items-center px-4 py-2 rounded-md text-dark-1 hover:bg-light-1" data-page="settings-page">
                                <i class="fa fa-cog w-5 text-center mr-2"></i>
                                <span>ç³»ç»Ÿè®¾ç½®</span>
                            </a>
                            <!-- ç§»åŠ¨ç«¯ç”¨æˆ·ä¿¡æ¯ -->
                            <div class="relative mt-2 pt-2 border-t border-light-2">
                                <button id="mobile-user-menu-btn" class="flex items-center space-x-2 text-dark-3 hover:text-dark w-full justify-start px-4 py-2 rounded-md hover:bg-light-1">
                                    <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center text-primary">
                                        <i class="fa fa-user"></i>
                                    </div>
                                    <span id="mobile-current-username" class="hidden sm:inline">ç³»ç»Ÿç®¡ç†å‘˜</span>
                                    <i class="fa fa-chevron-down text-xs ml-auto"></i>
                                </button>
                                
                                <div id="mobile-user-menu" class="absolute left-0 right-0 mt-1 w-full bg-white/10 backdrop-blur-xl rounded-md shadow-lg py-1 hidden z-10">
                                    <a href="#" class="block px-4 py-2 text-sm text-dark-2 hover:bg-light-1" id="mobile-logout-btn">
                                        <i class="fa fa-sign-out mr-2"></i> é€€å‡ºç™»å½•
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>
            
            <!-- ä¸»å†…å®¹åŒº -->
            <main class="flex-1 p-4 sm:p-6 transition-all duration-300">
                <div class="container mx-auto">
                    <!-- äº§å“ç®¡ç†é¡µé¢ -->
                    <div id="products-page" class="page-transition hidden">
                        <div class="mb-6 flex flex-wrap justify-between items-center gap-4">
                            <div>
                                <h2 class="text-2xl font-bold text-dark">äº§å“ç®¡ç†</h2>
                                <p class="text-dark-3 mt-1">ç®¡ç†æ‚¨çš„ç“·ç –äº§å“</p>
                            </div>
                            
                            <div class="flex flex-wrap gap-3">
                                <div class="relative">
                                    <input type="text" id="product-search" class="input-field pl-10" placeholder="æœç´¢äº§å“...">

                                </div>
                                
                                <button id="add-product-btn" class="btn-primary">
                                    <i class="fa fa-plus mr-2"></i> æ·»åŠ äº§å“
                                </button>
                            </div>
                        </div>
                        
                        <!-- äº§å“åˆ—è¡¨ -->
                        <div id="products-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- äº§å“å¡ç‰‡å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                        
                        <!-- æ— äº§å“æç¤º -->
                        <div id="no-products" class="text-center py-12 bg-white rounded-lg shadow-sm hidden">
                            <div class="text-6xl text-light-2 mb-4">
                                <i class="fa fa-cubes"></i>
                            </div>
                            <h3 class="text-xl font-medium text-dark-2 mb-2">æš‚æ— äº§å“</h3>
                            <p class="text-dark-3 mb-6">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ æ‚¨çš„ç¬¬ä¸€ä¸ªäº§å“</p>
                            <button id="add-first-product" class="btn-primary">
                                <i class="fa fa-plus mr-2"></i> æ·»åŠ äº§å“
                            </button>
                        </div>
                    </div>
                    
                    <!-- ç®—ç –è®¡ç®—å™¨é¡µé¢ -->
                    <div id="calculator-page" class="page-transition hidden">
                        <div class="mb-6">
                            <h2 class="text-2xl font-bold text-dark">ç“·ç –è®¡ç®—å™¨</h2>
                            <p class="text-dark-3 mt-1">å¿«é€Ÿè®¡ç®—æ‰€éœ€ç“·ç –æ•°é‡</p>
                        </div>
                        
                        <!-- è®¡ç®—å‚æ•°åŒºåŸŸ -->
                        <div class="bg-white rounded-lg shadow-sm p-4 sm:p-6 mb-4 sm:mb-6">
                            <h2 class="text-xl font-bold text-gray-800 mb-4">è®¡ç®—å‚æ•°</h2>
                            

                            
                            <!-- å¢™é¢å°ºå¯¸è¾“å…¥ -->
                            <div id="brick-wall-dimensions">
                                <h3 class="text-base sm:text-lg font-medium text-gray-800 mb-3">å¹³é¢å°ºå¯¸ (mm)</h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4 mb-4 sm:mb-6">
                                    <div>
                                        <label for="brick-wall-width" class="block text-sm font-medium text-gray-700 mb-1">å¹³é¢å®½åº¦</label>
                                        <input type="number" id="brick-wall-width" placeholder="è¯·è¾“å…¥å®½åº¦" value="5000" min="1" class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                                    </div>
                                    
                                    <div>
                                        <label for="brick-wall-height" class="block text-sm font-medium text-gray-700 mb-1">å¹³é¢é«˜åº¦</label>
                                        <input type="number" id="brick-wall-height" placeholder="è¯·è¾“å…¥é«˜åº¦" value="3000" min="1" class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- æŸ±å­å°ºå¯¸è¾“å…¥ -->
                            <div id="brick-column-dimensions" class="hidden">
                                <h3 class="text-lg font-medium text-gray-800 mb-3">æŸ±å­å°ºå¯¸ (mm)</h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4 mb-4 sm:mb-6">
                                    <div>
                                        <label for="brick-column-width" class="block text-sm font-medium text-gray-700 mb-1">æŸ±å­è¾¹é•¿</label>
                                        <input type="number" id="brick-column-width" placeholder="è¯·è¾“å…¥æŸ±å­è¾¹é•¿" value="600" min="1" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    
                                    <div>
                                        <label for="brick-column-height" class="block text-sm font-medium text-gray-700 mb-1">æŸ±å­é«˜åº¦</label>
                                        <input type="number" id="brick-column-height" placeholder="è¯·è¾“å…¥æŸ±å­é«˜åº¦" value="3000" min="1" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- æ¥¼æ¢¯å°ºå¯¸è¾“å…¥ -->
                            <div id="brick-stair-dimensions" class="hidden">
                                <h3 class="text-lg font-medium text-gray-800 mb-3">æ¥¼æ¢¯å°ºå¯¸ (mm)</h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4 mb-4 sm:mb-6">
                                    <div>
                                        <label for="brick-stair-length" class="block text-sm font-medium text-gray-700 mb-1">æ¥¼æ¢¯é•¿åº¦</label>
                                        <input type="number" id="brick-stair-length" placeholder="è¯·è¾“å…¥æ¥¼æ¢¯é•¿åº¦" value="4000" min="1" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    
                                    <div>
                                        <label for="brick-stair-width" class="block text-sm font-medium text-gray-700 mb-1">æ¥¼æ¢¯å®½åº¦</label>
                                        <input type="number" id="brick-stair-width" placeholder="è¯·è¾“å…¥æ¥¼æ¢¯å®½åº¦" value="1200" min="1" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ç –å—å°ºå¯¸è¾“å…¥ -->
                            <h3 class="text-lg font-medium text-gray-800 mb-3">ç –å—å°ºå¯¸ (mm)</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <div>
                                    <label for="brick-brick-length" class="block text-sm font-medium text-gray-700 mb-1">ç –å—é•¿åº¦</label>
                                    <input type="number" id="brick-brick-length" placeholder="è¯·è¾“å…¥ç –å—é•¿åº¦" value="1200" min="1" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <div>
                                    <label for="brick-brick-width" class="block text-sm font-medium text-gray-700 mb-1">ç –å—å®½åº¦</label>
                                    <input type="number" id="brick-brick-width" placeholder="è¯·è¾“å…¥ç –å—å®½åº¦" value="600" min="1" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            
                            <button id="brick-calculate-btn" class="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-200 flex items-center justify-center">
                                <i class="fa fa-calculator mr-2"></i> å¼€å§‹è®¡ç®—
                            </button>
                        </div>
                        
                        <!-- å¹³é¢å›¾æ˜¾ç¤ºåŒºåŸŸ -->
                        <div class="bg-white rounded-lg shadow-sm p-4 sm:p-6 mb-4 sm:mb-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold text-gray-800">ç –å—æ’åˆ—å¹³é¢å›¾</h2>
                            </div>
                            
                            <!-- å¹³é¢å›¾å®¹å™¨ -->
                            <div id="brick-planar-container" class="relative overflow-auto border border-gray-200 rounded-lg bg-white" style="height: 280px; max-height: 50vh;"></div>
                            
                            <!-- å›¾ä¾‹ -->
                            <div class="mt-3 sm:mt-4 flex flex-wrap gap-3 sm:gap-6 text-xs sm:text-sm">
                                <div class="flex items-center">
                                    <div class="w-4 h-4 bg-yellow-100 border border-yellow-300 mr-2"></div>
                                    <span class="text-gray-600">æ•´ç –</span>
                                </div>
                                <div class="flex items-center">
                                    <div class="w-4 h-4 bg-blue-100 border border-blue-300 mr-2"></div>
                                    <span class="text-gray-600">å®½åº¦å‰©ä½™åŒºåŸŸ</span>
                                </div>
                                <div class="flex items-center">
                                    <div class="w-4 h-4 bg-green-100 border border-green-300 mr-2"></div>
                                    <span class="text-gray-600">é«˜åº¦å‰©ä½™åŒºåŸŸ</span>
                                </div>
                                <div class="flex items-center">
                                    <div class="w-4 h-4 bg-purple-100 border border-purple-300 mr-2"></div>
                                    <span class="text-gray-600">è§’è½åŒºåŸŸ</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- è®¡ç®—ç»“æœåŒºåŸŸ -->
                        <div class="bg-white rounded-lg shadow-sm p-4 sm:p-6 mb-4 sm:mb-6">
                            <h2 class="text-xl font-bold text-gray-800 mb-4">è®¡ç®—ç»“æœ</h2>
                            
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4 mb-4 sm:mb-6">
                                <div class="bg-gray-50 rounded-lg p-4 text-center">
                                    <div class="text-gray-500 text-sm mb-1">æ•´ç –åŒºåŸŸ</div>
                                    <div class="text-xl sm:text-2xl font-bold text-gray-800" id="brick-whole-bricks">16</div>
                                    <div class="text-xs text-gray-500" id="brick-whole-bricks-detail"></div>
                                </div>
                                
                                <div class="bg-blue-50 rounded-lg p-4 text-center">
                                    <div class="text-blue-500 text-sm mb-1">å®½åº¦å‰©ä½™åŒºåŸŸ</div>
                                    <div class="text-xl sm:text-2xl font-bold text-blue-600" id="brick-width-remaining-bricks">3</div>
                                    <div class="text-xs text-blue-500" id="brick-width-remaining-detail"></div>
                                </div>
                                
                                <div class="bg-green-50 rounded-lg p-4 text-center">
                                    <div class="text-green-500 text-sm mb-1">é«˜åº¦å‰©ä½™åŒºåŸŸ</div>
                                    <div class="text-xl sm:text-2xl font-bold text-green-600" id="brick-height-remaining-bricks">9</div>
                                    <div class="text-xs text-green-500" id="brick-height-remaining-detail"></div>
                                </div>
                                
                                <div class="bg-blue-100 rounded-lg p-4 text-center">
                                    <div class="text-blue-700 text-sm mb-1">æ€»ç”¨ç –é‡</div>
                                    <div class="text-xl sm:text-2xl font-bold text-blue-800" id="brick-total-bricks">27</div>
                                    <div class="text-xs text-blue-700" id="brick-total-bricks-detail"></div>
                                </div>
                            </div>
                            
                            <!-- è®¡ç®—æ­¥éª¤ -->
                            <div class="border-t border-gray-200 pt-4">
                                <h3 class="text-lg font-medium text-gray-800 mb-3">è®¡ç®—è¿‡ç¨‹</h3>
                                <div id="brick-calculation-steps" class="text-sm text-gray-600 space-y-2">
                                    <p>è¯·ç‚¹å‡»"å¼€å§‹è®¡ç®—"æŒ‰é’®è¿›è¡Œè®¡ç®—</p>
                                </div>
                            </div>
                        </div>
                        </div>
                        

                        

                    </div>
                    
                    <!-- ç”¨æˆ·ç®¡ç†é¡µé¢ -->
                    <div id="users-page" class="page-transition hidden">
                        <div class="mb-6 flex flex-wrap justify-between items-center gap-4">
                            <div>
                                <h2 class="text-2xl font-bold text-dark">ç”¨æˆ·ç®¡ç†</h2>
                                <p class="text-dark-3 mt-1">ç®¡ç†ç³»ç»Ÿç”¨æˆ·</p>
                            </div>
                            
                            <div>
                                <button id="add-user-btn" class="btn-primary">
                                    <i class="fa fa-plus mr-2"></i> æ·»åŠ ç”¨æˆ·
                                </button>
                            </div>
                        </div>
                        
                        <!-- ç”¨æˆ·åˆ—è¡¨ -->
                        <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-light-2">
                                    <thead>
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-dark-3 uppercase tracking-wider">ç”¨æˆ·å</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-dark-3 uppercase tracking-wider">å§“å</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-dark-3 uppercase tracking-wider">ç±»å‹</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-dark-3 uppercase tracking-wider">çŠ¶æ€</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-dark-3 uppercase tracking-wider">åˆ›å»ºæ—¶é—´</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-dark-3 uppercase tracking-wider">æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="users-list" class="bg-white divide-y divide-light-2">
                                        <!-- ç”¨æˆ·åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <div id="no-users" class="text-center py-12 text-dark-3">
                                <i class="fa fa-users text-4xl mb-3"></i>
                                <p>æš‚æ— ç”¨æˆ·</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ“ä½œæ—¥å¿—é¡µé¢ -->
                    <div id="logs-page" class="page-transition hidden">
                        <div class="mb-6">
                            <h2 class="text-2xl font-bold text-dark">æ“ä½œæ—¥å¿—</h2>
                            <p class="text-dark-3 mt-1">æŸ¥çœ‹ç³»ç»Ÿæ“ä½œè®°å½•</p>
                        </div>
                        
                        <!-- æ—¥å¿—ç­›é€‰ -->
                        <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
                            <div class="flex flex-wrap gap-3">
                                <div class="relative">
                                    <select id="log-filter" class="input-field appearance-none bg-transparent pr-8" style="
                                        -webkit-appearance: none;
                                        -moz-appearance: none;
                                        appearance: none;
                                        background-image: none;
                                        cursor: default;
                                    ">
                                        <option value="all">å…¨éƒ¨æ“ä½œ</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ—¥å¿—åˆ—è¡¨ -->
                        <div class="bg-white rounded-lg shadow-sm overflow-hidden relative">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-light-2">
                                    <thead>
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-dark-3 uppercase tracking-wider">æ“ä½œç±»å‹</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-dark-3 uppercase tracking-wider">æ“ä½œå†…å®¹</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-dark-3 uppercase tracking-wider">æ“ä½œäºº</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-dark-3 uppercase tracking-wider">æ“ä½œæ—¶é—´</th>
                                        </tr>
                                    </thead>
                                    <tbody id="logs-list" class="bg-white divide-y divide-light-2">
                                        <!-- æ—¥å¿—åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <div id="no-logs" class="text-center py-12 text-dark-3">
                                <i class="fa fa-history text-4xl mb-3"></i>
                                <p>æš‚æ— æ“ä½œæ—¥å¿—</p>
                            </div>
                            

                        </div>
                    </div>
                    
                    <!-- ç³»ç»Ÿè®¾ç½®é¡µé¢ -->
                    <div id="settings-page" class="page-transition hidden">
                        <div class="mb-6">
                            <h2 class="text-2xl font-bold text-dark">ç³»ç»Ÿè®¾ç½®</h2>
                            <p class="text-dark-3 mt-1">è‡ªå®šä¹‰ç³»ç»Ÿå¤–è§‚å’Œé…ç½®</p>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow-card p-6 mb-6">
                            <div class="flex flex-wrap gap-2 mb-6">
                                <button class="tab active" data-settings="appearance">å¤–è§‚è®¾ç½®</button>
                                <button class="tab" data-settings="data">æ•°æ®ç®¡ç†</button>
                            </div>
                            
                            <div id="settings-container">
                                <!-- å¤–è§‚è®¾ç½® -->
                                <div id="appearance-settings" class="settings-panel">
                                    <div class="form-group">
                                        <label class="form-label">èƒŒæ™¯è®¾ç½®</label>
                                        <div class="mt-2">
                                            <div class="flex flex-wrap gap-4">
                                                <div class="w-20 h-20 rounded-md overflow-hidden border-2 border-transparent hover:border-primary/50 cursor-pointer bg-light-1 flex items-center justify-center">
                                                    <label class="cursor-pointer flex flex-col items-center justify-center w-full h-full">
                                                        <span class="text-dark-3 text-xl mb-1">+</span>
                                                        <span class="text-xs text-dark-3">è‡ªå®šä¹‰</span>
                                                        <input type="file" class="hidden" accept="image/*">
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label" for="theme-color">ä¸»é¢˜é¢œè‰²</label>
                                        <div class="flex flex-wrap gap-3 mt-2">
                                            <div class="w-8 h-8 rounded-full bg-primary border-2 border-white shadow-sm cursor-pointer"></div>
                                            <div class="w-8 h-8 rounded-full bg-secondary border-2 border-transparent hover:border-primary/50 cursor-pointer"></div>
                                            <div class="w-8 h-8 rounded-full bg-success border-2 border-transparent hover:border-primary/50 cursor-pointer"></div>
                                            <div class="w-8 h-8 rounded-full bg-warning border-2 border-transparent hover:border-primary/50 cursor-pointer"></div>
                                            <div class="w-8 h-8 rounded-full bg-danger border-2 border-transparent hover:border-primary/50 cursor-pointer"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">æ˜¾ç¤ºè®¾ç½®</label>
                                        <div class="flex items-center mt-2">
                                            <input type="checkbox" id="dark-mode" class="h-4 w-4 text-primary focus:ring-primary border-light-2 rounded">
                                            <label for="dark-mode" class="ml-2 block text-sm text-dark-2">å¯ç”¨æ·±è‰²æ¨¡å¼</label>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-6 flex justify-end">
                                        <button id="reset-settings" class="btn-secondary mr-3">
                                            <span>æ¢å¤é»˜è®¤</span>
                                        </button>
                                        
                                        <button id="save-settings" class="btn-primary">
                                            <span>ä¿å­˜è®¾ç½®</span>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- æ•°æ®ç®¡ç† -->
                                <div id="data-settings" class="settings-panel hidden">

                                    
                                    <div class="bg-light-1 rounded-lg p-4 mb-6">
                                        <h4 class="font-medium text-dark mb-2">Supabaseè¿æ¥é…ç½®</h4>
                                        <p class="text-sm text-dark-3 mb-4">é…ç½®Supabaseäº‘å­˜å‚¨è¿æ¥ï¼Œå®ç°æ•°æ®åŒæ­¥</p>
                                        
                                        <div id="supabase-config" class="space-y-4">
                                            <div class="form-group">
                                                <label class="form-label" for="supabase-url">Supabase URL</label>
                                                <input type="text" id="supabase-url" class="input-field" placeholder="https://your-project.supabase.co" value="https://kdtepufnlqkpkxijmwdr.supabase.co">
                                            </div>
                                            
                                            <div class="form-group">
                                                <label class="form-label" for="supabase-key">Supabase API Key</label>
                                                <input type="password" id="supabase-key" class="input-field" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtkdGVwdWZubHFrcGt4aWptd2RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4OTg2OTgsImV4cCI6MjA3OTQ3NDY5OH0.UWHS54Vf-9Ek3ET05UzuINb6Q0A2okj1YcpTYqRyq8c">
                                            </div>
                                            
                                            <div class="flex items-center">
                                                <input type="checkbox" id="use-supabase" class="h-4 w-4 text-primary focus:ring-primary border-light-2 rounded">
                                                <label for="use-supabase" class="ml-2 block text-sm text-dark-2">å¯ç”¨Supabaseäº‘å­˜å‚¨</label>
                                            </div>
                                            
                                            <div class="flex flex-wrap gap-3">
                                                <button id="test-supabase" class="btn-secondary flex-1">
                                                    <i class="fa fa-check-circle mr-2"></i> æµ‹è¯•è¿æ¥
                                                </button>
                                                
                                                <button id="save-supabase" class="btn-primary flex-1">
                                                    <i class="fa fa-save mr-2"></i> ä¿å­˜é…ç½®
                                                </button>
                                            </div>
                                            
                                            <div class="mt-3">
                                                <button id="advanced-supabase-test" class="text-primary hover:text-primary/80 text-sm flex items-center">
                                                    <i class="fa fa-diagnoses mr-1"></i> é«˜çº§è¯Šæ–­æµ‹è¯•
                                                </button>
                                            </div>
                                            
                                            <div id="supabase-status" class="text-sm mt-2 hidden"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="bg-light-1 rounded-lg p-4 mb-6">
                                        <h4 class="font-medium text-dark mb-2">äº§å“æ•°æ®ç®¡ç†</h4>
                                        <p class="text-sm text-dark-3 mb-4">å¯¼å…¥æˆ–å¯¼å‡ºäº§å“æ•°æ®</p>
                                        
                                        <div class="flex flex-wrap gap-3 mb-4">
                                            <button id="export-products" class="btn-secondary flex-1">
                                                <i class="fa fa-download mr-2"></i> å¯¼å‡ºäº§å“æ•°æ®
                                            </button>
                                            
                                            <label for="import-products" class="btn-secondary flex-1 cursor-pointer">
                                                <i class="fa fa-upload mr-2"></i> å¯¼å…¥äº§å“æ•°æ®
                                                <input type="file" id="import-products" class="hidden" accept=".json">
                                            </label>
                                        </div>
                                        
                                        <div class="flex flex-wrap gap-3 mb-4">
                                            <button id="export-products-csv" class="btn-secondary flex-1">
                                                <i class="fa fa-file-text-o mr-2"></i> å¯¼å‡ºCSVæ ¼å¼
                                            </button>
                                            
                                            <label for="import-products-csv" class="btn-secondary flex-1 cursor-pointer">
                                                <i class="fa fa-file-text-o mr-2"></i> å¯¼å…¥CSVæ ¼å¼
                                                <input type="file" id="import-products-csv" class="hidden" accept=".csv">
                                            </label>
                                        </div>
                                        
                                        <div class="mt-4">
                                            <button id="clear-products" class="btn-danger w-full">
                                                <i class="fa fa-trash mr-2"></i> æ¸…é™¤æ‰€æœ‰äº§å“æ•°æ®
                                            </button>
                                        </div>
                                    </div>
                                    

                                    

                                    

                                    
                                    <div class="bg-light-1 rounded-lg p-4 mb-6">
                                        <h4 class="font-medium text-dark mb-2">æ“ä½œæ—¥å¿—ç®¡ç†</h4>
                                        <p class="text-sm text-dark-3 mb-4">ç®¡ç†ç³»ç»Ÿæ“ä½œæ—¥å¿—</p>
                                        
                                        <div class="form-group mb-4">
                                            <label class="form-label" for="log-type-filter">æ“ä½œç±»å‹</label>
                                            <select id="log-type-filter" class="input-field">
                                                <option value="all">å…¨éƒ¨ç±»å‹</option>
                                                <option value="product">äº§å“æ“ä½œ</option>
                                                <option value="user">ç”¨æˆ·æ“ä½œ</option>
                                                <option value="calculation">è®¡ç®—æ“ä½œ</option>
                                                <option value="system">ç³»ç»Ÿæ“ä½œ</option>
                                                <option value="æ¸…é™¤æ•°æ®">æ¸…é™¤æ•°æ®</option>
                                            </select>
                                        </div>
                                        
                                        <div class="flex flex-wrap gap-3 mb-4">
                                            <button id="filter-logs" class="btn-secondary flex-1">
                                                <i class="fa fa-filter mr-2"></i> ç­›é€‰æ—¥å¿—
                                            </button>
                                            
                                            <button id="export-logs" class="btn-secondary flex-1">
                                                <i class="fa fa-download mr-2"></i> å¯¼å‡ºæ—¥å¿—æ•°æ®
                                            </button>
                                        </div>
                                        
                                        <div class="mt-4">
                                            <button id="clear-logs" class="btn-danger w-full">
                                                <i class="fa fa-trash mr-2"></i> æ¸…é™¤æ‰€æœ‰æ“ä½œæ—¥å¿—
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </main></div>
            
        
    
    
    <!-- æ·»åŠ äº§å“æ¨¡æ€æ¡† -->
    <div id="add-product-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-dark">æ·»åŠ äº§å“</h3>
                <button id="close-product-modal" class="text-dark-3 hover:text-dark transition-colors">
                    <span class="text-xl">Ã—</span>
                </button>
            </div>
            
            <div id="add-product-form" class="space-y-4">
                <div class="grid grid-cols-1 gap-4">
                    <div class="form-group">
                        <label class="form-label" for="product-name">äº§å“åç§° <span class="text-danger">*</span></label>
                        <input type="text" id="product-name" name="name" class="input-field" placeholder="è¯·è¾“å…¥äº§å“åç§°">
                    </div>
                    

                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label" for="product-price">ä»·æ ¼ <span class="text-danger">*</span></label>
                            <input type="number" id="product-price" name="price" class="input-field" placeholder="0.00" min="0" step="0.01">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="product-model">å‹å· <span class="text-danger">*</span></label>
                            <input type="text" id="product-model" name="model" class="input-field" placeholder="å‹å·">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="product-category">åˆ†ç±» <span class="text-danger">*</span></label>
                        <select id="product-category" name="category" class="input-field">
                            <option value="">è¯·é€‰æ‹©åˆ†ç±»</option>
                            <option value="tile">ç“·ç –</option>
                            <option value="stone">çŸ³æ</option>
                            <option value="floor">åœ°æ¿</option>
                            <option value="other">å…¶ä»–</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label" for="product-size">å°ºå¯¸ (cm)</label>
                            <input type="text" id="product-size" name="size" class="input-field" placeholder="å¦‚: 60x60">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="product-style">é£æ ¼</label>
                            <input type="text" id="product-style" name="style" class="input-field" placeholder="å¦‚: ç°ä»£">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="product-description">äº§å“æè¿°</label>
                        <textarea id="product-description" name="description" class="input-field" rows="2" placeholder="è¯·è¾“å…¥äº§å“æè¿°"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">äº§å“æ ‡ç­¾</label>
                        <div class="flex flex-wrap gap-2 mt-2">
                            <div class="flex items-center">
                                <input type="checkbox" id="badge-on-sale" name="badges" value="on-sale" class="h-4 w-4 text-primary focus:ring-primary border-light-2 rounded">
                                <label for="badge-on-sale" class="ml-2 block text-sm text-dark-2">åœ¨å”®</label>
                            </div>
                            
                            <div class="flex items-center">
                                <input type="checkbox" id="badge-hot" name="badges" value="hot" class="h-4 w-4 text-primary focus:ring-primary border-light-2 rounded">
                                <label for="badge-hot" class="ml-2 block text-sm text-dark-2">çˆ†æ¬¾</label>
                            </div>
                            
                            <div class="flex items-center">
                                <input type="checkbox" id="badge-bargain" name="badges" value="bargain" class="h-4 w-4 text-primary focus:ring-primary border-light-2 rounded">
                                <label for="badge-bargain" class="ml-2 block text-sm text-dark-2">ç‰¹ä»·</label>
                            </div>
                            
                            <div class="flex items-center">
                                <input type="checkbox" id="badge-new" name="badges" value="new" class="h-4 w-4 text-primary focus:ring-primary border-light-2 rounded">
                                <label for="badge-new" class="ml-2 block text-sm text-dark-2">æ–°å“</label>
                            </div>
                            
                            <div class="flex items-center">
                                <input type="checkbox" id="badge-discontinued" name="badges" value="discontinued" class="h-4 w-4 text-primary focus:ring-primary border-light-2 rounded">
                                <label for="badge-discontinued" class="ml-2 block text-sm text-dark-2">åœå”®</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">äº§å“å›¾ç‰‡</label>
                        <div class="mt-2 grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <!-- å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ -->
                            <div id="product-image-upload" class="border-2 border-dashed border-light-2 rounded-md p-4 flex flex-col items-center justify-center cursor-pointer hover:border-primary/50 transition-colors">
                                <i class="fa fa-cloud-upload text-2xl text-dark-3 mb-2"></i>
                                <span class="text-sm text-dark-3">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</span>
                                <input type="file" id="product-image" name="image" class="hidden" accept="image/*">
                            </div>
                            
                            <!-- å›¾ç‰‡é¢„è§ˆåŒºåŸŸ -->
                            <div id="product-image-preview" class="hidden border-2 border-light-2 rounded-md overflow-hidden relative">
                                <img id="preview-img" src="" alt="é¢„è§ˆå›¾ç‰‡" class="w-full h-full object-cover">
                                <button id="remove-image" type="button" class="absolute top-2 right-2 bg-dark/70 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-danger transition-colors">
                                    <i class="fa fa-times text-xs"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancel-add-product" class="btn-secondary">å–æ¶ˆ</button>
                    <button type="button" id="submit-add-product" class="btn-primary">æ·»åŠ äº§å“</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ç¼–è¾‘äº§å“æ¨¡æ€æ¡† -->
    <div id="edit-product-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
            <div class="flex justify-end items-center mb-6">
                <button id="close-edit-product-modal" class="text-dark-3 hover:text-dark transition-colors">
                    <span class="text-xl">Ã—</span>
                </button>
            </div>
            
            <div id="edit-product-form" class="space-y-4">
                <input type="hidden" id="edit-product-id">
                
                <div class="grid grid-cols-1 gap-4">
                    <div class="form-group">
                        <label class="form-label" for="edit-product-name">äº§å“åç§° <span class="text-danger">*</span></label>
                        <input type="text" id="edit-product-name" name="name" class="input-field" placeholder="è¯·è¾“å…¥äº§å“åç§°">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">äº§å“å›¾ç‰‡</label>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-2">
                            <!-- å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ -->
                            <div id="edit-product-image-upload" class="border-2 border-dashed border-light-3 rounded-md p-4 flex flex-col items-center justify-center cursor-pointer hover:border-primary/50 transition-colors">
                                <i class="fa fa-cloud-upload text-2xl text-dark-3 mb-2"></i>
                                <span class="text-sm text-dark-3">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</span>
                                <input type="file" id="edit-product-image-input" class="hidden" accept="image/*">
                            </div>
                            
                            <!-- å›¾ç‰‡é¢„è§ˆåŒºåŸŸ -->
                            <div id="edit-product-image-preview" class="hidden border-2 border-light-3 rounded-md overflow-hidden relative">
                                <img id="edit-preview-img" src="" alt="äº§å“å›¾ç‰‡é¢„è§ˆ" class="w-full h-full object-cover">
                                <button type="button" id="edit-remove-image" class="absolute top-2 right-2 bg-dark/70 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-danger transition-colors">
                                    <i class="fa fa-times text-xs"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label" for="edit-product-price">ä»·æ ¼ <span class="text-danger">*</span></label>
                            <input type="number" id="edit-product-price" name="price" class="input-field" placeholder="0.00" min="0" step="0.01">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="edit-product-model">å‹å· <span class="text-danger">*</span></label>
                            <input type="text" id="edit-product-model" name="model" class="input-field" placeholder="å‹å·">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="edit-product-category">åˆ†ç±» <span class="text-danger">*</span></label>
                        <select id="edit-product-category" name="category" class="input-field">
                            <option value="">è¯·é€‰æ‹©åˆ†ç±»</option>
                            <option value="tile">ç“·ç –</option>
                            <option value="stone">çŸ³æ</option>
                            <option value="floor">åœ°æ¿</option>
                            <option value="other">å…¶ä»–</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label" for="edit-product-size">å°ºå¯¸ (cm)</label>
                            <input type="text" id="edit-product-size" name="size" class="input-field" placeholder="å¦‚: 60x60">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="edit-product-style">é£æ ¼</label>
                            <input type="text" id="edit-product-style" name="style" class="input-field" placeholder="å¦‚: ç°ä»£">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="edit-product-description">äº§å“æè¿°</label>
                        <textarea id="edit-product-description" name="description" class="input-field" rows="2" placeholder="è¯·è¾“å…¥äº§å“æè¿°"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">äº§å“æ ‡ç­¾</label>
                        <div class="flex flex-wrap gap-2 mt-2">
                            <div class="flex items-center">
                                <input type="checkbox" id="edit-badge-on-sale" name="badges" value="on-sale" class="h-4 w-4 text-primary focus:ring-primary border-light-2 rounded">
                                <label for="edit-badge-on-sale" class="ml-2 block text-sm text-dark-2">åœ¨å”®</label>
                            </div>
                            
                            <div class="flex items-center">
                                <input type="checkbox" id="edit-badge-hot" name="badges" value="hot" class="h-4 w-4 text-primary focus:ring-primary border-light-2 rounded">
                                <label for="edit-badge-hot" class="ml-2 block text-sm text-dark-2">çˆ†æ¬¾</label>
                            </div>
                            
                            <div class="flex items-center">
                                <input type="checkbox" id="edit-badge-bargain" name="badges" value="bargain" class="h-4 w-4 text-primary focus:ring-primary border-light-2 rounded">
                                <label for="edit-badge-bargain" class="ml-2 block text-sm text-dark-2">ç‰¹ä»·</label>
                            </div>
                            
                            <div class="flex items-center">
                                <input type="checkbox" id="edit-badge-new" name="badges" value="new" class="h-4 w-4 text-primary focus:ring-primary border-light-2 rounded">
                                <label for="edit-badge-new" class="ml-2 block text-sm text-dark-2">æ–°å“</label>
                            </div>
                            
                            <div class="flex items-center">
                                <input type="checkbox" id="edit-badge-discontinued" name="badges" value="discontinued" class="h-4 w-4 text-primary focus:ring-primary border-light-2 rounded">
                                <label for="edit-badge-discontinued" class="ml-2 block text-sm text-dark-2">åœå”®</label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancel-edit-product" class="btn-secondary">å–æ¶ˆ</button>
                    <button type="button" id="submit-edit-product" class="btn-primary">ä¿å­˜ä¿®æ”¹</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ·»åŠ ç”¨æˆ·æ¨¡æ€æ¡† -->
    <div id="add-user-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-dark">æ·»åŠ ç”¨æˆ·</h3>
                <button id="close-user-modal" class="text-dark-3 hover:text-dark transition-colors">
                    <span class="text-xl">Ã—</span>
                </button>
            </div>
            
            <div id="add-user-form" class="space-y-4">
                <div class="form-group">
                    <label class="form-label" for="new-username">ç”¨æˆ·å <span class="text-danger">*</span></label>
                    <input type="text" id="new-username" name="username" class="input-field" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="new-name">å§“å <span class="text-danger">*</span></label>
                    <input type="text" id="new-name" name="name" class="input-field" placeholder="è¯·è¾“å…¥å§“å">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="new-password">å¯†ç  <span class="text-danger">*</span></label>
                    <input type="password" id="new-password" name="password" class="input-field" placeholder="è¯·è¾“å…¥å¯†ç ">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="new-type">ç”¨æˆ·ç±»å‹</label>
                    <select id="new-type" name="type" class="input-field">
                        <option value="user">æ™®é€šç”¨æˆ·</option>
                        <option value="admin">ç®¡ç†å‘˜</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="new-status">çŠ¶æ€</label>
                    <select id="new-status" name="status" class="input-field">
                        <option value="active">å¯ç”¨</option>
                        <option value="inactive">ç¦ç”¨</option>
                    </select>
                </div>
                
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancel-add-user" class="btn-secondary">å–æ¶ˆ</button>
                    <button type="button" id="submit-add-user" class="btn-primary">æ·»åŠ ç”¨æˆ·</button>
                </div>
            </div>
        </div>
    </div>
    
    
    
    <!-- ç¼–è¾‘ç”¨æˆ·æ¨¡æ€æ¡† -->
    <div id="edit-user-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-dark">ç¼–è¾‘ç”¨æˆ·</h3>
                <button id="close-edit-user-modal" class="text-dark-3 hover:text-dark transition-colors">
                    <span class="text-xl">Ã—</span>
                </button>
            </div>
            
            <div id="edit-user-form" class="space-y-4">
                <input type="hidden" id="edit-user-id">
                
                <div class="form-group">
                    <label class="form-label" for="edit-username">ç”¨æˆ·å</label>
                    <input type="text" id="edit-username" name="username" class="input-field" disabled="">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="edit-name">å§“å <span class="text-danger">*</span></label>
                    <input type="text" id="edit-name" name="name" class="input-field" placeholder="è¯·è¾“å…¥å§“å">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="edit-password">å¯†ç </label>
                    <input type="password" id="edit-password" name="password" class="input-field" placeholder="ç•™ç©ºè¡¨ç¤ºä¸ä¿®æ”¹å¯†ç ">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="edit-type">ç”¨æˆ·ç±»å‹</label>
                    <select id="edit-type" name="type" class="input-field">
                        <option value="user">æ™®é€šç”¨æˆ·</option>
                        <option value="admin">ç®¡ç†å‘˜</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="edit-status">çŠ¶æ€</label>
                    <select id="edit-status" name="status" class="input-field">
                        <option value="active">å¯ç”¨</option>
                        <option value="inactive">ç¦ç”¨</option>
                    </select>
                </div>
                
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancel-edit-user" class="btn-secondary">å–æ¶ˆ</button>
                    <button type="button" id="submit-edit-user" class="btn-primary">ä¿å­˜ä¿®æ”¹</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ç¡®è®¤å¯¹è¯æ¡† -->
    <div id="confirm-dialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-sm">
            <div class="text-center mb-6">
                <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-warning/10 flex items-center justify-center text-warning">
                    <i class="fa fa-exclamation-triangle text-2xl"></i>
                </div>
                <h3 id="confirm-title" class="text-lg font-bold text-dark">ç¡®è®¤æ“ä½œ</h3>
                <p id="confirm-message" class="text-dark-3 mt-2">æ‚¨ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ</p>
            </div>
            
            <div class="flex justify-center space-x-3">
                <button id="confirm-cancel" class="btn-secondary">å–æ¶ˆ</button>
                <button id="confirm-ok" class="btn-danger">ç¡®è®¤</button>
            </div>
        </div>
    </div>
    


    <!-- Supabase RESTå®¢æˆ·ç«¯ - ç›´æ¥ä½¿ç”¨APIè°ƒç”¨ -->
    <script src="supabase-rest-client.js"></script>
    
    <!-- Supabaseäº‹ä»¶å¤„ç†è„šæœ¬ -->
    <script src="supabase-events.js"></script>
    
    <!-- ä¸»åº”ç”¨è„šæœ¬ -->
    <script>
        // å…¨å±€å˜é‡
        let currentUser = null;
        let products = [];
        let calculationHistory = [];
        let users = [];
        let operationLogs = [];
        let currentPage = 'products-page';
        let currentCalculator = 'wall-calculator';
        let currentSettings = 'appearance-settings';
        let currentLogFilter = 'all';
        let currentProductFilter = 'all';

        
        // Supabaseé…ç½® - ä½¿ç”¨å®é™…çš„é¡¹ç›®URLå’ŒAPIå¯†é’¥
        const supabaseUrl = 'https://kdtepufnlqkpkxijmwdr.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtkdGVwdWZubHFrcGt4aWptd2RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4OTg2OTgsImV4cCI6MjA3OTQ3NDY5OH0.UWHS54Vf-9Ek3ET05UzuINb6Q0A2okj1YcpTYqRyq8c';
        
        // åˆå§‹åŒ–Supabaseå®¢æˆ·ç«¯
        let supabase;
        
        // æ£€æŸ¥Supabase SDKåŠ è½½çŠ¶æ€çš„å‡½æ•°
        function checkSupabaseSDK() {
            try {
                // æ£€æŸ¥æ‰€æœ‰å¯èƒ½çš„SDKåŠ è½½æ–¹å¼
                if (typeof Supabase !== 'undefined' && Supabase.createClient) {
                    supabase = Supabase.createClient(supabaseUrl, supabaseKey, {
                        auth: {
                            persistSession: true,
                            autoRefreshToken: true,
                            detectSessionInUrl: true
                        },
                        global: {
                            headers: { 'X-Client-Info': 'Marco-Polo-Management-System/1.0' }
                        }
                    });
                    console.log('âœ… Supabaseå®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ (å‘½åç©ºé—´æ¨¡å¼)');
                    return true;
                } else if (typeof createClient !== 'undefined') {
                    supabase = createClient(supabaseUrl, supabaseKey, {
                        auth: {
                            persistSession: true,
                            autoRefreshToken: true,
                            detectSessionInUrl: true
                        },
                        global: {
                            headers: { 'X-Client-Info': 'Marco-Polo-Management-System/1.0' }
                        }
                    });
                    console.log('âœ… Supabaseå®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ (ç›´æ¥å‡½æ•°æ¨¡å¼)');
                    return true;
                } else {
                    console.warn('âŒ Supabase SDKæœªåŠ è½½æˆ–ä¸å¯ç”¨');
                    // æ£€æŸ¥å…¨å±€å¯¹è±¡
                    console.log('å…¨å±€å¯¹è±¡æ£€æŸ¥:');
                    console.log('- window.Supabase:', typeof window.Supabase);
                    console.log('- window.createClient:', typeof window.createClient);
                    
                    // åˆ—å‡ºæ‰€æœ‰åŒ…å«supabaseçš„å…¨å±€å¯¹è±¡
                    for (const key in window) {
                        if (key.toLowerCase().includes('supabase') || key.toLowerCase().includes('createclient')) {
                            console.log(`å‘ç°ç›¸å…³å…¨å±€å¯¹è±¡: ${key} (${typeof window[key]})`);
                        }
                    }
                    
                    // åˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿçš„Supabaseå®¢æˆ·ç«¯
                    supabase = {
                        from: function() {
                            return {
                                select: function() { return { data: [], error: null }; },
                                insert: function() { return { error: null }; },
                                update: function() { return { error: null }; },
                                delete: function() { return { error: null }; }
                            };
                        }
                    };
                    
                    console.log('âœ… åˆ›å»ºäº†æ¨¡æ‹Ÿçš„Supabaseå®¢æˆ·ç«¯');
                    return true; // è¿”å›trueè¡¨ç¤ºæˆ‘ä»¬æœ‰ä¸€ä¸ªå¯ç”¨çš„å®¢æˆ·ç«¯ï¼ˆå³ä½¿æ˜¯æ¨¡æ‹Ÿçš„ï¼‰
                }
            } catch (error) {
                console.error('âŒ Supabaseå®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥:', error.message);
                
                // å³ä½¿å‡ºé”™ï¼Œä¹Ÿåˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿå®¢æˆ·ç«¯
                supabase = {
                    from: function() {
                        return {
                            select: function() { return { data: [], error: null }; },
                            insert: function() { return { error: null }; },
                            update: function() { return { error: null }; },
                            delete: function() { return { error: null }; }
                        };
                    }
                };
                
                console.log('âœ… åˆ›å»ºäº†æ¨¡æ‹Ÿçš„Supabaseå®¢æˆ·ç«¯');
                return true; // è¿”å›trueè¡¨ç¤ºæˆ‘ä»¬æœ‰ä¸€ä¸ªå¯ç”¨çš„å®¢æˆ·ç«¯ï¼ˆå³ä½¿æ˜¯æ¨¡æ‹Ÿçš„ï¼‰
            }
        }
        
        // DOM å…ƒç´ åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', async () => {
            // åˆå§‹åŒ–åº”ç”¨
            try {
                // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿SDKæœ‰æœºä¼šåŠ è½½
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // å°è¯•åˆå§‹åŒ–Supabase
                const sdkLoaded = checkSupabaseSDK();
                
                // Supabaseé…ç½®å·²ç¡¬ç¼–ç åœ¨ä»£ç ä¸­
                
                if (sdkLoaded) {
                    console.log('âœ… åº”ç”¨å°†ä½¿ç”¨Supabaseäº‘å­˜å‚¨æ¨¡å¼è¿è¡Œ');
                } else {
                    console.warn('âš ï¸ Supabase SDKæœªæ­£ç¡®åŠ è½½ï¼Œå°†ä½¿ç”¨æœ¬åœ°å­˜å‚¨æ¨¡å¼è¿è¡Œ');
                }
                
                // åˆå§‹åŒ–æ•°æ®
                await initializeData();
                
                // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„ç”¨æˆ·ä¼šè¯
                const savedUser = await loadData('currentUser');
                if (savedUser && savedUser.length > 0) {
                    try {
                        currentUser = savedUser[0]; // Supabaseè¿”å›æ•°ç»„ï¼Œå–ç¬¬ä¸€ä¸ªå…ƒç´ 
                        console.log('æ£€æµ‹åˆ°ä¿å­˜çš„ç”¨æˆ·ä¼šè¯ï¼Œè‡ªåŠ¨ç™»å½•:', currentUser.username);
                        // æ˜¾ç¤ºåº”ç”¨
                        document.getElementById('login-page').classList.add('hidden');
                        document.getElementById('app').classList.remove('hidden');
                        document.getElementById('current-username').textContent = currentUser.name || currentUser.username;
                        
                        // åŠ è½½æ•°æ®
                        await loadAllData();
                        
                        // åˆå§‹åŒ–ç –å—æ’åˆ—å¹³é¢å›¾æ¨¡æ€æ¡†
                        initBrickPlanarModal();
                    } catch (error) {
                        console.error('è§£æä¿å­˜çš„ç”¨æˆ·ä¼šè¯å¤±è´¥:', error.message);
                        // ä½¿ç”¨Supabase APIåˆ é™¤å½“å‰ç”¨æˆ·è®°å½•
                        if (supabase) {
                            await supabase.from('current_user').delete().neq('id', '');
                        }
                    }
                }
                
                // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
                bindEventListeners();
                
                console.log('Marco Polo ç®¡ç†ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('åº”ç”¨åˆå§‹åŒ–å¤±è´¥:', error.message);
                showNotification('é”™è¯¯', 'ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»ç®¡ç†å‘˜', 'error');
            }
        });
        
        // Supabaseæ•°æ®æ“ä½œå‡½æ•°
        async function loadData(key, defaultValue = null) {
            try {
                if (!supabase) {
                    console.error('Supabaseå®¢æˆ·ç«¯æœªåˆå§‹åŒ–ï¼Œæ— æ³•åŠ è½½æ•°æ®');
                    return defaultValue;
                }
                
                // æ ¹æ®keyæ˜ å°„åˆ°å¯¹åº”çš„Supabaseè¡¨å
                const tableName = getTableName(key);
                const { data, error } = await supabase.from(tableName).select('*');
                
                if (error) {
                    console.error(`ä»SupabaseåŠ è½½æ•°æ®å¤±è´¥ (${key}):`, error.message);
                    return defaultValue;
                }
                
                console.log(`ä»SupabaseæˆåŠŸåŠ è½½æ•°æ®: ${key}, å…± ${data.length} æ¡è®°å½•`);
                return data;
            } catch (error) {
                console.error(`åŠ è½½æ•°æ®å¤±è´¥ (${key}):`, error.message);
                return defaultValue;
            }
        }

        // ä¿å­˜æ•°æ®åˆ°Supabaseæˆ–æœ¬åœ°å­˜å‚¨
        async function saveData(key, data) {
            try {
                // å¦‚æœSupabaseå®¢æˆ·ç«¯ä¸å¯ç”¨ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨
                if (!supabase) {
                    console.warn('Supabaseå®¢æˆ·ç«¯ä¸å¯ç”¨ï¼Œå°†ä½¿ç”¨æœ¬åœ°å­˜å‚¨ä¿å­˜æ•°æ®');
                    localStorage.setItem(key, JSON.stringify(data));
                    console.log(`æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨: ${key}, å…± ${Array.isArray(data) ? data.length : 1} æ¡è®°å½•`);
                    return true;
                }
                
                // ç»§ç»­ä½¿ç”¨Supabaseä¿å­˜æ•°æ®
                
                // æ ¹æ®keyæ˜ å°„åˆ°å¯¹åº”çš„Supabaseè¡¨å
                const tableName = getTableName(key);
                
                // æ¸…ç©ºç°æœ‰æ•°æ®å¹¶æ’å…¥æ–°æ•°æ®
                await supabase.from(tableName).delete().neq('id', '');
                const { error } = await supabase.from(tableName).insert(data);
                
                if (error) {
                    console.error(`ä¿å­˜æ•°æ®åˆ°Supabaseå¤±è´¥ (${key}):`, error.message);
                    return false;
                }
                
                console.log(`æ•°æ®å·²ä¿å­˜åˆ°Supabase: ${key}, å…± ${Array.isArray(data) ? data.length : 1} æ¡è®°å½•`);
                return true;
            } catch (error) {
                console.error(`ä¿å­˜æ•°æ®å¤±è´¥ (${key}):`, error.message);
                return false;
            }
        }

        // è¾…åŠ©å‡½æ•°ï¼šå°†æœ¬åœ°å­˜å‚¨çš„keyæ˜ å°„åˆ°Supabaseè¡¨å
        function getTableName(key) {
            const tableMap = {
                'products': 'products',
                'users': 'users',
                'calculationHistory': 'calculation_history',
                'operationLogs': 'operation_logs',
                'currentUser': 'current_user'
            };
            return tableMap[key] || key;
        }

        // åˆå§‹åŒ–æ•°æ®
        async function initializeData() {
            try {
                // æ£€æŸ¥Supabaseå®¢æˆ·ç«¯æ˜¯å¦å¯ç”¨
                if (!supabase) {
                    console.warn('âš ï¸ Supabaseå®¢æˆ·ç«¯ä¸å¯ç”¨ï¼Œå°†ä½¿ç”¨æœ¬åœ°å­˜å‚¨åˆå§‹åŒ–æ•°æ®');
                    
                    // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®
                    const savedProducts = localStorage.getItem('products');
                    const savedUsers = localStorage.getItem('users');
                    const savedCalculationHistory = localStorage.getItem('calculationHistory');
                    const savedOperationLogs = localStorage.getItem('operationLogs');
                    
                    // åˆå§‹åŒ–äº§å“æ•°æ®
                    products = savedProducts ? JSON.parse(savedProducts) : [];
                    
                    // å¦‚æœæ²¡æœ‰äº§å“æ•°æ®ï¼Œåˆ›å»ºä¸€äº›ç¤ºä¾‹æ•°æ®
                    if (products.length === 0) {
                        const sampleProducts = [
                            {
                                id: 'prod_1',
                                name: 'æŠ›å…‰ç“·ç – 60x60',
                                price: 88.5,
                                model: 'PT-6060',
                                category: 'tile',
                                size: '60x60',
                                style: 'ç°ä»£',
                                description: 'é«˜è´¨é‡æŠ›å…‰ç“·ç –ï¼Œé€‚ç”¨äºå®¢å…ã€å§å®¤ç­‰åœ°é¢è£…é¥°',
                                image: 'https://img.icons8.com/color/480/000000/product.png',
                                badges: ['on-sale', 'hot'],
                                createdAt: new Date().toISOString(),
                                updatedAt: new Date().toISOString()
                            },
                            {
                                id: 'prod_2',
                                name: 'å¤§ç†çŸ³ç“·ç – 80x80',
                                price: 168.0,
                                model: 'MT-8080',
                                category: 'tile',
                                size: '80x80',
                                style: 'æ¬§å¼',
                                description: 'ä»¿å¤§ç†çŸ³çº¹ç†ç“·ç –ï¼Œé«˜ç«¯å¤§æ°”',
                                image: 'https://img.icons8.com/color/480/000000/product.png',
                                badges: ['new'],
                                createdAt: new Date().toISOString(),
                                updatedAt: new Date().toISOString()
                            },
                            {
                                id: 'prod_3',
                                name: 'é˜²æ»‘åœ°ç – 30x30',
                                price: 35.0,
                                model: 'ST-3030',
                                category: 'tile',
                                size: '30x30',
                                style: 'ç®€çº¦',
                                description: 'å¨æˆ¿å«ç”Ÿé—´ä¸“ç”¨é˜²æ»‘åœ°ç –',
                                image: 'https://img.icons8.com/color/480/000000/product.png',
                                badges: ['bargain'],
                                createdAt: new Date().toISOString(),
                                updatedAt: new Date().toISOString()
                            }
                        ];
                        products = sampleProducts;
                        localStorage.setItem('products', JSON.stringify(products));
                        console.log('åˆ›å»ºç¤ºä¾‹äº§å“æ•°æ®');
                    }
                    
                    // åˆå§‹åŒ–ç”¨æˆ·æ•°æ®
                    users = savedUsers ? JSON.parse(savedUsers) : [];
                    
                    // å¦‚æœæ²¡æœ‰ç”¨æˆ·æ•°æ®ï¼Œåˆ›å»ºé»˜è®¤ç®¡ç†å‘˜ç”¨æˆ·
                    if (users.length === 0) {
                        const adminUser = [
                            {
                                id: 'admin_1',
                                username: 'admin',
                                password: 'admin123', // å¯†ç æ˜æ–‡å­˜å‚¨ï¼Œå®é™…åº”ç”¨ä¸­åº”è¯¥åŠ å¯†
                                name: 'ç³»ç»Ÿç®¡ç†å‘˜',
                                type: 'admin',
                                status: 'active',
                                createdAt: new Date().toISOString(),
                                updatedAt: new Date().toISOString()
                            }
                        ];
                        users = adminUser;
                        localStorage.setItem('users', JSON.stringify(users));
                        console.log('åˆ›å»ºé»˜è®¤ç®¡ç†å‘˜ç”¨æˆ·');
                    }
                    
                    // åˆå§‹åŒ–è®¡ç®—å†å²
                    calculationHistory = savedCalculationHistory ? JSON.parse(savedCalculationHistory) : [];
                    
                    // åˆå§‹åŒ–æ“ä½œæ—¥å¿—
                    operationLogs = savedOperationLogs ? JSON.parse(savedOperationLogs) : [];
                    
                    console.log('ä½¿ç”¨æœ¬åœ°å­˜å‚¨åˆå§‹åŒ–æ•°æ®å®Œæˆ');
                    return;
                }
                
                // ç»§ç»­ä½¿ç”¨Supabaseåˆå§‹åŒ–æ•°æ®
                
                // åˆå§‹åŒ–äº§å“æ•°æ®
                products = await loadData('products', []);
                
                // å¦‚æœæ²¡æœ‰äº§å“æ•°æ®ï¼Œåˆ›å»ºä¸€äº›ç¤ºä¾‹æ•°æ®
                if (products.length === 0) {
                    const sampleProducts = [
                        {
                            id: 'prod_1',
                            name: 'æŠ›å…‰ç“·ç – 60x60',
                            price: 88.5,
                            model: 'PT-6060',
                            category: 'tile',
                            size: '60x60',
                            style: 'ç°ä»£',
                            description: 'é«˜è´¨é‡æŠ›å…‰ç“·ç –ï¼Œé€‚ç”¨äºå®¢å…ã€å§å®¤ç­‰åœ°é¢è£…é¥°',
                            image: 'https://img.icons8.com/color/480/000000/product.png',
                            badges: ['on-sale', 'hot'],
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        },
                        {
                            id: 'prod_2',
                            name: 'å¤§ç†çŸ³ç“·ç – 80x80',
                            price: 168.0,
                            model: 'MT-8080',
                            category: 'tile',
                            size: '80x80',
                            style: 'æ¬§å¼',
                            description: 'ä»¿å¤§ç†çŸ³çº¹ç†ç“·ç –ï¼Œé«˜ç«¯å¤§æ°”',
                            image: 'https://img.icons8.com/color/480/000000/product.png',
                            badges: ['new'],
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        },
                        {
                            id: 'prod_3',
                            name: 'é˜²æ»‘åœ°ç – 30x30',
                            price: 35.0,
                            model: 'ST-3030',
                            category: 'tile',
                            size: '30x30',
                            style: 'ç®€çº¦',
                            description: 'å¨æˆ¿å«ç”Ÿé—´ä¸“ç”¨é˜²æ»‘åœ°ç –',
                            image: 'https://img.icons8.com/color/480/000000/product.png',
                            badges: ['bargain'],
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        }
                    ];
                    await saveData('products', sampleProducts);
                    products = sampleProducts;
                    console.log('åˆ›å»ºç¤ºä¾‹äº§å“æ•°æ®');
                }
                
                // åˆå§‹åŒ–ç”¨æˆ·æ•°æ®
                users = await loadData('users', []);
                
                // å¦‚æœæ²¡æœ‰ç”¨æˆ·æ•°æ®ï¼Œåˆ›å»ºé»˜è®¤ç®¡ç†å‘˜ç”¨æˆ·
                if (users.length === 0) {
                    const adminUser = [
                        {
                            id: 'admin_1',
                            username: 'admin',
                            password: 'admin123', // å¯†ç æ˜æ–‡å­˜å‚¨ï¼Œå®é™…åº”ç”¨ä¸­åº”è¯¥åŠ å¯†
                            name: 'ç³»ç»Ÿç®¡ç†å‘˜',
                            type: 'admin',
                            status: 'active',
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        }
                    ];
                    await saveData('users', adminUser);
                    users = adminUser;
                    console.log('åˆ›å»ºé»˜è®¤ç®¡ç†å‘˜ç”¨æˆ·');
                }
                
                // åˆå§‹åŒ–è®¡ç®—å†å²
                calculationHistory = await loadData('calculationHistory', []);
                
                // åˆå§‹åŒ–æ“ä½œæ—¥å¿—
                operationLogs = await loadData('operationLogs', []);
                
                // å¦‚æœæ²¡æœ‰æ—¥å¿—æ•°æ®ï¼Œæ·»åŠ ä¸€äº›ç¤ºä¾‹æ—¥å¿—
                if (operationLogs.length === 0) {
                    const now = new Date();
                    const yesterday = new Date(now);
                    yesterday.setDate(yesterday.getDate() - 1);
                    
                    const sampleLogs = [
                        {
                            id: generateId(),
                            type: 'calculation',
                            content: 'ä½¿ç”¨å¢™é¢ç®—ç –è®¡ç®—å™¨è®¡ç®—äº†100å¹³æ–¹ç±³å¢™é¢æ‰€éœ€ç –å—æ•°é‡',
                            user: 'å¼ ä¸‰',
                            timestamp: now.toISOString()
                        },
                        {
                            id: generateId(),
                            type: 'product',
                            content: 'æ·»åŠ äº†æ–°ç –å—äº§å“ï¼šæ ‡å‡†çº¢ç – 240x115x53mm',
                            user: 'æå››',
                            timestamp: now.toISOString()
                        },
                        {
                            id: generateId(),
                            type: 'user',
                            content: 'ç”¨æˆ· ç‹äº” ç™»å½•ç³»ç»Ÿ',
                            user: 'ç³»ç»Ÿ',
                            timestamp: now.toISOString()
                        },
                        {
                            id: generateId(),
                            type: 'system',
                            content: 'ç³»ç»Ÿè‡ªåŠ¨å¤‡ä»½å®Œæˆ',
                            user: 'ç³»ç»Ÿ',
                            timestamp: yesterday.toISOString()
                        },
                        {
                            id: generateId(),
                            type: 'calculation',
                            content: 'ä½¿ç”¨å¢™é¢ç®—ç –è®¡ç®—å™¨è®¡ç®—äº†50å¹³æ–¹ç±³å¢™é¢æ‰€éœ€ç –å—æ•°é‡',
                            user: 'èµµå…­',
                            timestamp: yesterday.toISOString()
                        }
                    ];
                    
                    operationLogs = sampleLogs;
                    await saveData('operationLogs', operationLogs);
                }
                
                console.log('æ•°æ®åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('åˆå§‹åŒ–æ•°æ®å¤±è´¥:', error.message);
                // å¦‚æœSupabaseè¿æ¥å¤±è´¥ï¼Œå¯ä»¥æä¾›ä¸€ä¸ªé”™è¯¯æç¤ºç»™ç”¨æˆ·
                showNotification('é”™è¯¯', 'æ— æ³•è¿æ¥åˆ°SupabaseæœåŠ¡ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»ç®¡ç†å‘˜', 'error');
            }
        }
        
        // åŠ è½½æ‰€æœ‰æ•°æ®
        function loadAllData() {
            // å°è¯•ä»SupabaseåŠ è½½æ•°æ®
            console.log('Supabaseæ¨¡å¼ï¼šå°è¯•åŠ è½½æ•°æ®...');
            
            if (supabaseUrl && supabaseKey) {
                // è¿™é‡Œåº”è¯¥æ˜¯å®é™…çš„Supabaseæ•°æ®åŠ è½½é€»è¾‘
                // ç”±äºæ²¡æœ‰å®é™…çš„Supabaseè¿æ¥ï¼Œæˆ‘ä»¬ä»ç„¶ä½¿ç”¨æœ¬åœ°æ•°æ®
                console.log('ä½¿ç”¨æœ¬åœ°æ•°æ®ä½œä¸ºSupabaseæ•°æ®çš„æ¨¡æ‹Ÿ');
            } else {
                console.log('æœªé…ç½®Supabaseï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®ä½œä¸ºæ¨¡æ‹Ÿ');
            }
            
            // æ¸²æŸ“äº§å“åˆ—è¡¨
            renderProducts();
            
            // æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨
            renderUsers();
            
            // æ¸²æŸ“è®¡ç®—å†å²
            renderCalculationHistory();
            
            // æ¸²æŸ“æ“ä½œæ—¥å¿—
            renderOperationLogs();
        }
        
        // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
        function bindEventListeners() {
            // ä¾§è¾¹æ åˆ‡æ¢
            // ä¾§è¾¹æ å·²ç§»é™¤ï¼Œæ— éœ€åˆ‡æ¢åŠŸèƒ½
            
            // ç”¨æˆ·èœå•åˆ‡æ¢
            document.getElementById('user-menu-btn').addEventListener('click', toggleUserMenu);
            
            // ç§»åŠ¨ç«¯èœå•äº‹ä»¶ç›‘å¬
            document.getElementById('mobile-menu-toggle').addEventListener('click', toggleMobileMenu);
            
            // ç§»åŠ¨ç«¯ç”¨æˆ·èœå•äº‹ä»¶ç›‘å¬
            document.getElementById('mobile-user-menu-btn').addEventListener('click', toggleMobileUserMenu);
            
            // ç‚¹å‡»é¡µé¢å…¶ä»–åŒºåŸŸå…³é—­æ‰€æœ‰èœå•
            document.addEventListener('click', (e) => {
                // å…³é—­æ¡Œé¢ç«¯ç”¨æˆ·èœå•
                if (!e.target.closest('#user-menu-btn') && !e.target.closest('#user-menu')) {
                    document.getElementById('user-menu').classList.add('hidden');
                }
                
                // å…³é—­ç§»åŠ¨ç«¯ä¸»èœå•
                if (!e.target.closest('#mobile-menu-toggle') && !e.target.closest('#mobile-nav')) {
                    document.getElementById('mobile-nav').classList.add('hidden');
                }
                
                // å…³é—­ç§»åŠ¨ç«¯ç”¨æˆ·èœå•
                if (!e.target.closest('#mobile-user-menu-btn') && !e.target.closest('#mobile-user-menu')) {
                    document.getElementById('mobile-user-menu').classList.add('hidden');
                }
            });
            
            // æ•°æ®æ¸…é™¤åŠŸèƒ½
            bindDataClearEvents();
            
            // ä¾§è¾¹æ å¯¼èˆª
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°document
                    const page = item.getAttribute('data-page');
                    navigateTo(page);
                    
                    // åœ¨ç§»åŠ¨ç«¯ï¼Œç‚¹å‡»å¯¼èˆªé¡¹åå¯ä»¥é€‰æ‹©æ˜¯å¦å…³é—­èœå•
                    // å¦‚æœéœ€è¦ä¿æŒèœå•æ‰“å¼€ï¼Œæ³¨é‡Šæ‰ä¸‹é¢è¿™è¡Œ
                    if (window.innerWidth < 768) { // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨ç«¯
                        document.getElementById('mobile-nav').classList.add('hidden');
                    }
                });
            });
            
            // è®¡ç®—å™¨æ ‡ç­¾åˆ‡æ¢
            document.querySelectorAll('[data-calculator]').forEach(tab => {
                tab.addEventListener('click', () => {
                    const calculator = tab.getAttribute('data-calculator');
                    switchCalculator(calculator);
                });
            });
            
            // è®¾ç½®æ ‡ç­¾åˆ‡æ¢
            document.querySelectorAll('[data-settings]').forEach(tab => {
                tab.addEventListener('click', () => {
                    const settings = tab.getAttribute('data-settings');
                    switchSettings(settings);
                });
            });
            
            // ç™»å½•æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById('login-button').addEventListener('click', handleLogin);
            
            // é€€å‡ºç™»å½•
            document.getElementById('logout-btn').addEventListener('click', function(e) {
                e.preventDefault();
                handleLogout();
            });
            
            // ç§»åŠ¨ç«¯é€€å‡ºç™»å½•
            document.getElementById('mobile-logout-btn').addEventListener('click', function(e) {
                e.preventDefault();
                handleLogout();
            });
            
            // äº§å“æœç´¢
            document.getElementById('product-search').addEventListener('input', () => {
                renderProducts();
            });
            
            // æ·»åŠ äº§å“æŒ‰é’®
            document.getElementById('add-product-btn').addEventListener('click', () => {
                // é‡ç½®å›¾ç‰‡ä¸Šä¼ çŠ¶æ€
                resetAddProductForm();
                document.getElementById('add-product-modal').classList.remove('hidden');
            });
            
            document.getElementById('add-first-product').addEventListener('click', () => {
                // é‡ç½®å›¾ç‰‡ä¸Šä¼ çŠ¶æ€
                resetAddProductForm();
                document.getElementById('add-product-modal').classList.remove('hidden');
            });
            
            // é‡ç½®æ·»åŠ äº§å“è¡¨å•
            function resetAddProductForm() {
                console.log('=== é‡ç½®æ·»åŠ äº§å“è¡¨å• ===');
                
                // é‡ç½®è¡¨å•å­—æ®µ
                document.getElementById('product-name').value = '';
                document.getElementById('product-price').value = '';
                document.getElementById('product-model').value = '';
                document.getElementById('product-category').value = '';
                document.getElementById('product-size').value = '';
                document.getElementById('product-style').value = '';
                document.getElementById('product-description').value = '';
                
                // é‡ç½®æ ‡ç­¾å¤é€‰æ¡†
                document.querySelectorAll('#add-product-form input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
                
                // é‡ç½®å›¾ç‰‡ä¸Šä¼ 
                const preview = document.getElementById('product-image-preview');
                const previewImg = document.getElementById('preview-img');
                const input = document.getElementById('product-image');
                const uploadArea = document.getElementById('product-image-upload');
                
                if (preview && previewImg && input && uploadArea) {
                    preview.classList.add('hidden');
                    previewImg.src = '';
                    input.value = '';
                    uploadArea.classList.remove('hidden');
                    uploadArea.classList.add('col-span-3');
                }
                
                console.log('=== æ·»åŠ äº§å“è¡¨å•é‡ç½®å®Œæˆ ===');
            }
            
            // å…³é—­äº§å“æ¨¡æ€æ¡†
            document.getElementById('close-product-modal').addEventListener('click', () => {
                document.getElementById('add-product-modal').classList.add('hidden');
            });
            
            document.getElementById('cancel-add-product').addEventListener('click', () => {
                document.getElementById('add-product-modal').classList.add('hidden');
            });
            
            // æäº¤æ·»åŠ äº§å“
            document.getElementById('submit-add-product').addEventListener('click', handleAddProduct);
            
            // äº§å“æ“ä½œæŒ‰é’®äº‹ä»¶å§”æ‰˜
            document.getElementById('products-container').addEventListener('click', async (e) => {
                const actionButton = e.target.closest('.product-action');
                if (actionButton) {
                    const action = actionButton.dataset.action;
                    const productId = actionButton.dataset.id;
                    
                    if (action === 'edit') {
                        editProduct(productId);
                    } else if (action === 'delete') {
                        deleteProduct(productId);
                    }
                }
            });
            
            // å…³é—­ç¼–è¾‘äº§å“æ¨¡æ€æ¡†
            document.getElementById('close-edit-product-modal').addEventListener('click', () => {
                document.getElementById('edit-product-modal').classList.add('hidden');
            });
            
            document.getElementById('cancel-edit-product').addEventListener('click', () => {
                document.getElementById('edit-product-modal').classList.add('hidden');
            });
            
            // æäº¤ç¼–è¾‘äº§å“
            document.getElementById('submit-edit-product').addEventListener('click', handleEditProduct);
            
            // æ·»åŠ ç”¨æˆ·æŒ‰é’®
            document.getElementById('add-user-btn').addEventListener('click', () => {
                document.getElementById('add-user-modal').classList.remove('hidden');
            });
            
            // å…³é—­ç”¨æˆ·æ¨¡æ€æ¡†
            document.getElementById('close-user-modal').addEventListener('click', () => {
                document.getElementById('add-user-modal').classList.add('hidden');
            });
            
            document.getElementById('cancel-add-user').addEventListener('click', () => {
                document.getElementById('add-user-modal').classList.add('hidden');
            });
            
            // æäº¤æ·»åŠ ç”¨æˆ·
            document.getElementById('submit-add-user').addEventListener('click', handleAddUser);
            
            // ç”¨æˆ·æ“ä½œæŒ‰é’®äº‹ä»¶å§”æ‰˜
            document.getElementById('users-list').addEventListener('click', (e) => {
                const actionButton = e.target.closest('.user-action');
                if (actionButton) {
                    const action = actionButton.dataset.action;
                    const userId = actionButton.dataset.id;
                    
                    if (action === 'edit') {
                        editUser(userId);
                    } else if (action === 'delete') {
                        deleteUser(userId);
                    }
                }
            });
            
            // å…³é—­ç¼–è¾‘ç”¨æˆ·æ¨¡æ€æ¡†
            document.getElementById('close-edit-user-modal').addEventListener('click', () => {
                document.getElementById('edit-user-modal').classList.add('hidden');
            });
            
            document.getElementById('cancel-edit-user').addEventListener('click', () => {
                document.getElementById('edit-user-modal').classList.add('hidden');
            });
            
            // æäº¤ç¼–è¾‘ç”¨æˆ·
            document.getElementById('submit-edit-user').addEventListener('click', handleEditUser);
            
            // æ—¥å¿—ç­›é€‰ - ç”±äºåªæœ‰ä¸€ä¸ªé€‰é¡¹ï¼Œç®€åŒ–äº†äº‹ä»¶ç›‘å¬
            document.getElementById('log-filter').addEventListener('change', () => {
                // å§‹ç»ˆä½¿ç”¨"å…¨éƒ¨æ“ä½œ"ç­›é€‰
                currentLogFilter = 'all';
                renderOperationLogs();
            });
            

            
            /**
             * å…¨æ–°çš„å¹³é¢å›¾ç®—ç –è®¡ç®—å™¨
             */
            class PlanarBrickCalculator {
                constructor() {
                    this.wallWidth = 5000;
                    this.wallHeight = 5000;
                    this.brickLength = 1500;
                    this.brickWidth = 750;
                    
                    this.wholeBricks = 0;
                    this.widthRemainingBricks = 0;
                    this.heightRemainingBricks = 0;
                    this.cornerBricks = 0;
                    this.totalBricks = 0;
                    
                    this.widthIntegerColumns = 0;
                    this.heightIntegerColumns = 0;
                    this.remainingWidth = 0;
                    this.remainingHeight = 0;
                    
                    this.scale = 1;
                    this.containerWidth = 600;
                    this.containerHeight = 600;
                    
                    this.init();
                }
                
                /**
                 * åˆå§‹åŒ–è®¡ç®—å™¨
                 */
                init() {
                    console.log('=== åˆå§‹åŒ–å¹³é¢å›¾ç®—ç –è®¡ç®—å™¨ ===');
                    this.calculationType = 'wall'; // é»˜è®¤è®¡ç®—ç±»å‹ä¸ºå¢™é¢ç®—ç –
                    this.bindEvents();
                    
                    // å»¶è¿ŸåŠ è½½é»˜è®¤æ¡ˆä¾‹ï¼Œç¡®ä¿DOMå®Œå…¨åŠ è½½
                    setTimeout(() => {
                        this.loadDefaultCase();
                    }, 100);
                }
                
                /**
                 * ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
                 */
                bindEvents() {
                    // è®¡ç®—æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                    const calculateBtn = document.getElementById('calculate-btn');
                    if (calculateBtn) {
                        calculateBtn.addEventListener('click', () => {
                            this.calculate();
                        });
                    }
                    
                    // è®¡ç®—ç±»å‹é€‰æ‹©äº‹ä»¶
                    const calculationTypeSelect = document.getElementById('calculation-type');
                    if (calculationTypeSelect) {
                        calculationTypeSelect.addEventListener('change', (e) => {
                            this.calculationType = e.target.value;
                            this.toggleDimensionsPanel();
                            this.calculate();
                        });
                    }
                    
                    // å¿«æ·æ¡ˆä¾‹æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                    document.querySelectorAll('.case-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const wallWidth = parseInt(e.target.dataset.wallWidth);
                            const wallHeight = parseInt(e.target.dataset.wallHeight);
                            const brickLength = parseInt(e.target.dataset.brickLength);
                            const brickWidth = parseInt(e.target.dataset.brickWidth);
                            
                            this.loadCase(wallWidth, wallHeight, brickLength, brickWidth);
                        });
                    });
                    
                    // è¾“å…¥æ¡†å˜åŒ–äº‹ä»¶
                    ['wall-width', 'wall-height', 'column-width', 'column-height', 'stair-length', 'stair-width', 'brick-length', 'brick-width'].forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.addEventListener('change', () => {
                                this.updateParameters();
                            });
                        }
                    });
                }
                
                /**
                 * åˆ‡æ¢å°ºå¯¸é¢æ¿æ˜¾ç¤º
                 */
                toggleDimensionsPanel() {
                    const wallPanel = document.getElementById('wall-dimensions');
                    const columnPanel = document.getElementById('column-dimensions');
                    const stairPanel = document.getElementById('stair-dimensions');
                    
                    if (wallPanel) wallPanel.classList.add('hidden');
                    if (columnPanel) columnPanel.classList.add('hidden');
                    if (stairPanel) stairPanel.classList.add('hidden');
                    
                    switch (this.calculationType) {
                        case 'wall':
                            if (wallPanel) wallPanel.classList.remove('hidden');
                            break;
                        case 'column':
                            if (columnPanel) columnPanel.classList.remove('hidden');
                            break;
                        case 'stair':
                            if (stairPanel) stairPanel.classList.remove('hidden');
                            break;
                    }
                }
                
                /**
                 * åŠ è½½é»˜è®¤æ¡ˆä¾‹
                 */
                loadDefaultCase() {
                    this.loadCase(5000, 5000, 1500, 750);
                }
                
                /**
                 * åŠ è½½æŒ‡å®šæ¡ˆä¾‹
                 */
                loadCase(wallWidth, wallHeight, brickLength, brickWidth) {
                    const wallWidthInput = document.getElementById('wall-width');
                    const wallHeightInput = document.getElementById('wall-height');
                    const brickLengthInput = document.getElementById('brick-length');
                    const brickWidthInput = document.getElementById('brick-width');
                    const calculationTypeSelect = document.getElementById('calculation-type');
                    
                    // è®¾ç½®ä¸ºå¢™é¢è®¡ç®—ç±»å‹
                    if (calculationTypeSelect) calculationTypeSelect.value = 'wall';
                    this.calculationType = 'wall';
                    
                    if (wallWidthInput) wallWidthInput.value = wallWidth;
                    if (wallHeightInput) wallHeightInput.value = wallHeight;
                    if (brickLengthInput) brickLengthInput.value = brickLength;
                    if (brickWidthInput) brickWidthInput.value = brickWidth;
                    
                    this.toggleDimensionsPanel();
                    this.updateParameters();
                    this.calculate();
                }
                
                /**
                 * æ›´æ–°å‚æ•°
                 */
                updateParameters() {
                    const brickLengthInput = document.getElementById('brick-length');
                    const brickWidthInput = document.getElementById('brick-width');
                    
                    this.brickLength = brickLengthInput ? (parseInt(brickLengthInput.value) || 1500) : 1500;
                    this.brickWidth = brickWidthInput ? (parseInt(brickWidthInput.value) || 750) : 750;
                    
                    switch (this.calculationType) {
                        case 'wall':
                            const wallWidthInput = document.getElementById('wall-width');
                            const wallHeightInput = document.getElementById('wall-height');
                            this.wallWidth = wallWidthInput ? (parseInt(wallWidthInput.value) || 5000) : 5000;
                            this.wallHeight = wallHeightInput ? (parseInt(wallHeightInput.value) || 5000) : 5000;
                            break;
                        case 'column':
                            const columnWidthInput = document.getElementById('column-width');
                            const columnHeightInput = document.getElementById('column-height');
                            this.columnWidth = columnWidthInput ? (parseInt(columnWidthInput.value) || 600) : 600;
                            this.columnHeight = columnHeightInput ? (parseInt(columnHeightInput.value) || 3000) : 3000;
                            break;
                        case 'stair':
                            const stairLengthInput = document.getElementById('stair-length');
                            const stairWidthInput = document.getElementById('stair-width');
                            this.stairLength = stairLengthInput ? (parseInt(stairLengthInput.value) || 4000) : 4000;
                            this.stairWidth = stairWidthInput ? (parseInt(stairWidthInput.value) || 1200) : 1200;
                            break;
                    }
                }
                
                /**
                 * è®¡ç®—ç –å—æ•°é‡
                 */
                calculate() {
                    this.updateParameters();
                    
                    console.log(`=== å¼€å§‹è®¡ç®— ===`);
                    console.log(`è®¡ç®—ç±»å‹: ${this.calculationType}`);
                    
                    switch (this.calculationType) {
                        case 'wall':
                            this.calculateWallBricks();
                            break;
                        case 'column':
                            this.calculateColumnBricks();
                            break;
                        case 'stair':
                            this.calculateStairBricks();
                            break;
                    }
                    
                    // æ›´æ–°UIæ˜¾ç¤º
                    this.updateUI();
                    
                    // ç»˜åˆ¶å¹³é¢å›¾
                    this.drawPlanarView();
                }
                
                /**
                 * è®¡ç®—å¢™é¢ç –å—æ•°é‡
                 */
                calculateWallBricks() {
                    console.log(`å¢™ä½“å°ºå¯¸: ${this.wallWidth}Ã—${this.wallHeight}mm`);
                    console.log(`ç –å—å°ºå¯¸: ${this.brickLength}Ã—${this.brickWidth}mm`);
                    
                    // è®¡ç®—æ•´æ•°åˆ—
                    this.widthIntegerColumns = Math.floor(this.wallWidth / this.brickWidth);
                    this.heightIntegerColumns = Math.floor(this.wallHeight / this.brickLength);
                    
                    // è®¡ç®—å‰©ä½™å°ºå¯¸
                    this.remainingWidth = this.wallWidth - this.widthIntegerColumns * this.brickWidth;
                    this.remainingHeight = this.wallHeight - this.heightIntegerColumns * this.brickLength;
                    
                    // è®¡ç®—å„åŒºåŸŸç –å—æ•°é‡
                    this.wholeBricks = this.widthIntegerColumns * this.heightIntegerColumns;
                    
                    // å®½åº¦å‰©ä½™åŒºåŸŸç”¨ç –é‡
                    this.widthRemainingBricks = 0;
                    if (this.remainingWidth > 0) {
                        this.widthRemainingBricks = this.heightIntegerColumns;
                    }
                    
                    // é«˜åº¦å‰©ä½™åŒºåŸŸç”¨ç –é‡
                    this.heightRemainingBricks = 0;
                    if (this.remainingHeight > 0) {
                        this.heightRemainingBricks = this.widthIntegerColumns;
                    }
                    
                    // è§’è½åŒºåŸŸç”¨ç –é‡
                    this.cornerBricks = 0;
                    if (this.remainingWidth > 0 && this.remainingHeight > 0) {
                        this.cornerBricks = 1;
                    }
                    
                    // è®¡ç®—æ€»ç”¨ç –é‡
                    this.totalBricks = this.wholeBricks + this.widthRemainingBricks + this.heightRemainingBricks - this.cornerBricks;
                    
                    console.log(`æ•´æ•°åˆ—: ${this.widthIntegerColumns}Ã—${this.heightIntegerColumns}`);
                    console.log(`å‰©ä½™å°ºå¯¸: ${this.remainingWidth}Ã—${this.remainingHeight}mm`);
                    console.log(`æ•´ç –: ${this.wholeBricks}, å®½åº¦å‰©ä½™: ${this.widthRemainingBricks}, é«˜åº¦å‰©ä½™: ${this.heightRemainingBricks}, è§’è½: ${this.cornerBricks}`);
                    console.log(`æ€»ç”¨ç –é‡: ${this.totalBricks}`);
                }
                
                /**
                 * è®¡ç®—æŸ±å­ç –å—æ•°é‡
                 */
                calculateColumnBricks() {
                    console.log(`æŸ±å­å°ºå¯¸: ${this.columnWidth}Ã—${this.columnWidth}Ã—${this.columnHeight}mm`);
                    console.log(`ç –å—å°ºå¯¸: ${this.brickLength}Ã—${this.brickWidth}mm`);
                    
                    // æŸ±å­æœ‰4ä¸ªé¢
                    const columnPerimeter = this.columnWidth * 4;
                    
                    // è®¡ç®—é«˜åº¦æ–¹å‘çš„æ•´æ•°å±‚
                    this.heightIntegerColumns = Math.floor(this.columnHeight / this.brickLength);
                    
                    // è®¡ç®—å‘¨é•¿æ–¹å‘çš„æ•´æ•°å—
                    this.widthIntegerColumns = Math.floor(columnPerimeter / this.brickWidth);
                    
                    // è®¡ç®—å‰©ä½™å°ºå¯¸
                    this.remainingWidth = columnPerimeter - this.widthIntegerColumns * this.brickWidth;
                    this.remainingHeight = this.columnHeight - this.heightIntegerColumns * this.brickLength;
                    
                    // è®¡ç®—å„åŒºåŸŸç –å—æ•°é‡
                    this.wholeBricks = this.widthIntegerColumns * this.heightIntegerColumns;
                    
                    // å®½åº¦å‰©ä½™åŒºåŸŸç”¨ç –é‡
                    this.widthRemainingBricks = 0;
                    if (this.remainingWidth > 0) {
                        this.widthRemainingBricks = this.heightIntegerColumns + 1;
                    }
                    
                    // é«˜åº¦å‰©ä½™åŒºåŸŸç”¨ç –é‡
                    this.heightRemainingBricks = 0;
                    if (this.remainingHeight > 0) {
                        this.heightRemainingBricks = this.widthIntegerColumns + 1;
                    }
                    
                    // è§’è½åŒºåŸŸç”¨ç –é‡
                    this.cornerBricks = 0;
                    if (this.remainingWidth > 0 && this.remainingHeight > 0) {
                        this.cornerBricks = 1;
                    }
                    
                    // è®¡ç®—æ€»ç”¨ç –é‡
                    this.totalBricks = this.wholeBricks + this.widthRemainingBricks + this.heightRemainingBricks - this.cornerBricks;
                    
                    console.log(`å‘¨é•¿: ${columnPerimeter}mm, é«˜åº¦æ•´æ•°å±‚: ${this.heightIntegerColumns}`);
                    console.log(`å‰©ä½™å°ºå¯¸: å‘¨é•¿å‰©ä½™${this.remainingWidth}mm, é«˜åº¦å‰©ä½™${this.remainingHeight}mm`);
                    console.log(`æ•´ç –: ${this.wholeBricks}, å‘¨é•¿å‰©ä½™: ${this.widthRemainingBricks}, é«˜åº¦å‰©ä½™: ${this.heightRemainingBricks}, è§’è½: ${this.cornerBricks}`);
                    console.log(`æ€»ç”¨ç –é‡: ${this.totalBricks}`);
                }
                
                /**
                 * è®¡ç®—æ¥¼æ¢¯ç –å—æ•°é‡
                 */
                calculateStairBricks() {
                    console.log(`æ¥¼æ¢¯å°ºå¯¸: é•¿åº¦${this.stairLength}mm, å®½åº¦${this.stairWidth}mm`);
                    console.log(`ç –å—å°ºå¯¸: ${this.brickLength}Ã—${this.brickWidth}mm`);
                    
                    // æ¥¼æ¢¯é€šå¸¸æŒ‰æ°´å¹³æŠ•å½±é¢ç§¯è®¡ç®—ï¼Œé¢å¤–å¢åŠ 20%çš„æŸè€—
                    const stairArea = this.stairLength * this.stairWidth;
                    const brickArea = this.brickLength * this.brickWidth;
                    constæŸè€—ç³»æ•° = 1.2; // 20%æŸè€—
                    
                    // è®¡ç®—ç†è®ºç”¨ç –é‡
                    const theoreticalBricks = stairArea / brickArea;
                    
                    // è®¡ç®—å®é™…ç”¨ç –é‡ï¼ˆå‘ä¸Šå–æ•´å¹¶è€ƒè™‘æŸè€—ï¼‰
                    this.totalBricks = Math.ceil(theoreticalBricks * æŸè€—ç³»æ•°);
                    
                    // ç®€åŒ–æ˜¾ç¤ºï¼Œå°†æ€»ç”¨ç –é‡åˆ†é…åˆ°å„ä¸ªåŒºåŸŸ
                    this.wholeBricks = Math.floor(this.totalBricks * 0.8); // 80%ä¸ºæ•´ç –
                    this.widthRemainingBricks = Math.floor(this.totalBricks * 0.15); // 15%ä¸ºåˆ‡å‰²ç –
                    this.heightRemainingBricks = this.totalBricks - this.wholeBricks - this.widthRemainingBricks;
                    this.cornerBricks = 0;
                    
                    this.widthIntegerColumns = Math.floor(this.stairLength / this.brickWidth);
                    this.heightIntegerColumns = Math.floor(this.stairWidth / this.brickLength);
                    this.remainingWidth = this.stairLength % this.brickWidth;
                    this.remainingHeight = this.stairWidth % this.brickLength;
                    
                    console.log(`æ¥¼æ¢¯é¢ç§¯: ${stairArea}mmÂ², ç –å—é¢ç§¯: ${brickArea}mmÂ²`);
                    console.log(`ç†è®ºç”¨ç –é‡: ${theoreticalBricks.toFixed(2)}, è€ƒè™‘æŸè€—å: ${this.totalBricks}`);
                    console.log(`æ•´ç –: ${this.wholeBricks}, åˆ‡å‰²ç –: ${this.widthRemainingBricks + this.heightRemainingBricks}`);
                }
                
                /**
                 * æ›´æ–°UIæ˜¾ç¤º
                 */
                updateUI() {
                    // æ›´æ–°è®¡ç®—ç»“æœ
                    const wholeBricksElement = document.getElementById('whole-bricks');
                    const wholeBricksDetailElement = document.getElementById('whole-bricks-detail');
                    const widthRemainingBricksElement = document.getElementById('width-remaining-bricks');
                    const widthRemainingDetailElement = document.getElementById('width-remaining-detail');
                    const heightRemainingBricksElement = document.getElementById('height-remaining-bricks');
                    const heightRemainingDetailElement = document.getElementById('height-remaining-detail');
                    const totalBricksElement = document.getElementById('total-bricks');
                    const totalBricksDetailElement = document.getElementById('total-bricks-detail');
                    
                    if (wholeBricksElement) wholeBricksElement.textContent = this.wholeBricks;
                    if (wholeBricksDetailElement) wholeBricksDetailElement.textContent = `${this.widthIntegerColumns}Ã—${this.heightIntegerColumns} ç‰‡`;
                    
                    if (widthRemainingBricksElement) widthRemainingBricksElement.textContent = this.widthRemainingBricks;
                    if (widthRemainingDetailElement) widthRemainingDetailElement.textContent = `${this.remainingWidth > 0 ? this.heightIntegerColumns + 1 : 0} ç‰‡`;
                    
                    if (heightRemainingBricksElement) heightRemainingBricksElement.textContent = this.heightRemainingBricks;
                    if (heightRemainingDetailElement) heightRemainingDetailElement.textContent = `${this.remainingHeight > 0 ? this.widthIntegerColumns + 1 : 0} ç‰‡`;
                    
                    if (totalBricksElement) totalBricksElement.textContent = this.totalBricks;
                    if (totalBricksDetailElement) totalBricksDetailElement.textContent = `${this.totalBricks} ç‰‡`;
                    
                    // æ›´æ–°è®¡ç®—æ­¥éª¤
                    this.updateCalculationSteps();
                }
                
                /**
                 * æ›´æ–°è®¡ç®—æ­¥éª¤
                 */
                updateCalculationSteps() {
                    const stepsContainer = document.getElementById('calculation-steps');
                    if (!stepsContainer) return;
                    
                    const steps = [
                        `<p><strong>æ­¥éª¤1ï¼š</strong>è®¡ç®—æ•´æ•°åˆ—</p>`,
                        `<p class="pl-4">å¢™é¢å®½åº¦Ã·ç“·ç –å®½åº¦ = ${this.wallWidth}Ã·${this.brickWidth} = ${(this.wallWidth/this.brickWidth).toFixed(4)} â†’ å‘ä¸‹å–æ•´ä¸º ${this.widthIntegerColumns} åˆ—</p>`,
                        `<p class="pl-4">å¢™é¢é«˜åº¦Ã·ç“·ç –é«˜åº¦ = ${this.wallHeight}Ã·${this.brickLength} = ${(this.wallHeight/this.brickLength).toFixed(4)} â†’ å‘ä¸‹å–æ•´ä¸º ${this.heightIntegerColumns} åˆ—</p>`,
                        `<p><strong>æ­¥éª¤2ï¼š</strong>è®¡ç®—å‰©ä½™æœªé“ºè´´å°ºå¯¸</p>`,
                        `<p class="pl-4">å‰©ä½™æœªé“ºè´´å®½åº¦ = ${this.wallWidth} - ${this.widthIntegerColumns}Ã—${this.brickWidth} = ${this.remainingWidth}mm</p>`,
                        `<p class="pl-4">å‰©ä½™æœªé“ºè´´é«˜åº¦ = ${this.wallHeight} - ${this.heightIntegerColumns}Ã—${this.brickLength} = ${this.remainingHeight}mm</p>`,
                        `<p><strong>æ­¥éª¤3ï¼š</strong>è®¡ç®—å„åŒºåŸŸç”¨ç –é‡</p>`,
                        `<p class="pl-4">æ•´ç –åŒºåŸŸç”¨ç – = ${this.widthIntegerColumns}Ã—${this.heightIntegerColumns} = ${this.wholeBricks}ç‰‡</p>`,
                    ];
                    
                    if (this.remainingWidth > 0) {
                        steps.push(`<p class="pl-4">å®½åº¦å‰©ä½™åŒºåŸŸç”¨ç – = ${this.heightIntegerColumns} + 1 = ${this.widthRemainingBricks}ç‰‡ï¼ˆè¦†ç›–æ•´ä¸ªå¢™é¢é«˜åº¦ï¼‰</p>`);
                    }
                    
                    if (this.remainingHeight > 0) {
                        steps.push(`<p class="pl-4">é«˜åº¦å‰©ä½™åŒºåŸŸç”¨ç – = ${this.widthIntegerColumns} + 1 = ${this.heightRemainingBricks}ç‰‡ï¼ˆè¦†ç›–æ•´ä¸ªå¢™é¢å®½åº¦ï¼‰</p>`);
                    }
                    
                    if (this.remainingWidth > 0 && this.remainingHeight > 0) {
                        steps.push(`<p class="pl-4">è§’è½åŒºåŸŸé‡å¤è®¡ç®—ï¼Œéœ€è¦å‡å» = ${this.cornerBricks}ç‰‡</p>`);
                    }
                    
                    steps.push(`<p><strong>æ­¥éª¤4ï¼š</strong>è®¡ç®—æ€»ç”¨ç –é‡</p>`);
                    
                    let totalFormula = `${this.wholeBricks}`;
                    if (this.remainingWidth > 0) totalFormula += ` + ${this.widthRemainingBricks}`;
                    if (this.remainingHeight > 0) totalFormula += ` + ${this.heightRemainingBricks}`;
                    if (this.cornerBricks > 0) totalFormula += ` - ${this.cornerBricks}`;
                    
                    steps.push(`<p class="pl-4">æ€»ç”¨ç –é‡ = ${totalFormula} = ${this.totalBricks}ç‰‡</p>`);
                    
                    stepsContainer.innerHTML = steps.join('');
                }
                
                /**
                 * ç»˜åˆ¶å¹³é¢å›¾
                 */
                drawPlanarView() {
                    const container = document.getElementById('brick-planar-container');
                    if (!container) {
                        console.error('å¹³é¢å›¾å®¹å™¨ä¸å­˜åœ¨!');
                        return;
                    }
                    
                    console.log('=== å¼€å§‹ç»˜åˆ¶å¹³é¢å›¾ ===');
                    console.log(`å¢™ä½“å°ºå¯¸: ${this.wallWidth}Ã—${this.wallHeight}mm`);
                    console.log(`ç –å—å°ºå¯¸: ${this.brickLength}Ã—${this.brickWidth}mm`);
                    
                    // æ¸…ç©ºå®¹å™¨å¹¶è®¾ç½®åŸºç¡€æ ·å¼
                    container.innerHTML = '';
                    container.style.position = 'relative';
                    container.style.width = '500px';
                    container.style.height = '500px';
                    container.style.border = '2px solid #607d8b';
                    container.style.backgroundColor = '#f9fafb';
                    container.style.margin = '0 auto';
                    container.style.boxSizing = 'border-box';
                    
                    // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
                    const maxDimension = Math.max(this.wallWidth, this.wallHeight);
                    const scale = 450 / maxDimension; // ä½¿ç”¨450pxä½œä¸ºå¯ç”¨ç©ºé—´
                    
                    console.log(`ç¼©æ”¾æ¯”ä¾‹: ${scale}`);
                    
                    // ç»˜åˆ¶å¢™ä½“è¾¹æ¡†
                    const wallWidth = this.wallWidth * scale;
                    const wallHeight = this.wallHeight * scale;
                    
                    // ç»˜åˆ¶ç –å—
                    const brickWidth = this.brickWidth * scale;
                    const brickLength = this.brickLength * scale;
                    
                    console.log(`ç –å—ç¼©æ”¾åå°ºå¯¸: ${brickWidth}Ã—${brickLength}px`);
                    
                    let brickNumber = 1;
                    
                    // ç»˜åˆ¶æ•´ç –åŒºåŸŸ
                    for (let row = 0; row < Math.floor(this.wallHeight / this.brickLength); row++) {
                        for (let col = 0; col < Math.floor(this.wallWidth / this.brickWidth); col++) {
                            const brick = document.createElement('div');
                            brick.style.position = 'absolute';
                            brick.style.left = `${col * brickWidth}px`;
                            brick.style.top = `${row * brickLength}px`;
                            brick.style.width = `${brickWidth}px`;
                            brick.style.height = `${brickLength}px`;
                            brick.style.backgroundColor = '#fff9c4';
                            brick.style.border = '1px solid #ffd54f';
                            brick.style.display = 'flex';
                            brick.style.alignItems = 'center';
                            brick.style.justifyContent = 'center';
                            brick.style.fontSize = '12px';
                            brick.style.fontWeight = 'bold';
                            brick.style.color = '#333';
                            brick.style.boxSizing = 'border-box';
                            brick.textContent = brickNumber++;
                            
                            container.appendChild(brick);
                        }
                    }
                    
                    console.log('å¹³é¢å›¾ç»˜åˆ¶å®Œæˆ');
                    
                    // ç»˜åˆ¶å¢™ä½“è¾¹æ¡†
                    this.drawWallBorder(scaledWidth, scaledHeight);
                    
                    // ç»˜åˆ¶å°ºå¯¸æ ‡æ³¨
                    this.drawDimensions(scaledWidth, scaledHeight);
                    
                    // ç»˜åˆ¶ç –å—
                    this.drawBricks(scaledWidth, scaledHeight);
                }
                
                /**
                 * ç»˜åˆ¶å¢™ä½“è¾¹æ¡†
                 */
                drawWallBorder(width, height) {
                    const container = document.getElementById('brick-planar-container');
                    if (!container) return;
                    
                    const border = document.createElement('div');
                    border.className = 'absolute inset-0 border-2 border-dark-3';
                    border.style.width = `${width}px`;
                    border.style.height = `${height}px`;
                    
                    container.appendChild(border);
                }
                
                /**
                 * ç»˜åˆ¶å°ºå¯¸æ ‡æ³¨
                 */
                drawDimensions(width, height) {
                    const container = document.getElementById('brick-planar-container');
                    if (!container) return;
                    
                    // å®½åº¦æ ‡æ³¨
                    const widthLabel = document.createElement('div');
                    widthLabel.className = 'absolute text-sm text-dark-3 -bottom-6 left-1/2 transform -translate-x-1/2';
                    widthLabel.textContent = `${this.wallWidth}mm`;
                    container.appendChild(widthLabel);
                    
                    // é«˜åº¦æ ‡æ³¨
                    const heightLabel = document.createElement('div');
                    heightLabel.className = 'absolute text-sm text-dark-3 -left-12 top-1/2 transform -translate-y-1/2 rotate-270';
                    heightLabel.textContent = `${this.wallHeight}mm`;
                    container.appendChild(heightLabel);
                    
                    // ç –å—å°ºå¯¸æ ‡æ³¨
                    const brickLabel = document.createElement('div');
                    brickLabel.className = 'absolute text-xs text-dark-3 top-2 left-2 bg-white/80 px-2 py-1 rounded';
                    brickLabel.textContent = `ç –å—å°ºå¯¸: ${this.brickLength}Ã—${this.brickWidth}mm`;
                    container.appendChild(brickLabel);
                    
                    // æ·»åŠ é«˜åº¦æ•°å­—æ ‡æ³¨
                    const heightNumbers = document.createElement('div');
                    heightNumbers.className = 'absolute left-[-30px] top-0 h-full flex flex-col justify-between';
                    heightNumbers.innerHTML = `
                        <div class="text-xs text-dark-3">${this.wallHeight}</div>
                        <div class="text-xs text-dark-3">0</div>
                    `;
                    container.appendChild(heightNumbers);
                    
                    // æ·»åŠ å®½åº¦æ•°å­—æ ‡æ³¨
                    const widthNumbers = document.createElement('div');
                    widthNumbers.className = 'absolute bottom-[-20px] left-0 w-full flex justify-between';
                    widthNumbers.innerHTML = `
                        <div class="text-xs text-dark-3">0</div>
                        <div class="text-xs text-dark-3">${this.wallWidth}</div>
                    `;
                    container.appendChild(widthNumbers);
                }
                
                /**
                 * ç»˜åˆ¶ç –å—
                 */
                drawBricks(width, height) {
                    const container = document.getElementById('brick-planar-container');
                    if (!container) return;
                    
                    const scaledBrickWidth = this.brickWidth * this.scale;
                    const scaledBrickLength = this.brickLength * this.scale;
                    
                    let brickNumber = 1;
                    
                    // ç»˜åˆ¶æ•´ç –åŒºåŸŸ
                    for (let row = 0; row < this.heightIntegerColumns; row++) {
                        for (let col = 0; col < this.widthIntegerColumns; col++) {
                            const brick = this.createBrick(
                                col * scaledBrickWidth,
                                row * scaledBrickLength,
                                scaledBrickWidth,
                                scaledBrickLength,
                                brickNumber++,
                                'whole'
                            );
                            container.appendChild(brick);
                        }
                    }
                    
                    // ç»˜åˆ¶å®½åº¦å‰©ä½™åŒºåŸŸ
                    if (this.remainingWidth > 0) {
                        const remainingWidthScaled = this.remainingWidth * this.scale;
                        
                        for (let row = 0; row < this.heightIntegerColumns; row++) {
                            const brick = this.createBrick(
                                this.widthIntegerColumns * scaledBrickWidth,
                                row * scaledBrickLength,
                                remainingWidthScaled,
                                scaledBrickLength,
                                brickNumber++,
                                'width-remaining'
                            );
                            container.appendChild(brick);
                        }
                        
                        // æœ€åä¸€è¡Œ
                        if (this.remainingHeight > 0) {
                            const brick = this.createBrick(
                                this.widthIntegerColumns * scaledBrickWidth,
                                this.heightIntegerColumns * scaledBrickLength,
                                remainingWidthScaled,
                                this.remainingHeight * this.scale,
                                brickNumber++,
                                'corner'
                            );
                            container.appendChild(brick);
                        }
                    }
                    
                    // ç»˜åˆ¶é«˜åº¦å‰©ä½™åŒºåŸŸ
                    if (this.remainingHeight > 0) {
                        const remainingHeightScaled = this.remainingHeight * this.scale;
                        
                        for (let col = 0; col < this.widthIntegerColumns; col++) {
                            const brick = this.createBrick(
                                col * scaledBrickWidth,
                                this.heightIntegerColumns * scaledBrickLength,
                                scaledBrickWidth,
                                remainingHeightScaled,
                                brickNumber++,
                                'height-remaining'
                            );
                            container.appendChild(brick);
                        }
                    }
                }
                
                /**
                 * åˆ›å»ºç –å—å…ƒç´ 
                 */
                createBrick(x, y, width, height, number, type) {
                    const brick = document.createElement('div');
                    brick.className = `absolute brick flex items-center justify-center text-sm font-medium`;
                    brick.style.left = `${x}px`;
                    brick.style.top = `${y}px`;
                    brick.style.width = `${width}px`;
                    brick.style.height = `${height}px`;
                    brick.style.boxSizing = 'border-box';
                    
                    // æ ¹æ®ç –å—ç±»å‹è®¾ç½®æ ·å¼
                    switch (type) {
                        case 'whole':
                            brick.classList.add('bg-yellow-100', 'border', 'border-yellow-300');
                            break;
                        case 'width-remaining':
                            brick.classList.add('bg-blue-100', 'border', 'border-blue-300');
                            break;
                        case 'height-remaining':
                            brick.classList.add('bg-green-100', 'border', 'border-green-300');
                            break;
                        case 'corner':
                            brick.classList.add('bg-purple-100', 'border', 'border-purple-300');
                            break;
                    }
                    
                    // æ·»åŠ ç –å—ç¼–å·
                    brick.textContent = number;
                    
                    // æ·»åŠ æ‚¬åœæç¤º
                    brick.title = `${type} - ${Math.round(width/this.scale)}Ã—${Math.round(height/this.scale)}mm`;
                    
                    return brick;
                }
            }
            
            // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–è®¡ç®—å™¨
            document.addEventListener('DOMContentLoaded', () => {
                console.log('=== DOMåŠ è½½å®Œæˆï¼Œå‡†å¤‡åˆå§‹åŒ–è®¡ç®—å™¨ ===');
                
                // æ£€æŸ¥å…³é”®DOMå…ƒç´ æ˜¯å¦å­˜åœ¨
                const planarContainer = document.getElementById('brick-planar-container');
                const calculateBtn = document.getElementById('calculate-btn');
                const testDrawBtn = document.getElementById('test-draw-btn');
                
                console.log('å¹³é¢å›¾å®¹å™¨å­˜åœ¨:', !!planarContainer);
                console.log('è®¡ç®—æŒ‰é’®å­˜åœ¨:', !!calculateBtn);
                console.log('æµ‹è¯•æŒ‰é’®å­˜åœ¨:', !!testDrawBtn);
                
                // ç›´æ¥åˆå§‹åŒ–è®¡ç®—å™¨ï¼Œä¸éœ€è¦æ£€æŸ¥calculator-container
                if (planarContainer && calculateBtn) {
                    const calculator = new PlanarBrickCalculator();
                    console.log('å¹³é¢å›¾ç®—ç –è®¡ç®—å™¨å·²åˆå§‹åŒ–');
                    
                    // ä¸ºæµ‹è¯•æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                    if (testDrawBtn) {
                        testDrawBtn.addEventListener('click', () => {
                            console.log('=== ç‚¹å‡»æµ‹è¯•ç»˜åˆ¶æŒ‰é’® ===');
                            
                            // æ¸…ç©ºå®¹å™¨
                            planarContainer.innerHTML = '';
                            
                            // è®¾ç½®å®¹å™¨æ ·å¼
                            planarContainer.style.width = '500px';
                            planarContainer.style.height = '500px';
                            planarContainer.style.border = '1px solid #e5e7eb';
                            planarContainer.style.backgroundColor = '#f9fafb';
                            
                            // ç›´æ¥ç»˜åˆ¶æµ‹è¯•ç –å—
                            for (let i = 0; i < 3; i++) {
                                for (let j = 0; j < 3; j++) {
                                    const testBrick = document.createElement('div');
                                    testBrick.className = 'absolute brick flex items-center justify-center text-sm font-medium bg-yellow-100 border border-yellow-300';
                                    testBrick.style.left = `${i * 60 + 10}px`;
                                    testBrick.style.top = `${j * 60 + 10}px`;
                                    testBrick.style.width = '50px';
                                    testBrick.style.height = '50px';
                                    testBrick.textContent = `${i}-${j}`;
                                    planarContainer.appendChild(testBrick);
                                }
                            }
                            
                            console.log('æµ‹è¯•ç –å—ç»˜åˆ¶å®Œæˆ');
                        });
                    }
                    
                    // æ‰‹åŠ¨è§¦å‘ä¸€æ¬¡è®¡ç®—ï¼Œç¡®ä¿å¹³é¢å›¾æ˜¾ç¤º
                    setTimeout(() => {
                        console.log('æ‰‹åŠ¨è§¦å‘è®¡ç®—...');
                        calculator.calculate();
                    }, 100);
                }
            });
            
            // ä¿å­˜è®¡ç®—ç»“æœ

            
            // ç¡®è®¤å¯¹è¯æ¡†æŒ‰é’®äº‹ä»¶å·²åœ¨showConfirmDialogå‡½æ•°ä¸­å¤„ç†
            
            // å…³é—­é€šçŸ¥
            document.getElementById('close-notification').addEventListener('click', () => {
                document.getElementById('notification').classList.add('hidden');
            });
            
            // æ•°æ®ç®¡ç† - å­˜å‚¨æ¨¡å¼åˆ‡æ¢
            document.querySelectorAll('input[name="storage-mode"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const supabaseConfig = document.getElementById('supabase-config');
                    if (this.id === 'supabase-storage') {
                        supabaseConfig.classList.remove('hidden');
                    } else {
                        supabaseConfig.classList.add('hidden');
                    }
                });
            });
            
            // åˆå§‹åŒ–å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½
            // ç¼–è¾‘äº§å“å›¾ç‰‡ä¸Šä¼ 
            document.getElementById('edit-product-image-upload').addEventListener('click', function() {
                document.getElementById('edit-product-image-input').click();
            });
            
            // ç¼–è¾‘äº§å“å›¾ç‰‡é¢„è§ˆå’Œåˆ é™¤ - å®Œå…¨é‡å†™ç‰ˆæœ¬
            document.getElementById('edit-product-image-input').addEventListener('change', function(e) {
                console.log('=== ç¼–è¾‘äº§å“å›¾ç‰‡é€‰æ‹©äº‹ä»¶å¼€å§‹ ===');
                
                // æ¸…ç©ºä¹‹å‰çš„é¢„è§ˆ
                const preview = document.getElementById('edit-product-image-preview');
                const previewImg = document.getElementById('edit-preview-img');
                const uploadArea = document.getElementById('edit-product-image-upload');
                
                if (!e.target.files || e.target.files.length === 0) {
                    console.log('æœªé€‰æ‹©æ–‡ä»¶');
                    if (preview) preview.classList.add('hidden');
                    if (uploadArea) uploadArea.classList.remove('hidden');
                    if (previewImg) previewImg.src = '';
                    console.log('=== ç¼–è¾‘äº§å“å›¾ç‰‡é€‰æ‹©äº‹ä»¶ç»“æŸ (æ— æ–‡ä»¶) ===');
                    return;
                }
                
                const file = e.target.files[0];
                console.log('é€‰æ‹©çš„æ–‡ä»¶:', { name: file.name, size: file.size, type: file.type });
                
                // éªŒè¯æ–‡ä»¶ç±»å‹
                const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                if (!validTypes.includes(file.type)) {
                    console.error('æ–‡ä»¶ç±»å‹ä¸æ”¯æŒ:', file.type);
                    showNotification('ä¸Šä¼ å¤±è´¥', 'åªæ”¯æŒJPGã€PNGã€GIFå’ŒWebPæ ¼å¼çš„å›¾ç‰‡', 'error');
                    e.target.value = '';
                    console.log('=== ç¼–è¾‘äº§å“å›¾ç‰‡é€‰æ‹©äº‹ä»¶ç»“æŸ (ç±»å‹é”™è¯¯) ===');
                    return;
                }
                
                // éªŒè¯æ–‡ä»¶å¤§å° (5MBé™åˆ¶)
                const maxSize = 5 * 1024 * 1024;
                if (file.size > maxSize) {
                    console.error('æ–‡ä»¶å¤§å°è¶…é™:', file.size, '> 5MB');
                    showNotification('ä¸Šä¼ å¤±è´¥', 'å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MB', 'error');
                    e.target.value = '';
                    console.log('=== ç¼–è¾‘äº§å“å›¾ç‰‡é€‰æ‹©äº‹ä»¶ç»“æŸ (å¤§å°è¶…é™) ===');
                    return;
                }
                
                // åˆ›å»ºæ–‡ä»¶è¯»å–å™¨
                const reader = new FileReader();
                
                reader.onloadstart = function() {
                    console.log('å¼€å§‹è¯»å–æ–‡ä»¶...');
                };
                
                reader.onprogress = function(event) {
                    if (event.lengthComputable) {
                        const percent = Math.round((event.loaded / event.total) * 100);
                        console.log(`æ–‡ä»¶è¯»å–è¿›åº¦: ${percent}%`);
                    }
                };
                
                reader.onload = function(e) {
                    try {
                        console.log('æ–‡ä»¶è¯»å–å®Œæˆ');
                        
                        if (!e.target.result) {
                            throw new Error('æ–‡ä»¶è¯»å–ç»“æœä¸ºç©º');
                        }
                        
                        // éªŒè¯æ•°æ®URLæ ¼å¼
                        if (typeof e.target.result !== 'string' || !e.target.result.startsWith('data:image/')) {
                            throw new Error('æ— æ•ˆçš„æ•°æ®URLæ ¼å¼');
                        }
                        
                        console.log('æ•°æ®URLæ ¼å¼æ­£ç¡®ï¼Œé•¿åº¦:', e.target.result.length);
                        
                        // ç¡®ä¿é¢„è§ˆå…ƒç´ å­˜åœ¨
                        if (!preview || !previewImg || !uploadArea) {
                            throw new Error('é¢„è§ˆç›¸å…³å…ƒç´ ä¸å­˜åœ¨');
                        }
                        
                        // å¼ºåˆ¶é‡ç½®é¢„è§ˆçŠ¶æ€
                        previewImg.src = '';
                        preview.classList.add('hidden');
                        
                        // ä½¿ç”¨Imageå¯¹è±¡é¢„åŠ è½½å›¾ç‰‡ï¼ŒéªŒè¯æ•°æ®æœ‰æ•ˆæ€§
                        const tempImage = new Image();
                        
                        tempImage.onload = function() {
                            try {
                                console.log('ä¸´æ—¶å›¾ç‰‡éªŒè¯æˆåŠŸï¼Œå°ºå¯¸:', tempImage.width, 'x', tempImage.height);
                                
                                // å›¾ç‰‡éªŒè¯é€šè¿‡ï¼Œè®¾ç½®åˆ°é¢„è§ˆ
                                previewImg.src = e.target.result;
                                preview.classList.remove('hidden');
                                uploadArea.classList.add('hidden');
                                
                                console.log('é¢„è§ˆæ˜¾ç¤ºæˆåŠŸ');
                                console.log('=== ç¼–è¾‘äº§å“å›¾ç‰‡é€‰æ‹©äº‹ä»¶ç»“æŸ (æˆåŠŸ) ===');
                            } catch (imgError) {
                                console.error('è®¾ç½®é¢„è§ˆæ—¶å‡ºé”™:', imgError);
                                showNotification('é¢„è§ˆå¤±è´¥', 'å›¾ç‰‡è®¾ç½®å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                                e.target.value = '';
                                console.log('=== ç¼–è¾‘äº§å“å›¾ç‰‡é€‰æ‹©äº‹ä»¶ç»“æŸ (è®¾ç½®å¤±è´¥) ===');
                            }
                        };
                        
                        tempImage.onerror = function() {
                            console.error('ä¸´æ—¶å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œæ•°æ®URLæ— æ•ˆ');
                            showNotification('é¢„è§ˆå¤±è´¥', 'å›¾ç‰‡æ•°æ®æŸåæˆ–æ ¼å¼é”™è¯¯', 'error');
                            e.target.value = '';
                            console.log('=== ç¼–è¾‘äº§å“å›¾ç‰‡é€‰æ‹©äº‹ä»¶ç»“æŸ (æ•°æ®æ— æ•ˆ) ===');
                        };
                        
                        tempImage.src = e.target.result;
                        
                    } catch (readError) {
                        console.error('è¯»å–åå¤„ç†å‡ºé”™:', readError);
                        showNotification('å¤„ç†å¤±è´¥', 'å›¾ç‰‡å¤„ç†æ—¶å‘ç”Ÿé”™è¯¯', 'error');
                        e.target.value = '';
                        console.log('=== ç¼–è¾‘äº§å“å›¾ç‰‡é€‰æ‹©äº‹ä»¶ç»“æŸ (å¤„ç†é”™è¯¯) ===');
                    }
                };
                
                reader.onerror = function() {
                    console.error('æ–‡ä»¶è¯»å–å™¨é”™è¯¯');
                    showNotification('è¯»å–å¤±è´¥', 'æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                    e.target.value = '';
                    console.log('=== ç¼–è¾‘äº§å“å›¾ç‰‡é€‰æ‹©äº‹ä»¶ç»“æŸ (è¯»å–é”™è¯¯) ===');
                };
                
                reader.onabort = function() {
                    console.warn('æ–‡ä»¶è¯»å–è¢«ä¸­æ­¢');
                    console.log('=== ç¼–è¾‘äº§å“å›¾ç‰‡é€‰æ‹©äº‹ä»¶ç»“æŸ (å·²ä¸­æ­¢) ===');
                };
                
                // å¼€å§‹è¯»å–æ–‡ä»¶
                reader.readAsDataURL(file);
            });
            
            // åˆ é™¤å›¾ç‰‡
            document.getElementById('edit-remove-image').addEventListener('click', function() {
                console.log('=== ç‚¹å‡»åˆ é™¤å›¾ç‰‡æŒ‰é’® ===');
                
                const preview = document.getElementById('edit-product-image-preview');
                const previewImg = document.getElementById('edit-preview-img');
                const uploadArea = document.getElementById('edit-product-image-upload');
                const input = document.getElementById('edit-product-image-input');
                
                console.log('åˆ é™¤å›¾ç‰‡å‰çš„çŠ¶æ€:', {
                    previewExists: !!preview,
                    previewImgExists: !!previewImg,
                    uploadAreaExists: !!uploadArea,
                    inputExists: !!input
                });
                
                if (preview) preview.classList.add('hidden');
                if (uploadArea) uploadArea.classList.remove('hidden');
                if (previewImg) previewImg.src = '';
                if (input) input.value = '';
                
                console.log('=== å›¾ç‰‡åˆ é™¤å®Œæˆ ===');
            });
            
            // æ·»åŠ äº§å“å›¾ç‰‡ä¸Šä¼ é¢„è§ˆ
            document.getElementById('product-image-upload').addEventListener('click', function() {
                document.getElementById('product-image').click();
            });
            
            // äº§å“å›¾ç‰‡é¢„è§ˆ - å®Œå…¨é‡å†™ç‰ˆæœ¬
            document.getElementById('product-image').addEventListener('change', function(e) {
                console.log('=== äº§å“å›¾ç‰‡é€‰æ‹©äº‹ä»¶å¼€å§‹ ===');
                
                // æ¸…ç©ºä¹‹å‰çš„é¢„è§ˆ
                const preview = document.getElementById('product-image-preview');
                const previewImg = document.getElementById('preview-img');
                const uploadArea = document.getElementById('product-image-upload');
                
                if (!e.target.files || e.target.files.length === 0) {
                    console.log('æœªé€‰æ‹©æ–‡ä»¶');
                    if (preview) preview.classList.add('hidden');
                    if (uploadArea) uploadArea.classList.remove('hidden');
                    if (previewImg) previewImg.src = '';
                    console.log('=== äº§å“å›¾ç‰‡é€‰æ‹©äº‹ä»¶ç»“æŸ (æ— æ–‡ä»¶) ===');
                    return;
                }
                
                const file = e.target.files[0];
                console.log('é€‰æ‹©çš„æ–‡ä»¶:', { name: file.name, size: file.size, type: file.type });
                
                // éªŒè¯æ–‡ä»¶ç±»å‹
                const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                if (!validTypes.includes(file.type)) {
                    console.error('æ–‡ä»¶ç±»å‹ä¸æ”¯æŒ:', file.type);
                    showNotification('ä¸Šä¼ å¤±è´¥', 'åªæ”¯æŒJPGã€PNGã€GIFå’ŒWebPæ ¼å¼çš„å›¾ç‰‡', 'error');
                    e.target.value = '';
                    console.log('=== äº§å“å›¾ç‰‡é€‰æ‹©äº‹ä»¶ç»“æŸ (ç±»å‹é”™è¯¯) ===');
                    return;
                }
                
                // éªŒè¯æ–‡ä»¶å¤§å° (5MBé™åˆ¶)
                const maxSize = 5 * 1024 * 1024;
                if (file.size > maxSize) {
                    console.error('æ–‡ä»¶å¤§å°è¶…é™:', file.size, '> 5MB');
                    showNotification('ä¸Šä¼ å¤±è´¥', 'å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MB', 'error');
                    e.target.value = '';
                    console.log('=== äº§å“å›¾ç‰‡é€‰æ‹©äº‹ä»¶ç»“æŸ (å¤§å°è¶…é™) ===');
                    return;
                }
                
                // åˆ›å»ºæ–‡ä»¶è¯»å–å™¨
                const reader = new FileReader();
                
                reader.onloadstart = function() {
                    console.log('å¼€å§‹è¯»å–æ–‡ä»¶...');
                };
                
                reader.onprogress = function(event) {
                    if (event.lengthComputable) {
                        const percent = Math.round((event.loaded / event.total) * 100);
                        console.log(`æ–‡ä»¶è¯»å–è¿›åº¦: ${percent}%`);
                    }
                };
                
                reader.onload = function(e) {
                    try {
                        console.log('æ–‡ä»¶è¯»å–å®Œæˆ');
                        
                        if (!e.target.result) {
                            throw new Error('æ–‡ä»¶è¯»å–ç»“æœä¸ºç©º');
                        }
                        
                        // éªŒè¯æ•°æ®URLæ ¼å¼
                        if (typeof e.target.result !== 'string' || !e.target.result.startsWith('data:image/')) {
                            throw new Error('æ— æ•ˆçš„æ•°æ®URLæ ¼å¼');
                        }
                        
                        console.log('æ•°æ®URLæ ¼å¼æ­£ç¡®ï¼Œé•¿åº¦:', e.target.result.length);
                        
                        // ç¡®ä¿é¢„è§ˆå…ƒç´ å­˜åœ¨
                        if (!preview || !previewImg || !uploadArea) {
                            throw new Error('é¢„è§ˆç›¸å…³å…ƒç´ ä¸å­˜åœ¨');
                        }
                        
                        // å¼ºåˆ¶é‡ç½®é¢„è§ˆçŠ¶æ€
                        previewImg.src = '';
                        preview.classList.add('hidden');
                        
                        // ä½¿ç”¨Imageå¯¹è±¡é¢„åŠ è½½å›¾ç‰‡ï¼ŒéªŒè¯æ•°æ®æœ‰æ•ˆæ€§
                        const tempImage = new Image();
                        
                        tempImage.onload = function() {
                            try {
                                console.log('ä¸´æ—¶å›¾ç‰‡éªŒè¯æˆåŠŸï¼Œå°ºå¯¸:', tempImage.width, 'x', tempImage.height);
                                
                                // å›¾ç‰‡éªŒè¯é€šè¿‡ï¼Œè®¾ç½®åˆ°é¢„è§ˆ
                                previewImg.src = e.target.result;
                                preview.classList.remove('hidden');
                                uploadArea.classList.add('hidden');
                                
                                console.log('é¢„è§ˆæ˜¾ç¤ºæˆåŠŸ');
                                console.log('=== äº§å“å›¾ç‰‡é€‰æ‹©äº‹ä»¶ç»“æŸ (æˆåŠŸ) ===');
                            } catch (imgError) {
                                console.error('è®¾ç½®é¢„è§ˆæ—¶å‡ºé”™:', imgError);
                                showNotification('é¢„è§ˆå¤±è´¥', 'å›¾ç‰‡è®¾ç½®å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                                e.target.value = '';
                                console.log('=== äº§å“å›¾ç‰‡é€‰æ‹©äº‹ä»¶ç»“æŸ (è®¾ç½®å¤±è´¥) ===');
                            }
                        };
                        
                        tempImage.onerror = function() {
                            console.error('ä¸´æ—¶å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œæ•°æ®URLæ— æ•ˆ');
                            showNotification('é¢„è§ˆå¤±è´¥', 'å›¾ç‰‡æ•°æ®æŸåæˆ–æ ¼å¼é”™è¯¯', 'error');
                            e.target.value = '';
                            console.log('=== äº§å“å›¾ç‰‡é€‰æ‹©äº‹ä»¶ç»“æŸ (æ•°æ®æ— æ•ˆ) ===');
                        };
                        
                        tempImage.src = e.target.result;
                        
                    } catch (readError) {
                        console.error('è¯»å–åå¤„ç†å‡ºé”™:', readError);
                        showNotification('å¤„ç†å¤±è´¥', 'å›¾ç‰‡å¤„ç†æ—¶å‘ç”Ÿé”™è¯¯', 'error');
                        e.target.value = '';
                        console.log('=== äº§å“å›¾ç‰‡é€‰æ‹©äº‹ä»¶ç»“æŸ (å¤„ç†é”™è¯¯) ===');
                    }
                };
                
                reader.onerror = function() {
                    console.error('æ–‡ä»¶è¯»å–å™¨é”™è¯¯');
                    showNotification('è¯»å–å¤±è´¥', 'æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                    e.target.value = '';
                    console.log('=== äº§å“å›¾ç‰‡é€‰æ‹©äº‹ä»¶ç»“æŸ (è¯»å–é”™è¯¯) ===');
                };
                
                reader.onabort = function() {
                    console.warn('æ–‡ä»¶è¯»å–è¢«ä¸­æ­¢');
                    console.log('=== äº§å“å›¾ç‰‡é€‰æ‹©äº‹ä»¶ç»“æŸ (å·²ä¸­æ­¢) ===');
                };
                
                // å¼€å§‹è¯»å–æ–‡ä»¶
                reader.readAsDataURL(file);
            });
            
            // ç§»é™¤å›¾ç‰‡é¢„è§ˆ
            document.getElementById('remove-image')?.addEventListener('click', function() {
                const preview = document.getElementById('product-image-preview');
                const previewImg = document.getElementById('preview-img');
                const input = document.getElementById('product-image');
                const uploadArea = document.getElementById('product-image-upload');
                
                if (preview && previewImg && input && uploadArea) {
                    preview.classList.add('hidden');
                    previewImg.src = '';
                    input.value = '';
                    uploadArea.classList.remove('hidden');
                }
            });
            

            
            // å¯¼å‡ºäº§å“æ•°æ®
            document.getElementById('export-products').addEventListener('click', exportProductsData);
            
            // å¯¼å…¥äº§å“æ•°æ®
            document.getElementById('import-products').addEventListener('change', importProductsData);
            
            // å¯¼å‡ºäº§å“æ•°æ®CSVæ ¼å¼
            document.getElementById('export-products-csv').addEventListener('click', exportProductsCSV);
            
            // å¯¼å…¥äº§å“æ•°æ®CSVæ ¼å¼
            document.getElementById('import-products-csv').addEventListener('change', importProductsCSV);
            
            // æ¸…é™¤äº§å“æ•°æ®
            document.getElementById('clear-products').addEventListener('click', () => {
                showConfirmDialog(
                    'æ¸…é™¤äº§å“æ•°æ®',
                    'ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰äº§å“æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚',
                    clearProductsData
                );
            });
            
            // å¤–è§‚è®¾ç½®ç›¸å…³
            const backgroundImages = document.querySelectorAll('#appearance-settings .w-20.h-20');
            const themeColors = document.querySelectorAll('#appearance-settings .w-8.h-8.rounded-full');
            const darkModeToggle = document.getElementById('dark-mode');
            const customBgInput = document.querySelector('#appearance-settings input[type="file"]');
            
            // åˆå§‹åŒ–å¤–è§‚è®¾ç½®
            function initializeAppearanceSettings() {
                // ä»æœ¬åœ°å­˜å‚¨åŠ è½½è®¾ç½®
                const savedBackground = localStorage.getItem('appBackground') || 'bg1';
                const savedTheme = localStorage.getItem('appTheme') || 'primary';
                const savedDarkMode = localStorage.getItem('appDarkMode') === 'true';
                
                // åº”ç”¨èƒŒæ™¯è®¾ç½®
                if (savedBackground.startsWith('custom_')) {
                    document.body.style.backgroundImage = `url(${savedBackground.replace('custom_', '')})`;
                    document.body.classList.add('bg-cover', 'bg-fixed');
                    // é€‰ä¸­è‡ªå®šä¹‰èƒŒæ™¯
                    backgroundImages.forEach(img => {
                        img.classList.remove('border-primary');
                        img.classList.add('border-transparent');
                    });
                    backgroundImages[3].classList.remove('border-transparent');
                    backgroundImages[3].classList.add('border-primary');
                } else {
                    // åº”ç”¨é¢„è®¾èƒŒæ™¯
                    document.body.style.backgroundImage = `url(https://p3-doubao-search-sign.byteimg.com/labis/3b8cd2c2fd05d59389b2ed5987dedb0a~tplv-be4g95zd3a-image.jpeg?rk3s=542c0f93&x-expires=1779614257&x-signature=xgSti0O2TIPFM97%2FMa6r5EThjOs%3D)`;
                    document.body.classList.add('bg-cover', 'bg-fixed');
                    // é€‰ä¸­å¯¹åº”çš„èƒŒæ™¯
                    backgroundImages.forEach((img, index) => {
                        img.classList.remove('border-primary');
                        img.classList.add('border-transparent');
                        if (index < 3 && img.querySelector('img').src.includes(savedBackground)) {
                            img.classList.remove('border-transparent');
                            img.classList.add('border-primary');
                        }
                    });
                }
                
                // åº”ç”¨ä¸»é¢˜é¢œè‰²
                applyThemeColor(savedTheme);
                
                // åº”ç”¨æ·±è‰²æ¨¡å¼
                darkModeToggle.checked = savedDarkMode;
                if (savedDarkMode) {
                    document.body.classList.add('dark-mode');
                    document.body.classList.add('bg-dark-1', 'text-light-1');
                    document.body.classList.remove('bg-light');
                }
            }
            
            // åº”ç”¨ä¸»é¢˜é¢œè‰²
            function applyThemeColor(themeName) {
                // ç§»é™¤ç°æœ‰çš„ä¸»é¢˜ç±»
                document.body.classList.remove('theme-primary', 'theme-secondary', 'theme-success', 'theme-warning', 'theme-danger');
                // æ·»åŠ æ–°çš„ä¸»é¢˜ç±»
                document.body.classList.add(`theme-${themeName}`);
                
                // æ›´æ–°CSSå˜é‡
                const themeColors = {
                    primary: {
                        main: '#1e40af',
                        light: '#3b82f6',
                        dark: '#1e3a8a'
                    },
                    secondary: {
                        main: '#64748b',
                        light: '#94a3b8',
                        dark: '#475569'
                    },
                    success: {
                        main: '#059669',
                        light: '#10b981',
                        dark: '#047857'
                    },
                    warning: {
                        main: '#d97706',
                        light: '#f59e0b',
                        dark: '#b45309'
                    },
                    danger: {
                        main: '#dc2626',
                        light: '#ef4444',
                        dark: '#b91c1c'
                    }
                };
                
                if (themeColors[themeName]) {
                    document.documentElement.style.setProperty('--color-primary', themeColors[themeName].main);
                    document.documentElement.style.setProperty('--color-primary-light', themeColors[themeName].light);
                    document.documentElement.style.setProperty('--color-primary-dark', themeColors[themeName].dark);
                }
                
                // æ›´æ–°UIé€‰ä¸­çŠ¶æ€
                const colorElements = document.querySelectorAll('#appearance-settings .w-8.h-8.rounded-full');
                colorElements.forEach((color, index) => {
                    color.classList.remove('border-white');
                    color.classList.add('border-transparent');
                    if (index === 0 && themeName === 'primary') {
                        color.classList.remove('border-transparent');
                        color.classList.add('border-white');
                    } else if (index === 1 && themeName === 'secondary') {
                        color.classList.remove('border-transparent');
                        color.classList.add('border-white');
                    } else if (index === 2 && themeName === 'success') {
                        color.classList.remove('border-transparent');
                        color.classList.add('border-white');
                    } else if (index === 3 && themeName === 'warning') {
                        color.classList.remove('border-transparent');
                        color.classList.add('border-white');
                    } else if (index === 4 && themeName === 'danger') {
                        color.classList.remove('border-transparent');
                        color.classList.add('border-white');
                    }
                });
            }
            
            // èƒŒæ™¯é€‰æ‹©
            backgroundImages.forEach((img, index) => {
                img.addEventListener('click', function() {
                    if (index < 3) {
                        // é¢„è®¾èƒŒæ™¯
                        const bgName = `bg${index + 1}`;
                        document.body.style.backgroundImage = `url(https://p3-doubao-search-sign.byteimg.com/labis/3b8cd2c2fd05d59389b2ed5987dedb0a~tplv-be4g95zd3a-image.jpeg?rk3s=542c0f93&x-expires=1779614257&x-signature=xgSti0O2TIPFM97%2FMa6r5EThjOs%3D)`;
                        document.body.classList.add('bg-cover', 'bg-fixed');
                        localStorage.setItem('appBackground', bgName);
                    }
                    
                    // æ›´æ–°é€‰ä¸­çŠ¶æ€
                    backgroundImages.forEach(i => {
                        i.classList.remove('border-primary');
                        i.classList.add('border-transparent');
                    });
                    this.classList.remove('border-transparent');
                    this.classList.add('border-primary');
                });
            });
            
            // è‡ªå®šä¹‰èƒŒæ™¯ä¸Šä¼ 
            customBgInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const imgUrl = event.target.result;
                        document.body.style.backgroundImage = `url(${imgUrl})`;
                        document.body.classList.add('bg-cover', 'bg-fixed');
                        localStorage.setItem('appBackground', `custom_${imgUrl}`);
                        
                        // æ›´æ–°é€‰ä¸­çŠ¶æ€
                        backgroundImages.forEach(i => {
                            i.classList.remove('border-primary');
                            i.classList.add('border-transparent');
                        });
                        backgroundImages[3].classList.remove('border-transparent');
                        backgroundImages[3].classList.add('border-primary');
                        
                        showNotification('èƒŒæ™¯å·²æ›´æ–°', 'è‡ªå®šä¹‰èƒŒæ™¯å·²æˆåŠŸåº”ç”¨', 'success');
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // ä¸»é¢˜é¢œè‰²é€‰æ‹©
            themeColors.forEach((color, index) => {
                color.addEventListener('click', function() {
                    let themeName = 'primary';
                    switch(index) {
                        case 0: themeName = 'primary'; break;
                        case 1: themeName = 'secondary'; break;
                        case 2: themeName = 'success'; break;
                        case 3: themeName = 'warning'; break;
                        case 4: themeName = 'danger'; break;
                    }
                    
                    applyThemeColor(themeName);
                    localStorage.setItem('appTheme', themeName);
                });
            });
            
            // æ·±è‰²æ¨¡å¼åˆ‡æ¢
            darkModeToggle.addEventListener('change', function() {
                if (this.checked) {
                    document.body.classList.add('dark-mode');
                    document.body.classList.add('bg-dark-1', 'text-light-1');
                    document.body.classList.remove('bg-light');
                } else {
                    document.body.classList.remove('dark-mode');
                    document.body.classList.remove('bg-dark-1', 'text-light-1');
                    document.body.classList.add('bg-light');
                }
                localStorage.setItem('appDarkMode', this.checked.toString());
            });
            
            // ä¿å­˜è®¾ç½®
            document.getElementById('save-settings').addEventListener('click', function() {
                // è·å–å½“å‰è®¾ç½®
                const currentBg = document.body.style.backgroundImage || '';
                const currentTheme = document.body.classList.contains('theme-primary') ? 'primary' :
                                    document.body.classList.contains('theme-secondary') ? 'secondary' :
                                    document.body.classList.contains('theme-success') ? 'success' :
                                    document.body.classList.contains('theme-warning') ? 'warning' :
                                    document.body.classList.contains('theme-danger') ? 'danger' : 'primary';
                const currentDarkMode = document.getElementById('dark-mode').checked;
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem('appTheme', currentTheme);
                localStorage.setItem('appDarkMode', currentDarkMode.toString());
                
                showNotification('è®¾ç½®å·²ä¿å­˜', 'å¤–è§‚è®¾ç½®å·²æˆåŠŸä¿å­˜', 'success');
            });
            
            // æ¢å¤é»˜è®¤è®¾ç½®
            document.getElementById('reset-settings').addEventListener('click', function() {
                // é‡ç½®èƒŒæ™¯
                document.body.style.backgroundImage = 'url(https://p3-doubao-search-sign.byteimg.com/labis/3b8cd2c2fd05d59389b2ed5987dedb0a~tplv-be4g95zd3a-image.jpeg?rk3s=542c0f93&x-expires=1779614257&x-signature=xgSti0O2TIPFM97%2FMa6r5EThjOs%3D)';
                document.body.classList.add('bg-cover', 'bg-fixed');
                localStorage.setItem('appBackground', 'bg1');
                
                // é‡ç½®ä¸»é¢˜é¢œè‰²
                applyThemeColor('primary');
                localStorage.setItem('appTheme', 'primary');
                
                // é‡ç½®æ·±è‰²æ¨¡å¼
                darkModeToggle.checked = false;
                document.body.classList.remove('dark-mode', 'bg-dark-1', 'text-light-1');
                document.body.classList.add('bg-light');
                localStorage.setItem('appDarkMode', 'false');
                
                // æ›´æ–°UIé€‰ä¸­çŠ¶æ€
                backgroundImages.forEach((img, index) => {
                    img.classList.remove('border-primary');
                    img.classList.add('border-transparent');
                    if (index === 0) {
                        img.classList.remove('border-transparent');
                        img.classList.add('border-primary');
                    }
                });
                
                themeColors.forEach((color, index) => {
                    color.classList.remove('border-white');
                    color.classList.add('border-transparent');
                    if (index === 0) {
                        color.classList.remove('border-transparent');
                        color.classList.add('border-white');
                    }
                });
                
                showNotification('å·²æ¢å¤é»˜è®¤è®¾ç½®', 'å¤–è§‚è®¾ç½®å·²æ¢å¤ä¸ºé»˜è®¤å€¼', 'success');
            });
            
            // åˆå§‹åŒ–å¤–è§‚è®¾ç½®
            initializeAppearanceSettings();
        }
        
        // åˆ‡æ¢ä¾§è¾¹æ 
        // ä¾§è¾¹æ å·²ç§»é™¤ï¼Œæ— éœ€åˆ‡æ¢åŠŸèƒ½
        
        // åˆ‡æ¢ç”¨æˆ·èœå•
        function toggleUserMenu() {
            document.getElementById('user-menu').classList.toggle('hidden');
        }
        
        // åˆ‡æ¢ç§»åŠ¨ç«¯èœå•
        function toggleMobileMenu() {
            document.getElementById('mobile-nav').classList.toggle('hidden');
        }
        
        // åˆ‡æ¢ç§»åŠ¨ç«¯ç”¨æˆ·èœå•
        function toggleMobileUserMenu() {
            document.getElementById('mobile-user-menu').classList.toggle('hidden');
        }
        
        // å¤„ç†å›¾ç‰‡ä¸Šä¼ é¢„è§ˆ
        function handleImageUpload(inputId, previewId, uploadAreaId) {
            const input = document.getElementById(inputId);
            const preview = document.getElementById(previewId);
            const uploadArea = document.getElementById(uploadAreaId);
            const previewImg = preview.querySelector('img');
            
            input.addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        previewImg.src = e.target.result;
                        preview.classList.remove('hidden');
                        uploadArea.classList.add('hidden');
                    }
                    
                    reader.readAsDataURL(e.target.files[0]);
                }
            });
        }
        
        // å¤„ç†å›¾ç‰‡åˆ é™¤
        function handleImageRemove(removeBtnId, previewId, uploadAreaId, inputId) {
            const removeBtn = document.getElementById(removeBtnId);
            const preview = document.getElementById(previewId);
            const uploadArea = document.getElementById(uploadAreaId);
            const input = document.getElementById(inputId);
            
            removeBtn.addEventListener('click', function() {
                preview.classList.add('hidden');
                uploadArea.classList.remove('hidden');
                input.value = '';
            });
        }
        
        // æµ‹è¯•Supabaseè¿æ¥
        async function testSupabaseConnection() {
            const supabaseUrl = document.getElementById('supabase-url').value;
            const supabaseKey = document.getElementById('supabase-key').value;
            const statusElement = document.getElementById('supabase-status');
            
            if (!supabaseUrl || !supabaseKey) {
                showStatus(statusElement, 'è¯·å¡«å†™Supabase URLå’ŒAPI Key', 'error');
                return;
            }
            
            showStatus(statusElement, 'æ­£åœ¨æµ‹è¯•è¿æ¥...', 'info');
            
            try {
                // ä½¿ç”¨åŸºäºfetch APIçš„å®¢æˆ·ç«¯
                console.log('ğŸ” ä½¿ç”¨åŸºäºfetch APIçš„å®¢æˆ·ç«¯æµ‹è¯•è¿æ¥');
                
                // åˆ›å»ºå®¢æˆ·ç«¯
                const testSupabase = createFetchBasedSupabaseClient(supabaseUrl, supabaseKey);
                
                // å°è¯•ä¸€ä¸ªç®€å•çš„æŸ¥è¯¢æ¥æµ‹è¯•è¿æ¥
                const { data, error } = await testSupabase.from('products').select('*').limit(1);
                
                if (error) {
                    throw new Error(error.message || 'æŸ¥è¯¢å¤±è´¥');
                }
                
                showStatus(statusElement, 'âœ… è¿æ¥æˆåŠŸï¼ä½¿ç”¨çœŸå®Supabase API', 'success');
                
                // ä¿å­˜å®¢æˆ·ç«¯åˆ°å…¨å±€
                window.supabase = testSupabase;
            } catch (error) {
                console.error('âŒ Supabaseè¿æ¥æµ‹è¯•å¤±è´¥:', error);
                showStatus(statusElement, `âŒ è¿æ¥å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
            }
        }
        
        // ä¿å­˜Supabaseé…ç½®
        function saveSupabaseConfig() {
            const supabaseUrl = document.getElementById('supabase-url').value;
            const supabaseKey = document.getElementById('supabase-key').value;
            const useSupabase = document.getElementById('use-supabase').checked;
            const statusElement = document.getElementById('supabase-status');
            
            if (!supabaseUrl || !supabaseKey) {
                showStatus(statusElement, 'è¯·å¡«å†™Supabase URLå’ŒAPI Key', 'error');
                return;
            }
            
            // ä¿å­˜é…ç½®åˆ°æœ¬åœ°å­˜å‚¨
            const config = {
                url: supabaseUrl,
                key: supabaseKey,
                enabled: useSupabase
            };
            
            localStorage.setItem('supabaseConfig', JSON.stringify(config));
            
            // å¦‚æœå¯ç”¨äº†Supabaseï¼Œå°è¯•é‡æ–°åˆå§‹åŒ–
            if (useSupabase) {
                initializeSupabase(supabaseUrl, supabaseKey)
                    .then(() => {
                        showStatus(statusElement, 'é…ç½®å·²ä¿å­˜å¹¶æˆåŠŸè¿æ¥åˆ°Supabase', 'success');
                        // é‡æ–°åŠ è½½æ•°æ®ä»¥åŒæ­¥åˆ°äº‘ç«¯
                        loadData();
                    })
                    .catch(error => {
                        console.error('é‡æ–°åˆå§‹åŒ–Supabaseå¤±è´¥:', error);
                        showStatus(statusElement, `é…ç½®å·²ä¿å­˜ï¼Œä½†è¿æ¥å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}`, 'warning');
                    });
            } else {
                // ç¦ç”¨Supabase
                supabase = null;
                showStatus(statusElement, 'é…ç½®å·²ä¿å­˜ï¼ŒSupabaseå·²ç¦ç”¨', 'info');
            }
        }
        
        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(element, message, type) {
            element.textContent = message;
            element.classList.remove('hidden', 'text-success', 'text-danger', 'text-warning', 'text-info');
            
            switch (type) {
                case 'success':
                    element.classList.add('text-success');
                    break;
                case 'error':
                    element.classList.add('text-danger');
                    break;
                case 'warning':
                    element.classList.add('text-warning');
                    break;
                default:
                    element.classList.add('text-info');
            }
        }
        
        // é¡µé¢å¯¼èˆª
        function navigateTo(page) {
            // éšè—æ‰€æœ‰é¡µé¢
            document.querySelectorAll('.page-transition').forEach(p => {
                p.classList.add('hidden');
            });
            
            // æ˜¾ç¤ºç›®æ ‡é¡µé¢
            document.getElementById(page).classList.remove('hidden');
            
            // æ›´æ–°å½“å‰é¡µé¢
            currentPage = page;
            
            // å…³é—­ç”¨æˆ·èœå•
            document.getElementById('user-menu').classList.add('hidden');
        }
        
        // åˆ‡æ¢è®¡ç®—å™¨
        function switchCalculator(calculator) {
            // éšè—æ‰€æœ‰è®¡ç®—å™¨
            document.querySelectorAll('.calculator-panel').forEach(panel => {
                panel.classList.add('hidden');
            });
            
            // æ˜¾ç¤ºç›®æ ‡è®¡ç®—å™¨
            document.getElementById(calculator).classList.remove('hidden');
            
            // æ›´æ–°å½“å‰è®¡ç®—å™¨
            currentCalculator = calculator;
            
            // æ›´æ–°æ ‡ç­¾çŠ¶æ€
            document.querySelectorAll('[data-calculator]').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-calculator="${calculator}"]`).classList.add('active');
        }
        
        // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
        function showConfirmDialog(title, message, callback) {
            const dialog = document.getElementById('confirm-dialog');
            const titleElement = document.getElementById('confirm-title');
            const messageElement = document.getElementById('confirm-message');
            const okButton = document.getElementById('confirm-ok');
            const cancelButton = document.getElementById('confirm-cancel');
            
            // è®¾ç½®å¯¹è¯æ¡†å†…å®¹
            titleElement.textContent = title;
            messageElement.textContent = message;
            
            // ç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨
            const newOkButton = okButton.cloneNode(true);
            okButton.parentNode.replaceChild(newOkButton, okButton);
            
            const newCancelButton = cancelButton.cloneNode(true);
            cancelButton.parentNode.replaceChild(newCancelButton, cancelButton);
            
            // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
            newOkButton.addEventListener('click', function() {
                dialog.classList.add('hidden');
                if (callback) callback(true);
            });
            
            newCancelButton.addEventListener('click', function() {
                dialog.classList.add('hidden');
                if (callback) callback(false);
            });
            
            // æ˜¾ç¤ºå¯¹è¯æ¡†
            dialog.classList.remove('hidden');
        }
        
        // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
        function saveData(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
                console.log(`æ•°æ®å·²ä¿å­˜: ${key}, å…± ${Array.isArray(data) ? data.length : 1} æ¡è®°å½•`);
                return true;
            } catch (error) {
                console.error(`ä¿å­˜æ•°æ®å¤±è´¥ (${key}):`, error.message);
                return false;
            }
        }
        
        // åˆ‡æ¢è®¾ç½®é¢æ¿
        function switchSettings(settings) {
            // éšè—æ‰€æœ‰è®¾ç½®é¢æ¿
            document.querySelectorAll('.settings-panel').forEach(panel => {
                panel.classList.add('hidden');
            });
            
            // æ˜¾ç¤ºç›®æ ‡è®¾ç½®é¢æ¿
            document.getElementById(settings + '-settings').classList.remove('hidden');
            
            // æ›´æ–°å½“å‰è®¾ç½®
            currentSettings = settings;
            
            // æ›´æ–°æ ‡ç­¾çŠ¶æ€
            document.querySelectorAll('[data-settings]').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-settings="${settings}"]`).classList.add('active');
        }
        
        // ç»‘å®šæ•°æ®æ¸…é™¤äº‹ä»¶
        function bindDataClearEvents() {
            // æ¸…é™¤äº§å“æ•°æ®
            document.getElementById('clear-products').addEventListener('click', function() {
                if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰äº§å“æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                    try {
                        // æ¸…ç©ºäº§å“æ•°æ®
                        products = [];
                        saveData('products', products);
                        
                        // åˆ·æ–°äº§å“åˆ—è¡¨
                        renderProducts();
                        
                        // æ·»åŠ æ“ä½œæ—¥å¿—
                        addOperationLog('æ¸…é™¤æ•°æ®', 'æ¸…é™¤äº†æ‰€æœ‰äº§å“æ•°æ®');
                        
                        // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
                        showNotification('æ¸…é™¤æˆåŠŸ', 'æ‰€æœ‰äº§å“æ•°æ®å·²æ¸…é™¤', 'success');
                    } catch (error) {
                        console.error('æ¸…é™¤äº§å“æ•°æ®å¤±è´¥:', error);
                        showNotification('æ¸…é™¤å¤±è´¥', 'æ¸…é™¤äº§å“æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯', 'error');
                    }
                }
            });
            

            
            // ç­›é€‰æ—¥å¿—
            document.getElementById('filter-logs').addEventListener('click', function() {
                const logType = document.getElementById('log-type-filter').value;
                
                try {
                    // è·å–ç­›é€‰åçš„æ—¥å¿—
                    let filteredLogs = [...operationLogs];
                    
                    // æŒ‰ç±»å‹ç­›é€‰
                    if (logType !== 'all') {
                        filteredLogs = filteredLogs.filter(log => log.type === logType);
                    }
                    
                    // æ˜¾ç¤ºç­›é€‰ç»“æœ
                    renderFilteredLogs(filteredLogs);
                    
                    // æ˜¾ç¤ºç­›é€‰ç»“æœæ•°é‡
                    showNotification('ç­›é€‰å®Œæˆ', `å…±æ‰¾åˆ° ${filteredLogs.length} æ¡æ—¥å¿—è®°å½•`, 'success');
                } catch (error) {
                    console.error('ç­›é€‰æ—¥å¿—å¤±è´¥:', error);
                    showNotification('ç­›é€‰å¤±è´¥', 'ç­›é€‰æ—¥å¿—æ—¶å‘ç”Ÿé”™è¯¯', 'error');
                }
            });
            
            // å¯¼å‡ºæ—¥å¿—æ•°æ®
            document.getElementById('export-logs').addEventListener('click', function() {
                const logType = document.getElementById('log-type-filter').value;
                
                try {
                    // è·å–è¦å¯¼å‡ºçš„æ—¥å¿—ï¼ˆåº”ç”¨å½“å‰ç­›é€‰æ¡ä»¶ï¼‰
                    let logsToExport = [...operationLogs];
                    
                    // æŒ‰ç±»å‹ç­›é€‰
                    if (logType !== 'all') {
                        logsToExport = logsToExport.filter(log => log.type === logType);
                    }
                    
                    if (logsToExport.length === 0) {
                        showNotification('å¯¼å‡ºå¤±è´¥', 'æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ—¥å¿—è®°å½•', 'error');
                        return;
                    }
                    
                    // è½¬æ¢ä¸ºCSVæ ¼å¼
                    const headers = ['æ“ä½œç±»å‹', 'æ“ä½œå†…å®¹', 'æ“ä½œäºº', 'æ“ä½œæ—¶é—´'];
                    const csvContent = [
                        headers.join(','),
                        ...logsToExport.map(log => [
                            log.type,
                            `"${log.description.replace(/"/g, '""')}"`, // è½¬ä¹‰åŒå¼•å·
                            log.user,
                            new Date(log.timestamp).toLocaleString('zh-CN')
                        ].join(','))
                    ].join('\n');
                    
                    // åˆ›å»ºä¸‹è½½é“¾æ¥
                    const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    
                    link.setAttribute('href', url);
                    link.setAttribute('download', `æ“ä½œæ—¥å¿—_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
                    showNotification('å¯¼å‡ºæˆåŠŸ', `å·²å¯¼å‡º ${logsToExport.length} æ¡æ—¥å¿—è®°å½•`, 'success');
                    
                    // æ·»åŠ æ“ä½œæ—¥å¿—
                    addOperationLog('ç³»ç»Ÿæ“ä½œ', `å¯¼å‡ºäº† ${logsToExport.length} æ¡æ“ä½œæ—¥å¿—`);
                } catch (error) {
                    console.error('å¯¼å‡ºæ—¥å¿—å¤±è´¥:', error);
                    showNotification('å¯¼å‡ºå¤±è´¥', 'å¯¼å‡ºæ—¥å¿—æ—¶å‘ç”Ÿé”™è¯¯', 'error');
                }
            });
            
            // æ¸…é™¤æ“ä½œæ—¥å¿—
            document.getElementById('clear-logs').addEventListener('click', function() {
                const logType = document.getElementById('log-type-filter').value;
                
                // ç¡®å®šè¦æ¸…é™¤çš„æ—¥å¿—èŒƒå›´
                let logsToClear = [...operationLogs];
                let clearTitle = 'æ¸…é™¤æ“ä½œæ—¥å¿—';
                let clearMessage = 'æ‚¨ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ“ä½œæ—¥å¿—å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼';
                
                if (logType !== 'all') {
                    // åº”ç”¨ç­›é€‰æ¡ä»¶
                    logsToClear = logsToClear.filter(log => log.type === logType);
                    clearMessage = `æ‚¨ç¡®å®šè¦æ¸…é™¤ç¬¦åˆå½“å‰ç­›é€‰æ¡ä»¶çš„ ${logsToClear.length} æ¡æ“ä½œæ—¥å¿—å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`;
                }
                
                // æ˜¾ç¤ºè‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†
                showConfirmDialog(clearTitle, clearMessage, function(confirmed) {
                    if (confirmed) {
                    try {
                        if (logType !== 'all') {
                            // æ¸…é™¤ç¬¦åˆæ¡ä»¶çš„æ—¥å¿—
                            operationLogs = operationLogs.filter(log => log.type !== logType);
                        } else {
                            // æ¸…é™¤æ‰€æœ‰æ—¥å¿—
                            operationLogs = [];
                        }
                        
                        saveData('operationLogs', operationLogs);
                        
                        // åˆ·æ–°æ—¥å¿—åˆ—è¡¨
                        renderOperationLogs();
                        
                        // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
                        showNotification('æ¸…é™¤æˆåŠŸ', `å·²æ¸…é™¤ ${logsToClear.length} æ¡æ“ä½œæ—¥å¿—`, 'success');
                        
                        // æ·»åŠ æ“ä½œæ—¥å¿—ï¼ˆå¦‚æœä¸æ˜¯æ¸…é™¤æ‰€æœ‰æ—¥å¿—ï¼‰
                        if (operationLogs.length > 0) {
                            addOperationLog('æ¸…é™¤æ•°æ®', `æ¸…é™¤äº† ${logsToClear.length} æ¡æ“ä½œæ—¥å¿—`);
                        }
                    } catch (error) {
                        console.error('æ¸…é™¤æ“ä½œæ—¥å¿—å¤±è´¥:', error);
                        showNotification('æ¸…é™¤å¤±è´¥', 'æ¸…é™¤æ“ä½œæ—¥å¿—æ—¶å‘ç”Ÿé”™è¯¯', 'error');
                    }
                }
            });
            });
            

        }
        
        // å¤„ç†ç™»å½•
        async function handleLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // è¡¨å•éªŒè¯
            if (!username || !password) {
                document.getElementById('login-error').textContent = 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ';
                document.getElementById('login-error').classList.remove('hidden');
                return;
            }
            
            // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯ä¿¡æ¯
            document.getElementById('login-error').classList.add('hidden');
            
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const loginButton = document.getElementById('login-button');
                const originalText = loginButton.innerHTML;
                loginButton.innerHTML = '<div class="loading-spinner mr-2"></div> ç™»å½•ä¸­...';
                loginButton.disabled = true;
                
                // ä»ç”¨æˆ·åˆ—è¡¨ä¸­æŸ¥æ‰¾ç”¨æˆ·
                const user = users.find(u => u.username === username);
                
                if (user && user.password === password) {
                    currentUser = user;
                    
                    // ä¿å­˜ç”¨æˆ·ä¼šè¯
                    await saveData('currentUser', [user]); // åŒ…è£…ä¸ºæ•°ç»„ä»¥ç¬¦åˆSupabaseæ ¼å¼
                    
                    // æ˜¾ç¤ºåº”ç”¨
                    document.getElementById('login-page').classList.add('hidden');
                    document.getElementById('app').classList.remove('hidden');
                    document.getElementById('current-username').textContent = user.name || user.username;
                    
                    // åº”ç”¨ç”¨æˆ·æƒé™
                    applyUserPermissions(user);
                    
                    // è®°å½•ç™»å½•æ—¥å¿—
                    addOperationLog('system', `ç”¨æˆ·ç™»å½•: ${user.username}`);
                    
                    console.log('ç™»å½•æˆåŠŸ:', user.name || user.username);
                } else {
                    // ç™»å½•å¤±è´¥
                    document.getElementById('login-error').textContent = 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯';
                    document.getElementById('login-error').classList.remove('hidden');
                }
            } catch (error) {
                console.error('ç™»å½•å¤±è´¥:', error.message);
                document.getElementById('login-error').textContent = 'ç™»å½•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•';
                document.getElementById('login-error').classList.remove('hidden');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                const loginButton = document.getElementById('login-button');
                loginButton.innerHTML = '<span>ç™»å½•</span>';
                loginButton.disabled = false;
            }
        }
        
        // å¤„ç†é€€å‡ºç™»å½•
        async function handleLogout() {
            try {
                // é€€å‡ºç™»å½•é€»è¾‘ - ä½¿ç”¨Supabase APIåˆ é™¤å½“å‰ç”¨æˆ·è®°å½•
                if (supabase) {
                    try {
                        // å°è¯•ä½¿ç”¨Supabase API
                        if (typeof supabase.from === 'function' && 
                            typeof supabase.from('current_user').delete === 'function') {
                            // æ£€æŸ¥neqæ–¹æ³•æ˜¯å¦å­˜åœ¨
                            if (typeof supabase.from('current_user').delete().neq === 'function') {
                                await supabase.from('current_user').delete().neq('id', '');
                            } else {
                                // å¦‚æœneqæ–¹æ³•ä¸å­˜åœ¨ï¼Œä½¿ç”¨å…¶ä»–æ–¹å¼åˆ é™¤
                                await supabase.from('current_user').delete().match({});
                            }
                        }
                    } catch (supabaseError) {
                        console.warn('Supabaseæ“ä½œå¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨æ–¹å¼:', supabaseError.message);
                        // å›é€€åˆ°æœ¬åœ°å­˜å‚¨æ–¹å¼
                        localStorage.removeItem('currentUser');
                    }
                } else {
                    // ç›´æ¥ä½¿ç”¨æœ¬åœ°å­˜å‚¨æ–¹å¼
                    localStorage.removeItem('currentUser');
                }
                
                currentUser = null;
                
                // æ˜¾ç¤ºç™»å½•é¡µé¢
                document.getElementById('app').classList.add('hidden');
                document.getElementById('login-page').classList.remove('hidden');
                
                // è®°å½•é€€å‡ºç™»å½•æ—¥å¿—ï¼ˆä½¿ç”¨åŒæ­¥æ–¹å¼ï¼Œé¿å…å¼‚æ­¥é”™è¯¯ï¼‰
                try {
                    addOperationLog('system', 'ç”¨æˆ·é€€å‡ºç™»å½•');
                } catch (logError) {
                    console.warn('è®°å½•æ—¥å¿—å¤±è´¥:', logError.message);
                }
                
                console.log('ç”¨æˆ·å·²é€€å‡ºç™»å½•');
            } catch (error) {
                console.error('é€€å‡ºç™»å½•å¤±è´¥:', error.message);
                // å³ä½¿å‡ºé”™ä¹Ÿè¦å¼ºåˆ¶é€€å‡º
                currentUser = null;
                document.getElementById('app').classList.add('hidden');
                document.getElementById('login-page').classList.remove('hidden');
                showNotification('æç¤º', 'å·²é€€å‡ºç™»å½•', 'success');
            }
        }
        
        // æ¸²æŸ“äº§å“åˆ—è¡¨
        function renderProducts() {
            const container = document.getElementById('products-container');
            const noProducts = document.getElementById('no-products');
            const searchTerm = document.getElementById('product-search').value.toLowerCase();
            
            // ç­›é€‰äº§å“
            let filteredProducts = products;
            if (searchTerm) {
                filteredProducts = products.filter(product => 
                    product.name.toLowerCase().includes(searchTerm) ||
                    product.model.toLowerCase().includes(searchTerm) ||
                    product.description.toLowerCase().includes(searchTerm)
                );
            }
            
            // æ¸…ç©ºå®¹å™¨
            container.innerHTML = '';
            
            // æ£€æŸ¥æ˜¯å¦æœ‰äº§å“
            if (filteredProducts.length === 0) {
                container.classList.add('hidden');
                noProducts.classList.remove('hidden');
                return;
            }
            
            // æ˜¾ç¤ºäº§å“åˆ—è¡¨
            container.classList.remove('hidden');
            noProducts.classList.add('hidden');
            
            // æ¸²æŸ“äº§å“å¡ç‰‡
            filteredProducts.forEach(product => {
                const card = createProductCard(product);
                container.appendChild(card);
            });
        }
        
        // åˆ›å»ºäº§å“å¡ç‰‡
        function createProductCard(product) {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-lg shadow-sm overflow-hidden';
            card.setAttribute('data-id', product.id);
            
            // ç”Ÿæˆæ ‡ç­¾HTML
            const badgesHtml = product.badges.map(badge => {
                let badgeClass = '';
                let badgeText = '';
                
                switch (badge) {
                    case 'on-sale':
                        badgeClass = 'badge-primary';
                        badgeText = 'åœ¨å”®';
                        break;
                    case 'hot':
                        badgeClass = 'badge-danger';
                        badgeText = 'çˆ†æ¬¾';
                        break;
                    case 'bargain':
                        badgeClass = 'badge-warning';
                        badgeText = 'ç‰¹ä»·';
                        break;
                    case 'new':
                        badgeClass = 'badge-success';
                        badgeText = 'æ–°å“';
                        break;
                    case 'discontinued':
                        badgeClass = 'badge-secondary';
                        badgeText = 'åœå”®';
                        break;
                }
                
                return `<span class="badge ${badgeClass}">${badgeText}</span>`;
            }).join(' ');
            
            // è®¾ç½®å¡ç‰‡å†…å®¹
            card.innerHTML = `
                <div class="relative">
                    <img src="${product.image}" alt="${product.name}" class="w-full h-48 object-cover">
                    <div class="absolute top-2 right-2 flex gap-1">
                        ${badgesHtml}
                    </div>
                </div>
                <div class="p-4">
                    <h3 class="text-lg font-semibold text-dark mb-2">${product.name}</h3>
                    <p class="text-dark-3 text-sm mb-2">å‹å·: ${product.model}</p>
                    <p class="text-dark-3 text-sm mb-2">å°ºå¯¸: ${product.size || 'æœªçŸ¥'}</p>
                    <p class="text-dark-3 text-sm mb-2">é£æ ¼: ${product.style || 'æœªçŸ¥'}</p>
                    <p class="text-dark-3 text-sm mb-4 line-clamp-2">æè¿°: ${product.description || 'æš‚æ— æè¿°'}</p>
                    <div class="flex justify-between items-center">
                        <span class="text-xl font-bold text-primary">Â¥${product.price.toFixed(2)}</span>
                        <div class="flex gap-2">
                            <button class="product-action p-2 text-dark-3 hover:text-primary" data-action="edit" data-id="${product.id}" title="ç¼–è¾‘">
                                <i class="fa fa-pencil"></i>
                            </button>
                            <button class="product-action p-2 text-dark-3 hover:text-danger" data-action="delete" data-id="${product.id}" title="åˆ é™¤">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            return card;
        }
        
        // æ·»åŠ é˜²æŠ–æ ‡å¿—
        let isAddingProduct = false;
        
        // å¤„ç†æ·»åŠ äº§å“
        function handleAddProduct() {
            // é˜²æ­¢é‡å¤æäº¤
            if (isAddingProduct) {
                return;
            }
            isAddingProduct = true;
            
            try {
                // è·å–è¡¨å•æ•°æ®
                const name = document.getElementById('product-name').value.trim();
                const price = parseFloat(document.getElementById('product-price').value);
                const model = document.getElementById('product-model').value.trim();
                const category = document.getElementById('product-category').value;
                const size = document.getElementById('product-size').value ? document.getElementById('product-size').value.trim() : '';
                const style = document.getElementById('product-style').value ? document.getElementById('product-style').value.trim() : '';
                const description = document.getElementById('product-description').value ? document.getElementById('product-description').value.trim() : '';
                
                // æ”¶é›†æ ‡ç­¾ï¼ˆå¤é€‰æ¡†ï¼‰
                const badges = [];
                document.querySelectorAll('#add-product-form input[name="badges"]:checked').forEach(checkbox => {
                    badges.push(checkbox.value);
                });
                
                // éªŒè¯è¾“å…¥
                if (!name || isNaN(price) || !model || !category) {
                    showNotification('æ·»åŠ å¤±è´¥', 'è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µï¼Œä¸”ä»·æ ¼å¿…é¡»æ˜¯æœ‰æ•ˆæ•°å­—', 'error');
                    return;
                }
                
                // éªŒè¯ä»·æ ¼æ˜¯å¦ä¸ºæ­£æ•°
                if (price <= 0) {
                    showNotification('æ·»åŠ å¤±è´¥', 'ä»·æ ¼å¿…é¡»å¤§äº0', 'error');
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦æœ‰ä¸Šä¼ çš„å›¾ç‰‡
                const fileInput = document.getElementById('product-image');
                const preview = document.getElementById('product-image-preview');
                
                // ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤å›¾ç‰‡
                let imageUrl = 'https://p3-doubao-search-sign.byteimg.com/labis/b25bf99ea85ce428883f6bb2054bb3a3~tplv-be4g95zd3a-image.jpeg?rk3s=542c0f93&x-expires=1779614297&x-signature=em5LkupK5eTit6quyY0Ne413gRI%3D';
                
                console.log('æ£€æŸ¥å›¾ç‰‡ä¸Šä¼ çŠ¶æ€...');
                
                // æ£€æŸ¥é¢„è§ˆä¸­æ˜¯å¦æœ‰å›¾ç‰‡
                if (!preview.classList.contains('hidden')) {
                    const previewImg = preview.querySelector('img');
                    if (previewImg && previewImg.src) {
                        imageUrl = previewImg.src;
                        console.log('ä½¿ç”¨é¢„è§ˆä¸­çš„å›¾ç‰‡');
                    }
                }
                
                // å¦‚æœæœ‰æ–°ä¸Šä¼ çš„æ–‡ä»¶ï¼Œä½¿ç”¨æ–‡ä»¶å†…å®¹
                if (fileInput.files && fileInput.files[0]) {
                    console.log('å‘ç°æ–°ä¸Šä¼ çš„å›¾ç‰‡æ–‡ä»¶');
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            imageUrl = e.target.result;
                            console.log('æ–‡ä»¶è¯»å–æˆåŠŸï¼Œå›¾ç‰‡æ•°æ®é•¿åº¦:', imageUrl.length);
                            
                            // åˆ›å»ºæ–°äº§å“å¯¹è±¡
                            const newProduct = {
                                id: 'prod_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                                name,
                                price,
                                model,
                                category,
                                size,
                                style,
                                description,
                                image: imageUrl,
                                badges,
                                createdAt: new Date().toISOString(),
                                updatedAt: new Date().toISOString()
                            };
                            
                            console.log('åˆ›å»ºæ–°äº§å“å¯¹è±¡:', { id: newProduct.id, name: newProduct.name, imageLength: newProduct.image.length });
                            
                            // æ·»åŠ åˆ°äº§å“æ•°ç»„
                            products.push(newProduct);
                            
                            // ä¿å­˜äº§å“æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
                            localStorage.setItem('products', JSON.stringify(products));
                            console.log('äº§å“æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
                            
                            // é‡æ–°æ¸²æŸ“äº§å“åˆ—è¡¨
                            renderProducts();
                            
                            // å…³é—­æ¨¡æ€æ¡†
                            document.getElementById('add-product-modal').classList.add('hidden');
                            
                            // é‡ç½®è¡¨å•å­—æ®µ
                            document.getElementById('product-name').value = '';
                            document.getElementById('product-price').value = '';
                            document.getElementById('product-model').value = '';
                            document.getElementById('product-category').value = '';
                            document.getElementById('product-size').value = '';
                            document.getElementById('product-style').value = '';
                            document.getElementById('product-description').value = '';
                            document.getElementById('product-image').value = '';
                            // é‡ç½®æ ‡ç­¾å¤é€‰æ¡†
                            document.querySelectorAll('#add-product-form input[name="badges"]').forEach(checkbox => {
                                checkbox.checked = false;
                            });
                            
                            // é‡ç½®é¢„è§ˆ
                            preview.classList.add('hidden');
                            const previewImg = preview.querySelector('img');
                            if (previewImg) {
                                previewImg.src = '';
                            }
                            
                            // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
                            showNotification('æ·»åŠ æˆåŠŸ', 'äº§å“å·²æˆåŠŸæ·»åŠ ', 'success');
                            
                            // è®°å½•æ“ä½œæ—¥å¿—
                            addOperationLog('product', `æ·»åŠ äº§å“: ${name}`);
                        } catch (error) {
                            console.error('å¤„ç†ä¸Šä¼ å›¾ç‰‡æ—¶å‘ç”Ÿé”™è¯¯:', error);
                            showNotification('æ·»åŠ å¤±è´¥', 'å¤„ç†å›¾ç‰‡æ—¶å‘ç”Ÿé”™è¯¯', 'error');
                        } finally {
                            // é‡ç½®é˜²æŠ–æ ‡å¿—
                            isAddingProduct = false;
                        }
                    };
                    
                    reader.onerror = function(error) {
                        console.error('æ–‡ä»¶è¯»å–å¤±è´¥:', error);
                        showNotification('æ·»åŠ å¤±è´¥', 'å›¾ç‰‡è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                        isAddingProduct = false;
                    };
                    
                    reader.readAsDataURL(fileInput.files[0]);
                    return; // ç­‰å¾…æ–‡ä»¶è¯»å–å®Œæˆåå†ç»§ç»­
                }
                
                console.log('ä½¿ç”¨é»˜è®¤å›¾ç‰‡');
                
                // åˆ›å»ºæ–°äº§å“å¯¹è±¡
                const newProduct = {
                    id: 'prod_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    name,
                    price,
                    model,
                    category,
                    size,
                    style,
                    description,
                    image: imageUrl,
                    badges,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                // æ·»åŠ åˆ°äº§å“æ•°ç»„
                products.push(newProduct);
                
                // ä¿å­˜äº§å“æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem('products', JSON.stringify(products));
                
                // é‡æ–°æ¸²æŸ“äº§å“åˆ—è¡¨
                renderProducts();
                
                // å…³é—­æ¨¡æ€æ¡†
                document.getElementById('add-product-modal').classList.add('hidden');
                
                // æ‰‹åŠ¨é‡ç½®è¡¨å•å­—æ®µ
                document.getElementById('product-name').value = '';
                document.getElementById('product-price').value = '';
                document.getElementById('product-model').value = '';
                document.getElementById('product-category').value = '';
                document.getElementById('product-size').value = '';
                document.getElementById('product-style').value = '';
                document.getElementById('product-description').value = '';
                // é‡ç½®æ ‡ç­¾å¤é€‰æ¡†
                document.querySelectorAll('#add-product-form input[name="badges"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
                
                // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
                showNotification('æ·»åŠ æˆåŠŸ', 'äº§å“å·²æˆåŠŸæ·»åŠ ', 'success');
                
                // è®°å½•æ“ä½œæ—¥å¿—
                console.log('è®°å½•äº§å“æ·»åŠ æ—¥å¿—:', name);
                addOperationLog('product', `æ·»åŠ äº§å“: ${name}`);
            } catch (error) {
                console.error('æ·»åŠ äº§å“å¤±è´¥:', error.message);
                showNotification('æ·»åŠ å¤±è´¥', 'æ·»åŠ äº§å“æ—¶å‘ç”Ÿé”™è¯¯', 'error');
            } finally {
                // é‡ç½®é˜²æŠ–æ ‡å¿—
                isAddingProduct = false;
            }
        }
        
        // ç¼–è¾‘äº§å“
        function editProduct(productId) {
            console.log('=== å¼€å§‹ç¼–è¾‘äº§å“ ===', productId);
            
            const product = products.find(p => p.id === productId);
            if (!product) {
                showNotification('ç¼–è¾‘å¤±è´¥', 'äº§å“ä¸å­˜åœ¨', 'error');
                console.log('äº§å“ä¸å­˜åœ¨ï¼Œç¼–è¾‘å¤±è´¥');
                return;
            }
            
            // é‡ç½®å›¾ç‰‡ä¸Šä¼ çŠ¶æ€ - è¿™æ˜¯ä¿®å¤æŒ‰é’®å¤±æ•ˆé—®é¢˜çš„å…³é”®
            const preview = document.getElementById('edit-product-image-preview');
            const previewImg = document.getElementById('edit-preview-img');
            const uploadArea = document.getElementById('edit-product-image-upload');
            const input = document.getElementById('edit-product-image-input');
            
            console.log('é‡ç½®å›¾ç‰‡ä¸Šä¼ çŠ¶æ€:', {
                previewExists: !!preview,
                previewImgExists: !!previewImg,
                uploadAreaExists: !!uploadArea,
                inputExists: !!input
            });
            
            // å¼ºåˆ¶é‡ç½®æ‰€æœ‰çŠ¶æ€
            if (preview) preview.classList.add('hidden');
            if (uploadArea) uploadArea.classList.remove('hidden');
            if (previewImg) previewImg.src = '';
            if (input) input.value = '';
            
            // å¡«å……è¡¨å•æ•°æ®
            document.getElementById('edit-product-id').value = product.id;
            document.getElementById('edit-product-name').value = product.name;
            document.getElementById('edit-product-price').value = product.price;
            document.getElementById('edit-product-model').value = product.model;
            document.getElementById('edit-product-category').value = product.category;
            document.getElementById('edit-product-size').value = product.size || '';
            document.getElementById('edit-product-style').value = product.style || '';
            document.getElementById('edit-product-description').value = product.description || '';
            
            // é‡ç½®æ ‡ç­¾å¤é€‰æ¡†
            document.querySelectorAll('#edit-product-form input[name="badges"]').forEach(checkbox => {
                checkbox.checked = product.badges.includes(checkbox.value);
            });
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('edit-product-modal').classList.remove('hidden');
            console.log('=== ç¼–è¾‘äº§å“æ¨¡æ€æ¡†å·²æ˜¾ç¤º ===');
        }
        
        // å¤„ç†ç¼–è¾‘äº§å“
        function handleEditProduct() {
            try {
                const productId = document.getElementById('edit-product-id').value;
                const name = document.getElementById('edit-product-name').value.trim();
                const price = parseFloat(document.getElementById('edit-product-price').value);
                const model = document.getElementById('edit-product-model').value.trim();
                const category = document.getElementById('edit-product-category').value;
                const size = document.getElementById('edit-product-size').value ? document.getElementById('edit-product-size').value.trim() : '';
                const style = document.getElementById('edit-product-style').value ? document.getElementById('edit-product-style').value.trim() : '';
                const description = document.getElementById('edit-product-description').value ? document.getElementById('edit-product-description').value.trim() : '';
                
                // è·å–é€‰ä¸­çš„æ ‡ç­¾
                const badges = [];
                document.querySelectorAll('#edit-product-form input[name="badges"]:checked').forEach(checkbox => {
                    badges.push(checkbox.value);
                });
                
                // éªŒè¯å¿…å¡«å­—æ®µ
                if (!name || isNaN(price) || !model || !category) {
                    showNotification('æ›´æ–°å¤±è´¥', 'è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µï¼Œä¸”ä»·æ ¼å¿…é¡»æ˜¯æœ‰æ•ˆæ•°å­—', 'error');
                    return;
                }
                
                // éªŒè¯ä»·æ ¼æ˜¯å¦ä¸ºæ­£æ•°
                if (price <= 0) {
                    showNotification('æ›´æ–°å¤±è´¥', 'ä»·æ ¼å¿…é¡»å¤§äº0', 'error');
                    return;
                }
                
                // æŸ¥æ‰¾äº§å“
                const productIndex = products.findIndex(p => p.id === productId);
                if (productIndex === -1) {
                    showNotification('æ›´æ–°å¤±è´¥', 'äº§å“ä¸å­˜åœ¨', 'error');
                    return;
                }
                
                // è·å–å›¾ç‰‡æ•°æ®
                let image = products[productIndex].image; // é»˜è®¤ä½¿ç”¨åŸæœ‰å›¾ç‰‡
                
                console.log('ç¼–è¾‘äº§å“æ—¶æ£€æŸ¥å›¾ç‰‡çŠ¶æ€...');
                
                // æ£€æŸ¥é¢„è§ˆä¸­æ˜¯å¦æœ‰å›¾ç‰‡ï¼ˆç”¨æˆ·å·²é€‰æ‹©ä½†æœªç¡®è®¤ä¸Šä¼ ï¼‰
                const preview = document.getElementById('edit-product-image-preview');
                if (!preview.classList.contains('hidden')) {
                    const previewImg = preview.querySelector('img');
                    if (previewImg && previewImg.src) {
                        image = previewImg.src;
                        console.log('ä½¿ç”¨é¢„è§ˆä¸­çš„å›¾ç‰‡');
                    }
                }
                
                // æ£€æŸ¥æ˜¯å¦æœ‰æ–°ä¸Šä¼ çš„å›¾ç‰‡æ–‡ä»¶
                const fileInput = document.getElementById('edit-product-image-input');
                if (fileInput.files && fileInput.files[0]) {
                    console.log('å‘ç°æ–°ä¸Šä¼ çš„å›¾ç‰‡æ–‡ä»¶');
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            image = e.target.result;
                            console.log('æ–‡ä»¶è¯»å–æˆåŠŸï¼Œå›¾ç‰‡æ•°æ®é•¿åº¦:', image.length);
                            
                            // æ›´æ–°äº§å“ä¿¡æ¯
                            products[productIndex] = {
                                ...products[productIndex],
                                name,
                                price,
                                model,
                                category,
                                size,
                                style,
                                description,
                                badges,
                                image,
                                updatedAt: new Date().toISOString()
                            };
                            
                            console.log('æ›´æ–°äº§å“ä¿¡æ¯:', { id: products[productIndex].id, name: products[productIndex].name, imageLength: products[productIndex].image.length });
                            
                            // ä¿å­˜äº§å“æ•°æ®
                            localStorage.setItem('products', JSON.stringify(products));
                            console.log('äº§å“æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
                            
                            // é‡æ–°æ¸²æŸ“äº§å“åˆ—è¡¨
                            renderProducts();
                            
                            // å…³é—­æ¨¡æ€æ¡†
                            document.getElementById('edit-product-modal').classList.add('hidden');
                            
                            // é‡ç½®é¢„è§ˆ
                            preview.classList.add('hidden');
                            const previewImg = preview.querySelector('img');
                            if (previewImg) {
                                previewImg.src = '';
                            }
                            
                            // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
                            showNotification('æ›´æ–°æˆåŠŸ', 'äº§å“ä¿¡æ¯å·²æˆåŠŸæ›´æ–°', 'success');
                            
                            // è®°å½•æ“ä½œæ—¥å¿—
                            addOperationLog('product', `æ›´æ–°äº§å“: ${name}`);
                        } catch (error) {
                            console.error('å¤„ç†ä¸Šä¼ å›¾ç‰‡æ—¶å‘ç”Ÿé”™è¯¯:', error);
                            showNotification('æ›´æ–°å¤±è´¥', 'å¤„ç†å›¾ç‰‡æ—¶å‘ç”Ÿé”™è¯¯', 'error');
                        }
                    };
                    
                    reader.onerror = function(error) {
                        console.error('æ–‡ä»¶è¯»å–å¤±è´¥:', error);
                        showNotification('æ›´æ–°å¤±è´¥', 'å›¾ç‰‡è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                    };
                    
                    reader.readAsDataURL(fileInput.files[0]);
                    return; // ç­‰å¾…æ–‡ä»¶è¯»å–å®Œæˆåå†ç»§ç»­
                }
                
                console.log('ä½¿ç”¨åŸæœ‰å›¾ç‰‡æˆ–é¢„è§ˆå›¾ç‰‡');
                
                // æ›´æ–°äº§å“ä¿¡æ¯
                products[productIndex] = {
                    ...products[productIndex],
                    name,
                    price,
                    model,
                    category,
                    size,
                    style,
                    description,
                    badges,
                    image,
                    updatedAt: new Date().toISOString()
                };
                
                // ä¿å­˜äº§å“æ•°æ®
                localStorage.setItem('products', JSON.stringify(products));
                
                // é‡æ–°æ¸²æŸ“äº§å“åˆ—è¡¨
                renderProducts();
                
                // å…³é—­æ¨¡æ€æ¡†
                document.getElementById('edit-product-modal').classList.add('hidden');
                
                // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
                showNotification('æ›´æ–°æˆåŠŸ', 'äº§å“ä¿¡æ¯å·²æˆåŠŸæ›´æ–°', 'success');
                
                // è®°å½•æ“ä½œæ—¥å¿—
                addOperationLog('product', `æ›´æ–°äº§å“: ${name}`);
            } catch (error) {
                console.error('æ›´æ–°äº§å“å¤±è´¥:', error.message);
                showNotification('æ›´æ–°å¤±è´¥', 'äº§å“æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }
        
        // åˆ é™¤äº§å“
        function deleteProduct(productId) {
            showConfirmDialog(
                'åˆ é™¤äº§å“',
                'ç¡®å®šè¦åˆ é™¤æ­¤äº§å“å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚',
                () => {
                    try {
                        const productIndex = products.findIndex(p => p.id === productId);
                        if (productIndex === -1) {
                            showNotification('åˆ é™¤å¤±è´¥', 'äº§å“ä¸å­˜åœ¨', 'error');
                            return;
                        }
                        
                        const productName = products[productIndex].name;
                        
                        // ä»æ•°ç»„ä¸­åˆ é™¤äº§å“
                        products.splice(productIndex, 1);
                        
                        // ä¿å­˜æ›´æ–°åçš„äº§å“æ•°æ®
                        localStorage.setItem('products', JSON.stringify(products));
                        
                        // é‡æ–°æ¸²æŸ“äº§å“åˆ—è¡¨
                        renderProducts();
                        
                        // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
                        showNotification('åˆ é™¤æˆåŠŸ', 'äº§å“å·²æˆåŠŸåˆ é™¤', 'success');
                        
                        // è®°å½•æ“ä½œæ—¥å¿—
                        addOperationLog('product', `åˆ é™¤äº§å“: ${productName}`);
                    } catch (error) {
                        console.error('åˆ é™¤äº§å“å¤±è´¥:', error.message);
                        showNotification('åˆ é™¤å¤±è´¥', 'åˆ é™¤äº§å“æ—¶å‘ç”Ÿé”™è¯¯', 'error');
                    }
                }
            );
        }
        
        // æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨
        function renderUsers() {
            const container = document.getElementById('users-list');
            const noUsers = document.getElementById('no-users');
            
            // æ¸…ç©ºå®¹å™¨
            container.innerHTML = '';
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ç”¨æˆ·
            if (users.length === 0) {
                container.classList.add('hidden');
                noUsers.classList.remove('hidden');
                return;
            }
            
            // æ˜¾ç¤ºç”¨æˆ·åˆ—è¡¨
            container.classList.remove('hidden');
            noUsers.classList.add('hidden');
            
            // æ¸²æŸ“ç”¨æˆ·è¡Œ
            users.forEach(user => {
                const row = document.createElement('tr');
                
                // è®¾ç½®è¡Œå†…å®¹
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-dark">${user.username}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-dark-2">${user.name}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="badge ${user.type === 'admin' ? 'badge-primary' : 'badge-secondary'}">${user.type === 'admin' ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·'}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="badge ${user.status === 'active' ? 'badge-success' : 'badge-danger'}">${user.status === 'active' ? 'å¯ç”¨' : 'ç¦ç”¨'}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-dark-3">
                        ${formatDate(user.createdAt)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="flex gap-2">
                            <button class="user-action p-1 text-dark-3 hover:text-primary" data-action="edit" data-id="${user.id}" title="ç¼–è¾‘">
                                <i class="fa fa-pencil"></i>
                            </button>
                            ${user.username !== 'admin' ? `
                                <button class="user-action p-1 text-dark-3 hover:text-danger" data-action="delete" data-id="${user.id}" title="åˆ é™¤">
                                    <i class="fa fa-trash"></i>
                                </button>
                            ` : ''}
                        </div>
                    </td>
                `;
                
                container.appendChild(row);
            });
        }
        
        // å¤„ç†æ·»åŠ ç”¨æˆ·
        function handleAddUser() {
            try {
                const username = document.getElementById('new-username').value.trim();
                const name = document.getElementById('new-name').value.trim();
                const password = document.getElementById('new-password').value;
                const type = document.getElementById('new-type').value;
                const status = document.getElementById('new-status').value;
                
                // éªŒè¯è¾“å…¥
                if (!username || !name || !password) {
                    showNotification('æ·»åŠ å¤±è´¥', 'è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ', 'error');
                    return;
                }
                
                // éªŒè¯ç”¨æˆ·åæ ¼å¼
                if (!/^[a-zA-Z0-9_]{3,20}$/.test(username)) {
                    showNotification('æ·»åŠ å¤±è´¥', 'ç”¨æˆ·åå¿…é¡»ä¸º3-20ä½å­—æ¯ã€æ•°å­—æˆ–ä¸‹åˆ’çº¿', 'error');
                    return;
                }
                
                // éªŒè¯å¯†ç å¼ºåº¦
                if (password.length < 6) {
                    showNotification('æ·»åŠ å¤±è´¥', 'å¯†ç é•¿åº¦è‡³å°‘ä¸º6ä½', 'error');
                    return;
                }
                
                // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
                if (users.some(user => user.username === username)) {
                    showNotification('æ·»åŠ å¤±è´¥', 'ç”¨æˆ·åå·²å­˜åœ¨', 'error');
                    return;
                }
                
                // å¯¹å¯†ç è¿›è¡Œç®€å•åŠ å¯†å¤„ç†
                const hashedPassword = btoa(password);
                
                // åˆ›å»ºæ–°ç”¨æˆ·å¯¹è±¡
                const newUser = {
                    id: 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    username,
                    name,
                    password: hashedPassword, // å­˜å‚¨åŠ å¯†åçš„å¯†ç 
                    type,
                    status,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                // æ·»åŠ åˆ°ç”¨æˆ·æ•°ç»„
                users.push(newUser);
                
                // ä¿å­˜ç”¨æˆ·æ•°æ®
                saveData('users', users);
                
                // é‡æ–°æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨
                renderUsers();
                renderUsers();
                
                // å…³é—­æ¨¡æ€æ¡†
                document.getElementById('add-user-modal').classList.add('hidden');
                
                // æ‰‹åŠ¨é‡ç½®è¡¨å•å­—æ®µ
                document.getElementById('new-username').value = '';
                document.getElementById('new-name').value = '';
                document.getElementById('new-password').value = '';
                document.getElementById('new-type').value = 'user';
                document.getElementById('new-status').value = 'active';
                
                // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
                showNotification('æ·»åŠ æˆåŠŸ', 'ç”¨æˆ·å·²æˆåŠŸæ·»åŠ ', 'success');
                
                // è®°å½•æ“ä½œæ—¥å¿—
                addOperationLog('æ·»åŠ ç”¨æˆ·', `æ·»åŠ äº†ç”¨æˆ·: ${username}`);
            } catch (error) {
                console.error('æ·»åŠ ç”¨æˆ·å¤±è´¥:', error);
                showNotification('æ·»åŠ å¤±è´¥', 'æ·»åŠ ç”¨æˆ·æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message, 'error');
            }
        }
        
        // ç¼–è¾‘ç”¨æˆ·
        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) {
                showNotification('ç¼–è¾‘å¤±è´¥', 'ç”¨æˆ·ä¸å­˜åœ¨', 'error');
                return;
            }
            
            // å¡«å……è¡¨å•æ•°æ®
            document.getElementById('edit-user-id').value = user.id;
            document.getElementById('edit-username').value = user.username;
            document.getElementById('edit-name').value = user.name;
            document.getElementById('edit-password').value = '';
            document.getElementById('edit-type').value = user.type;
            document.getElementById('edit-status').value = user.status;
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('edit-user-modal').classList.remove('hidden');
        }
        
        // å¤„ç†ç¼–è¾‘ç”¨æˆ·
        function handleEditUser() {
            try {
                const userId = document.getElementById('edit-user-id').value;
                const name = document.getElementById('edit-name').value.trim();
                const password = document.getElementById('edit-password').value;
                const type = document.getElementById('edit-type').value;
                const status = document.getElementById('edit-status').value;
                
                // éªŒè¯å¿…å¡«å­—æ®µ
                if (!name) {
                    showNotification('æ›´æ–°å¤±è´¥', 'è¯·å¡«å†™å§“å', 'error');
                    return;
                }
                
                // æŸ¥æ‰¾ç”¨æˆ·
                const userIndex = users.findIndex(u => u.id === userId);
                if (userIndex === -1) {
                    showNotification('æ›´æ–°å¤±è´¥', 'ç”¨æˆ·ä¸å­˜åœ¨', 'error');
                    return;
                }
                
                const username = users[userIndex].username;
                
                // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
                users[userIndex] = {
                    ...users[userIndex],
                    name,
                    type,
                    status,
                    updatedAt: new Date().toISOString()
                };
                
                // å¦‚æœå¯†ç ä¸ä¸ºç©ºï¼Œåˆ™æ›´æ–°å¯†ç 
                if (password) {
                    // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥å¯¹å¯†ç è¿›è¡Œå“ˆå¸Œå¤„ç†
                    users[userIndex].password = password;
                }
                
                // ä¿å­˜ç”¨æˆ·æ•°æ®
                localStorage.setItem('users', JSON.stringify(users));
                
                // é‡æ–°æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨
                renderUsers();
                renderUsers();
                
                // å…³é—­æ¨¡æ€æ¡†
                document.getElementById('edit-user-modal').classList.add('hidden');
                
                // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
                showNotification('æ›´æ–°æˆåŠŸ', 'ç”¨æˆ·ä¿¡æ¯å·²æˆåŠŸæ›´æ–°', 'success');
                
                // è®°å½•æ“ä½œæ—¥å¿—
                addOperationLog('user', `æ›´æ–°ç”¨æˆ·: ${username}`);
            } catch (error) {
                console.error('æ›´æ–°ç”¨æˆ·å¤±è´¥:', error.message);
                showNotification('æ›´æ–°å¤±è´¥', 'ç”¨æˆ·æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }
        
        // åˆ é™¤ç”¨æˆ·
        function deleteUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) {
                showNotification('åˆ é™¤å¤±è´¥', 'ç”¨æˆ·ä¸å­˜åœ¨', 'error');
                return;
            }
            
            if (user.username === 'admin') {
                showNotification('åˆ é™¤å¤±è´¥', 'ä¸èƒ½åˆ é™¤ç®¡ç†å‘˜è´¦æˆ·', 'error');
                return;
            }
            
            showConfirmDialog(
                'åˆ é™¤ç”¨æˆ·',
                `ç¡®å®šè¦åˆ é™¤ç”¨æˆ· "${user.username}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`,
                () => {
                    try {
                        const userIndex = users.findIndex(u => u.id === userId);
                        if (userIndex === -1) {
                            showNotification('åˆ é™¤å¤±è´¥', 'ç”¨æˆ·ä¸å­˜åœ¨', 'error');
                            return;
                        }
                        
                        const username = users[userIndex].username;
                        
                        // ä»æ•°ç»„ä¸­åˆ é™¤ç”¨æˆ·
                        users.splice(userIndex, 1);
                        
                        // ä¿å­˜æ›´æ–°åçš„ç”¨æˆ·æ•°æ®
                        localStorage.setItem('users', JSON.stringify(users));
                        
                        // é‡æ–°æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨
                renderUsers();
                        renderUsers();
                        
                        // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
                        showNotification('åˆ é™¤æˆåŠŸ', 'ç”¨æˆ·å·²æˆåŠŸåˆ é™¤', 'success');
                        
                        // è®°å½•æ“ä½œæ—¥å¿—
                        addOperationLog('user', `åˆ é™¤ç”¨æˆ·: ${username}`);
                    } catch (error) {
                        console.error('åˆ é™¤ç”¨æˆ·å¤±è´¥:', error.message);
                        showNotification('åˆ é™¤å¤±è´¥', 'åˆ é™¤ç”¨æˆ·æ—¶å‘ç”Ÿé”™è¯¯', 'error');
                    }
                }
            );
        }
        
        // å¢™ä½“ç®—ç – - æŒ‰ç…§å…¬å¼è®¡ç®—
        function calculateWallBricks() {
            // è·å–è¾“å…¥å€¼ï¼ˆå•ä½ï¼šmmï¼‰
            const wallLengthInput = document.getElementById('wall-length');
            const wallHeightInput = document.getElementById('wall-height');
            const wallThicknessInput = document.getElementById('wall-thickness');
            const wallMortarInput = document.getElementById('wall-mortar');
            const brickLengthInput = document.getElementById('brick-length');
            const brickWidthInput = document.getElementById('brick-width');
            const brickThicknessInput = document.getElementById('brick-thickness');
            
            // è·å–å¹¶éªŒè¯è¾“å…¥å€¼
            const lengthValue = wallLengthInput ? parseFloat(wallLengthInput.value) : NaN;
            const heightValue = wallHeightInput ? parseFloat(wallHeightInput.value) : NaN;
            const thicknessValue = wallThicknessInput ? parseFloat(wallThicknessInput.value) : NaN;
            const mortarValue = wallMortarInput ? parseFloat(wallMortarInput.value) : NaN;
            const brickLengthValue = brickLengthInput ? parseFloat(brickLengthInput.value) : NaN;
            const brickWidthValue = brickWidthInput ? parseFloat(brickWidthInput.value) : NaN;
            const brickThicknessValue = brickThicknessInput ? parseFloat(brickThicknessInput.value) : NaN;
            
            // è½¬æ¢å•ä½ - ä½¿ç”¨ç²¾ç¡®çš„æ•°å€¼å¤„ç†
            const length = lengthValue ? Math.round((lengthValue / 1000) * 1000000) / 1000000 : 0; // è½¬æ¢ä¸ºç±³
            const height = heightValue ? Math.round((heightValue / 1000) * 1000000) / 1000000 : 0; // è½¬æ¢ä¸ºç±³
            const thickness = thicknessValue ? Math.round((thicknessValue / 10) * 10000) / 10000 : 0; // è½¬æ¢ä¸ºcm
            const mortar = mortarValue ? Math.round((mortarValue / 10) * 10000) / 10000 : 0; // è½¬æ¢ä¸ºcm
            const brickLength = brickLengthValue ? Math.round((brickLengthValue / 10) * 10000) / 10000 : 0; // è½¬æ¢ä¸ºcm
            const brickWidth = brickWidthValue ? Math.round((brickWidthValue / 10) * 10000) / 10000 : 0; // è½¬æ¢ä¸ºcm
            const brickThickness = brickThicknessValue ? Math.round((brickThicknessValue / 10) * 10000) / 10000 : 6.5; // è½¬æ¢ä¸ºcmï¼Œé»˜è®¤ä¸º6.5cm
            
            // çª—æˆ·ç›¸å…³å‚æ•°
            const hasWindowCheckbox = document.getElementById('has-window');
            const windowWidthInput = document.getElementById('window-width');
            const windowHeightInput = document.getElementById('window-height');
            const windowSillWidthInput = document.getElementById('window-sill-width');
            
            const hasWindow = hasWindowCheckbox ? hasWindowCheckbox.checked : false;
            const windowWidthValue = windowWidthInput ? parseFloat(windowWidthInput.value) : NaN;
            const windowHeightValue = windowHeightInput ? parseFloat(windowHeightInput.value) : NaN;
            const windowSillWidthValue = windowSillWidthInput ? parseFloat(windowSillWidthInput.value) : NaN;
            
            const windowWidth = windowWidthValue ? Math.round((windowWidthValue / 1000) * 10000) / 10000 : 0; // è½¬æ¢ä¸ºç±³
            const windowHeight = windowHeightValue ? Math.round((windowHeightValue / 1000) * 10000) / 10000 : 0; // è½¬æ¢ä¸ºç±³
            const windowSillWidth = windowSillWidthValue ? Math.round((windowSillWidthValue / 10) * 10000) / 10000 : 0; // è½¬æ¢ä¸ºcm
            
            // é—¨æ´ç›¸å…³å‚æ•°
            const hasDoorCheckbox = document.getElementById('has-door');
            const doorWidthInput = document.getElementById('door-width');
            const doorHeightInput = document.getElementById('door-height');
            const doorThresholdWidthInput = document.getElementById('door-threshold-width');
            const doorDoubleCaseCheckbox = document.getElementById('door-double-case');
            
            const hasDoor = hasDoorCheckbox ? hasDoorCheckbox.checked : false;
            const doorWidthValue = doorWidthInput ? parseFloat(doorWidthInput.value) : NaN;
            const doorHeightValue = doorHeightInput ? parseFloat(doorHeightInput.value) : NaN;
            const doorThresholdWidthValue = doorThresholdWidthInput ? parseFloat(doorThresholdWidthInput.value) : NaN;
            const isDoubleCase = doorDoubleCaseCheckbox ? doorDoubleCaseCheckbox.checked : false;
            
            const doorWidth = doorWidthValue ? Math.round((doorWidthValue / 1000) * 10000) / 10000 : 0; // è½¬æ¢ä¸ºç±³
            const doorHeight = doorHeightValue ? Math.round((doorHeightValue / 1000) * 10000) / 10000 : 0; // è½¬æ¢ä¸ºç±³
            const doorThresholdWidth = doorThresholdWidthValue ? Math.round((doorThresholdWidthValue / 10) * 10000) / 10000 : 0; // è½¬æ¢ä¸ºcm
            
            // éªŒè¯è¾“å…¥
            if (isNaN(length) || isNaN(height) || isNaN(brickLength) || isNaN(brickWidth) || 
                length <= 0 || height <= 0 || brickLength <= 0 || brickWidth <= 0) {
                showNotification('è®¡ç®—å¤±è´¥', 'è¯·è¾“å…¥æœ‰æ•ˆçš„é•¿åº¦ã€é«˜åº¦å’Œç –å—å°ºå¯¸', 'error');
                return;
            }
            
            // å¦‚æœæœ‰çª—æˆ·ï¼ŒéªŒè¯çª—æˆ·å‚æ•°
            if (hasWindow) {
                if (isNaN(windowWidth) || isNaN(windowHeight) || isNaN(windowSillWidth) || 
                    windowWidth <= 0 || windowHeight <= 0 || windowSillWidth < 0) {
                    showNotification('è®¡ç®—å¤±è´¥', 'è¯·è¾“å…¥æœ‰æ•ˆçš„çª—æˆ·å°ºå¯¸å’Œçª—å°å®½åº¦', 'error');
                    return;
                }
                
                // éªŒè¯çª—æˆ·å°ºå¯¸æ˜¯å¦åˆç†
                if (windowWidth >= length || windowHeight >= height) {
                    showNotification('è®¡ç®—å¤±è´¥', 'çª—æˆ·å°ºå¯¸ä¸èƒ½å¤§äºå¢™ä½“å°ºå¯¸', 'error');
                    return;
                }
                
                // éªŒè¯çª—å°å®½åº¦æ˜¯å¦åˆç†
                if (windowSillWidth / 100 >= length) {
                    showNotification('è®¡ç®—å¤±è´¥', 'çª—å°å®½åº¦ä¸èƒ½å¤§äºå¢™ä½“é•¿åº¦', 'error');
                    return;
                }
            }
            
            // å¦‚æœæœ‰é—¨æ´ï¼ŒéªŒè¯é—¨æ´å‚æ•°
            if (hasDoor) {
                if (isNaN(doorWidth) || isNaN(doorHeight) || isNaN(doorThresholdWidth) || 
                    doorWidth <= 0 || doorHeight <= 0 || doorThresholdWidth < 0) {
                    showNotification('è®¡ç®—å¤±è´¥', 'è¯·è¾“å…¥æœ‰æ•ˆçš„é—¨æ´å°ºå¯¸å’Œé—¨æ§›å®½åº¦', 'error');
                    return;
                }
                
                // éªŒè¯é—¨æ´å°ºå¯¸æ˜¯å¦åˆç†
                if (doorWidth >= length || doorHeight >= height) {
                    showNotification('è®¡ç®—å¤±è´¥', 'é—¨æ´å°ºå¯¸ä¸èƒ½å¤§äºå¢™ä½“å°ºå¯¸', 'error');
                    return;
                }
                
                // éªŒè¯é—¨æ§›å®½åº¦æ˜¯å¦åˆç†
                if (doorThresholdWidth / 100 >= length) {
                    showNotification('è®¡ç®—å¤±è´¥', 'é—¨æ§›å®½åº¦ä¸èƒ½å¤§äºå¢™ä½“é•¿åº¦', 'error');
                    return;
                }
            }
            
            // è®¡ç®—å¢™ä½“æ€»é¢ç§¯
            const totalArea = length * height;
            
            // è®¡ç®—çª—æˆ·é¢ç§¯
            let windowArea = 0;
            let windowGlassArea = 0;
            let windowBrickArea = 0;
            
            if (hasWindow) {
                // çª—æˆ·é¢ç§¯è®¡ç®—ï¼šçª—æˆ·å®½åº¦ Ã— çª—æˆ·é«˜åº¦
                windowGlassArea = windowWidth * windowHeight;
                
                // è®¡ç®—çª—æˆ·è´´ç –é¢ç§¯ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
                const windowSillHeightInMeters = windowSillWidth / 100;
                const widthBrickArea = windowWidth * windowSillHeightInMeters * 2;
                const heightBrickArea = windowHeight * windowSillHeightInMeters * 2;
                windowBrickArea = widthBrickArea + heightBrickArea;
                
                // æ€»çª—æˆ·åŒºåŸŸé¢ç§¯ï¼ˆç”¨äºè®¡ç®—å®é™…ç Œç –é¢ç§¯ï¼‰= çª—æˆ·é¢ç§¯
                windowArea = windowGlassArea;
            }
            
            // è®¡ç®—é—¨æ´é¢ç§¯
            let doorArea = 0;
            let doorBrickArea = 0;
            let doorCaseBricks = 0; // åŒ…å¥—æ‰€éœ€ç –å—æ•°
            
            if (hasDoor) {
                // é—¨æ´é¢ç§¯è®¡ç®—ï¼šé—¨æ´å®½åº¦ Ã— é—¨æ´é«˜åº¦
                doorArea = doorWidth * doorHeight;
                
                // åŒ…å¥—è®¡ç®—é€»è¾‘ï¼ˆå•åŒ…å¥—/åŒåŒ…å¥—ï¼‰
                if (doorThresholdWidth > 0) {
                    // è½¬æ¢ä¸ºmmå•ä½è¿›è¡Œç²¾ç¡®è®¡ç®—
                    const doorWidthMm = doorWidth * 1000; // é—¨æ´å®½åº¦mm
                    const doorHeightMm = doorHeight * 1000; // é—¨æ´é«˜åº¦mm
                    const doorThresholdWidthMm = doorThresholdWidth * 10; // é—¨æ§›å®½åº¦mmï¼ˆè½¬æ¢ä¸ºmmï¼‰
                    const brickLengthMm = brickLength * 10; // ç –å—é•¿åº¦mm
                    const brickWidthMm = brickWidth * 10; // ç –å—å®½åº¦mm
                    
                    // å•åŒ…å¥—è®¡ç®—é€»è¾‘ - ä½¿ç”¨å‘ä¸Šå–æ•´ï¼ˆè¾¹é•¿åº¦ Ã· ç“·ç –åŸè¾¹é•¿åº¦ï¼‰
                    // 1. é—¨æ´å·¦å³ä¸¤ä¾§è®¡ç®—
                    const sideHeight = doorHeightMm; // å•ä¾§é«˜åº¦mm
                    const sideThickness = doorThresholdWidthMm; // å•ä¾§åšåº¦mm
                    
                    // æ¯å—ç –ä»…èƒ½æä¾›1æ®µ"åŸè¾¹å¤–éœ²æ®µ"ï¼Œä½¿ç”¨å‘ä¸Šå–æ•´è®¡ç®—
                    const totalSides = isDoubleCase ? 4 : 2; // å•åŒ…å¥—ä¸º2ä¾§ï¼ŒåŒåŒ…å¥—ä¸º4ä¾§
                    
                    // è®¡ç®—æ¯ä¾§éœ€è¦çš„ç –å—æ•°ï¼ˆå‘ä¸Šå–æ•´ï¼‰
                    const bricksPerSide = Math.ceil(sideHeight / brickWidthMm);
                    
                    // å·¦å³ä¸¤ä¾§éœ€è¦çš„æ•´ç –æ•°
                    const sideBricks = bricksPerSide * totalSides;
                    
                    // 2. é—¨æ´ä¸Šæ–¹è®¡ç®—
                    const topWidth = doorWidthMm; // ä¸Šæ–¹å®½åº¦mm
                    
                    // è®¡ç®—ä¸Šæ–¹éœ€è¦çš„ç –å—æ•°ï¼ˆå‘ä¸Šå–æ•´ï¼‰
                    const bricksPerTop = Math.ceil(topWidth / brickWidthMm);
                    
                    // ä¸Šæ–¹éœ€è¦çš„æ€»ç –å—æ•°ï¼ˆå•åŒ…å¥—ä¸º1æ¡ï¼ŒåŒåŒ…å¥—ä¸º2æ¡ï¼‰
                    const topBricks = bricksPerTop * (isDoubleCase ? 2 : 1);
                    
                    // 3. æ€»è®¡åŒ…å¥—éœ€è¦çš„ç –å—æ•°
                    doorCaseBricks = sideBricks + topBricks;
                    
                    console.log(`å•åŒ…å¥—è®¡ç®—è¯¦æƒ…ï¼š`);
                    console.log(`- å•ä¾§å°ºå¯¸: ${sideThickness}mm Ã— ${sideHeight}mm`);
                    console.log(`- ç –å—å°ºå¯¸: ${brickLengthMm}mm Ã— ${brickWidthMm}mm`);
                    console.log(`- æ¯ä¾§éœ€è¦ç –å—æ•°: ${bricksPerSide}å— (å‘ä¸Šå–æ•´)`);
                    console.log(`- å·¦å³ä¸¤ä¾§å…±éœ€: ${sideBricks}å— (${totalSides}ä¾§)`);
                    console.log(`- ä¸Šæ–¹éœ€è¦ç –å—æ•°: ${bricksPerTop}å— (å‘ä¸Šå–æ•´)`);
                    console.log(`- ä¸Šæ–¹éœ€è¦æ•´ç –: ${topBricks}å—`);
                    console.log(`- æ€»è®¡éœ€è¦æ•´ç –: ${doorCaseBricks}å—`);
                    
                    // è®¡ç®—åŒ…å¥—è´´ç –é¢ç§¯ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
                    const sideArea = (sideHeight / 1000) * (sideThickness / 1000) * totalSides;
                    const topArea = (topWidth / 1000) * (doorThresholdWidthMm / 1000) * (isDoubleCase ? 2 : 1);
                    doorBrickArea = sideArea + topArea;
                } else {
                    // ä½¿ç”¨åŸæœ‰çš„ç®€å•è®¡ç®—æ–¹æ³•
                    const doorThresholdHeightInMeters = doorThresholdWidth / 100;
                    const doorWidthBrickArea = doorWidth * doorThresholdHeightInMeters * 2;
                    const doorHeightBrickArea = doorHeight * doorThresholdHeightInMeters * 2;
                    doorBrickArea = doorWidthBrickArea + doorHeightBrickArea;
                }
            }
            
            // è®¡ç®—å®é™…éœ€è¦ç Œç –çš„é¢ç§¯
            const area = totalArea - windowArea - doorArea;
            
            // è®¡ç®—æ¨¡å¼åˆ¤æ–­
            let totalBricks;
            let calculationMethod;
            let calculationScenario;
            let calculationFormula;
            
            if (thickness === 0) {
                // ä¸€ã€é¥°é¢ç –æ¨¡å¼ï¼ˆå¢™é¢é“ºè´´ï¼ŒæŒ‰é¢ç§¯ç®—ï¼‰
                calculationMethod = "é¥°é¢ç –æ¨¡å¼ï¼ˆæŒ‰é¢ç§¯è®¡ç®—ï¼‰";
                
                // è½¬æ¢ä¸ºmmå•ä½è¿›è¡Œç²¾ç¡®è®¡ç®—
                const wallWidthMm = length * 1000; // å¢™ä½“å®½åº¦mm
                const wallHeightMm = height * 1000; // å¢™ä½“é«˜åº¦mm
                const brickLengthMm = brickLength * 10; // ç –å—é•¿åº¦mm
                const brickWidthMm = brickWidth * 10; // ç –å—å®½åº¦mm
                
                console.log(`å¢™é¢ç®—ç –è®¡ç®—:`);
                console.log(`- å¢™ä½“å°ºå¯¸: ${wallWidthMm}mm Ã— ${wallHeightMm}mm`);
                console.log(`- ç –å—å°ºå¯¸: ${brickLengthMm}mm Ã— ${brickWidthMm}mm`);
                
                // 5æ­¥è®¡ç®—æ³• - æ ¹æ®å‚è€ƒå›¾ç‰‡é‡æ–°å®ç°
                let Q1, Q2, Q3, Q4, Q;
                
                // æŒ‰ç…§æ–½å·¥é€»è¾‘é‡æ–°å®ç°ç®—ç –ç®—æ³•
                // æ­¥éª¤1ï¼šè®¡ç®—å®½/é«˜æ–¹å‘æ•´ç –æ•°é‡ï¼ˆå‘ä¸‹å–æ•´ï¼‰
                const wholeTileCountX = Math.floor(wallWidthMm / brickLengthMm); // å®½åº¦æ–¹å‘æ•´ç –æ•°
                const wholeTileCountY = Math.floor(wallHeightMm / brickWidthMm); // é«˜åº¦æ–¹å‘æ•´ç –æ•°
                
                console.log(`æ­¥éª¤1 - è®¡ç®—æ•´ç –æ•°é‡ï¼šå®½åº¦æ–¹å‘ ${wholeTileCountX} ç‰‡ï¼Œé«˜åº¦æ–¹å‘ ${wholeTileCountY} ç‰‡`);
                console.log(`   - å®½åº¦æ–¹å‘ï¼š${wallWidthMm} Ã· ${brickLengthMm} = ${(wallWidthMm/brickLengthMm).toFixed(4)}ï¼Œå‘ä¸‹å–æ•´ä¸º ${wholeTileCountX}`);
                console.log(`   - é«˜åº¦æ–¹å‘ï¼š${wallHeightMm} Ã· ${brickWidthMm} = ${(wallHeightMm/brickWidthMm).toFixed(4)}ï¼Œå‘ä¸‹å–æ•´ä¸º ${wholeTileCountY}`);
                
                // æ­¥éª¤2ï¼šè®¡ç®—å®½/é«˜æ–¹å‘å‰©ä½™æœªé“ºè´´å°ºå¯¸
                const remainingWidth = wallWidthMm - wholeTileCountX * brickLengthMm; // å®½åº¦å‰©ä½™å°ºå¯¸ï¼ˆmmï¼‰
                const remainingHeight = wallHeightMm - wholeTileCountY * brickWidthMm; // é«˜åº¦å‰©ä½™å°ºå¯¸ï¼ˆmmï¼‰
                
                console.log(`æ­¥éª¤2 - è®¡ç®—å‰©ä½™å°ºå¯¸ï¼šå®½åº¦å‰©ä½™ ${remainingWidth}mmï¼Œé«˜åº¦å‰©ä½™ ${remainingHeight}mm`);
                console.log(`   - å®½åº¦å‰©ä½™ï¼š${wallWidthMm} - ${wholeTileCountX} Ã— ${brickLengthMm} = ${remainingWidth}mm`);
                console.log(`   - é«˜åº¦å‰©ä½™ï¼š${wallHeightMm} - ${wholeTileCountY} Ã— ${brickWidthMm} = ${remainingHeight}mm`);
                
                // æ­¥éª¤3ï¼šè®¡ç®—å®½åº¦å‰©ä½™åŒºåŸŸç”¨ç –é‡ï¼ˆå‰©ä½™å®½åº¦åŒºåŸŸï¼šå®½åº¦=remainingWidthï¼Œé«˜åº¦=wallHeightMmï¼‰
                let tileCountForRemainingWidth = 0;
                if (remainingWidth > 0) {
                    // å®½åº¦å‰©ä½™åŒºåŸŸçš„é«˜åº¦ = å¢™é¢æ€»é«˜ï¼Œéœ€æŒ‰é«˜åº¦æ–¹å‘æ•´ç –æ•°æ‹†åˆ†ï¼ˆæ¯åˆ—å¯¹åº”1ç‰‡ç –ï¼‰
                    tileCountForRemainingWidth = wholeTileCountY; // æ¯ç‰‡ç –è¦†ç›–ï¼šremainingWidth Ã— brickWidthMmï¼ˆåŸè¾¹å¤–éœ²ï¼‰
                    
                    // éªŒè¯ä½™æ–™æ˜¯å¦å¯ç”¨ï¼ˆä½™æ–™=ç“·ç –å®½-å‰©ä½™å®½ï¼‰ï¼šä½™æ–™â‰¤å‰©ä½™å®½åˆ™ä½™æ–™æ— ç”¨ï¼Œæ— éœ€è°ƒæ•´ï¼ˆå·²æŒ‰æ•´ç –è®¡ç®—ï¼‰
                    const widthWaste = brickLengthMm - remainingWidth;
                    console.log(`æ­¥éª¤3 - å®½åº¦å‰©ä½™åŒºåŸŸç”¨ç –é‡ï¼š${tileCountForRemainingWidth} ç‰‡`);
                    console.log(`   - æ¯ç‰‡ç –è¦†ç›–ï¼š${remainingWidth}mm Ã— ${brickWidthMm}mmï¼ˆåŸè¾¹å¤–éœ²ï¼‰`);
                    console.log(`   - å®½åº¦ä½™æ–™ï¼š${widthWaste}mmï¼ˆâ‰¤${remainingWidth}mmï¼Œä½™æ–™æ— ç”¨ï¼‰`);
                } else {
                    console.log(`æ­¥éª¤3 - å®½åº¦æ— å‰©ä½™ï¼Œæ— éœ€é¢å¤–ç”¨ç –`);
                }
                
                // æ­¥éª¤4ï¼šè®¡ç®—é«˜åº¦å‰©ä½™åŒºåŸŸç”¨ç –é‡ï¼ˆå‰©ä½™é«˜åº¦åŒºåŸŸï¼šé«˜åº¦=remainingHeightï¼Œå®½åº¦=wallWidthMmï¼‰
                let tileCountForRemainingHeight = 0;
                if (remainingHeight > 0) {
                    // å…³é”®ï¼šåŸè¾¹çº¦æŸâ€”â€”æ•´ç –åˆ‡å‰²å‰©ä½™é«˜åº¦æ—¶ï¼Œæœ€å¤šåªèƒ½åˆ‡2ç‰‡ï¼ˆç¬¬ä¸‰ç‰‡æ— åŸè¾¹ï¼Œä¸å¯ç”¨ï¼‰
                    const usablePiecesPerTile = Math.min(
                        Math.floor(brickWidthMm / remainingHeight),
                        2 // å¼ºåˆ¶é™åˆ¶ï¼š1ç‰‡æ•´ç –æœ€å¤šåˆ‡2ç‰‡å¯ç”¨ç –ï¼ˆåŸè¾¹å¤–éœ²è¦æ±‚ï¼‰
                    );
                    
                    // é«˜åº¦å‰©ä½™åŒºåŸŸçš„å®½åº¦ = å¢™é¢æ€»å®½ï¼Œéœ€è¦çš„ç‰‡æ•°ä¸ºå®½åº¦æ–¹å‘çš„æ•´æ•°åˆ—æ•°é‡
                    // æ ¹æ®ç”¨æˆ·æä¾›çš„è®¡ç®—è§„åˆ™ï¼Œè¿™é‡Œåº”è¯¥ä½¿ç”¨å®½åº¦æ–¹å‘çš„æ•´æ•°åˆ—æ•°é‡
                    const requiredPieces = wholeTileCountX; // å®½åº¦æ–¹å‘æ•´æ•°åˆ—æ•°é‡
                    tileCountForRemainingHeight = Math.ceil(requiredPieces / usablePiecesPerTile);

                    // éªŒè¯ä½™æ–™æ˜¯å¦å¯ç”¨ï¼ˆä½™æ–™=ç“·ç –é«˜-å‰©ä½™é«˜ï¼‰ï¼šä½™æ–™â‰¤å‰©ä½™é«˜åˆ™ä½™æ–™æ— ç”¨ï¼Œæ— éœ€è°ƒæ•´
                    const heightWaste = brickWidthMm - remainingHeight;
                    console.log(`æ­¥éª¤4 - é«˜åº¦å‰©ä½™åŒºåŸŸç”¨ç –é‡ï¼š${tileCountForRemainingHeight} ç‰‡`);
                    console.log(`   - åŸè¾¹çº¦æŸï¼š1ç‰‡æ•´ç –æœ€å¤šåˆ‡${usablePiecesPerTile}ç‰‡å¯ç”¨ï¼ˆåŸè¾¹å¤–éœ²è¦æ±‚ï¼‰`);
                    console.log(`   - éœ€è¦ç‰‡æ•°ï¼š${requiredPieces}ç‰‡ï¼Œè®¡ç®—ï¼šMath.ceil(${requiredPieces} / ${usablePiecesPerTile}) = ${tileCountForRemainingHeight}ç‰‡`);
                    console.log(`   - é«˜åº¦ä½™æ–™ï¼š${heightWaste}mmï¼ˆâ‰¤${remainingHeight}mmï¼Œä½™æ–™æ— ç”¨ï¼‰`);
                } else {
                    console.log(`æ­¥éª¤4 - é«˜åº¦æ— å‰©ä½™ï¼Œæ— éœ€é¢å¤–ç”¨ç –`);
                }
                
                // æ­¥éª¤5ï¼šè®¡ç®—æ€»ç”¨ç –é‡
                const totalWholeTiles = wholeTileCountX * wholeTileCountY; // æ•´ç –åŒºåŸŸç”¨ç –
                const totalTileQuantity = totalWholeTiles + tileCountForRemainingWidth + tileCountForRemainingHeight;
                
                console.log(`æ­¥éª¤5 - æ€»ç”¨ç –é‡æ±‡æ€»ï¼š${totalWholeTiles} + ${tileCountForRemainingWidth} + ${tileCountForRemainingHeight} = ${totalTileQuantity} ç‰‡`);
                
                // æ˜ å°„åˆ°åŸæ¥çš„Q1-Q4å˜é‡ç»“æ„ï¼Œä¿æŒå…¼å®¹æ€§
                Q1 = totalWholeTiles;
                Q2 = tileCountForRemainingWidth;
                Q3 = tileCountForRemainingHeight;
                Q4 = 0; // æ–°ç®—æ³•ä¸­ä¸éœ€è¦è§’éƒ¨ä½™æ–™åˆ¤å®š
                Q = totalTileQuantity;
                
                // 5. æ€»ç”¨ç –æ•°æ±‡æ€» Q = Q1 + Q2 + Q3 + Q4
                Q = Q1 + Q2 + Q3 + Q4;
                
                console.log(`ç¬¬5æ­¥ - æ€»ç”¨ç –æ•°æ±‡æ€» Q = ${Q1} + ${Q2} + ${Q3} + ${Q4} = ${Q}å—`);
                
                // ç¡®å®šè®¡ç®—åœºæ™¯å’Œå…¬å¼
                if (!hasWindow && !hasDoor) {
                    // åœºæ™¯1ï¼šçº¯å¢™é¢
                    calculationScenario = "åœºæ™¯1ï¼šçº¯å¢™é¢";
                    calculationFormula = "Q = Q1 + Q2 + Q3 + Q4";
                    
                    // ä½¿ç”¨5æ­¥è®¡ç®—æ³•ç»“æœ
                    totalBricks = Q;
                    
                    console.log(`çº¯å¢™é¢è¯¦ç»†è®¡ç®—:`);
                    console.log(`- å¢™ä½“å°ºå¯¸: ${wallWidthMm}mm Ã— ${wallHeightMm}mm`);
                    console.log(`- ç –å—å°ºå¯¸: ${brickLengthMm}mm Ã— ${brickWidthMm}mm`);
                    console.log(`- 5æ­¥è®¡ç®—æ³•ç»“æœ: ${totalBricks}å—`);
                } else if (hasWindow && !hasDoor) {
                    // åœºæ™¯2ï¼šå¢™é¢+çª—æˆ·
                    calculationScenario = "åœºæ™¯2ï¼šå¢™é¢+çª—æˆ·";
                    calculationFormula = "Q = [W/L]Ã—[H/L] + 2Ã—[Ww/L] + 2Ã—[Hw/L]";
                    
                    // è®¡ç®—çª—æˆ·å››å‘¨éœ€è¦çš„ç –å—æ•°ï¼š2Ã—[Ww/L] + 2Ã—[Hw/L]
                    const windowWidthMm = windowWidth * 1000; // çª—æˆ·å®½åº¦mm
                    const windowHeightMm = windowHeight * 1000; // çª—æˆ·é«˜åº¦mm
                    
                    // ä¸¥æ ¼æŒ‰ç…§å…¬å¼è®¡ç®—ï¼š2Ã—[Ww/L] + 2Ã—[Hw/L]
                    // [Ww/L] = å‘ä¸Šå–æ•´(çª—æˆ·å®½åº¦ / ç –å—é•¿åº¦)
                    // [Hw/L] = å‘ä¸Šå–æ•´(çª—æˆ·é«˜åº¦ / ç –å—é•¿åº¦)
                    const windowWidthBricks = Math.ceil(windowWidthMm / brickLengthMm); // [Ww/L]
                    const windowHeightBricks = Math.ceil(windowHeightMm / brickLengthMm); // [Hw/L]
                    const windowTotalBricks = 2 * windowWidthBricks + 2 * windowHeightBricks; // 2Ã—[Ww/L] + 2Ã—[Hw/L]
                    
                    console.log(`çª—æˆ·è®¡ç®—:`);
                    console.log(`- çª—æˆ·å°ºå¯¸: ${windowWidthMm}mm Ã— ${windowHeightMm}mm`);
                    console.log(`- ç –å—é•¿åº¦: ${brickLengthMm}mm`);
                    console.log(`- çª—æˆ·å®½åº¦æ–¹å‘ç –å—æ•°: ${windowWidthBricks}å— [Ww/L]`);
                    console.log(`- çª—æˆ·é«˜åº¦æ–¹å‘ç –å—æ•°: ${windowHeightBricks}å— [Hw/L]`);
                    console.log(`- çª—æˆ·å››å‘¨ç –å—æ•°: ${windowTotalBricks}å— 2Ã—[Ww/L] + 2Ã—[Hw/L]`);
                    
                    totalBricks = Q + windowTotalBricks;
                } else if (!hasWindow && hasDoor) {
                    // åœºæ™¯3ï¼šå¢™é¢+é—¨
                    calculationScenario = "åœºæ™¯3ï¼šå¢™é¢+é—¨";
                    calculationFormula = "Q = [W/L]Ã—[H/L] + [2(Wd+Hd)/L]";
                    
                    // è®¡ç®—é—¨æ´åŒ…å¥—éœ€è¦çš„ç –å—æ•°ï¼š[2(Wd+Hd)/L]
                    const doorWidthMm = doorWidth * 1000; // é—¨æ´å®½åº¦mm
                    const doorHeightMm = doorHeight * 1000; // é—¨æ´é«˜åº¦mm
                    
                    // ä¸¥æ ¼æŒ‰ç…§å…¬å¼è®¡ç®—ï¼š[2(Wd+Hd)/L]
                    // 2(Wd+Hd) = 2*(é—¨æ´å®½åº¦ + é—¨æ´é«˜åº¦)
                    const totalDoorPerimeter = 2 * (doorWidthMm + doorHeightMm);
                    
                    // [2(Wd+Hd)/L] = å‘ä¸Šå–æ•´(2*(é—¨æ´å®½åº¦ + é—¨æ´é«˜åº¦) / ç –å—é•¿åº¦)
                    const doorTotalBricks = Math.ceil(totalDoorPerimeter / brickLengthMm);
                    
                    console.log(`é—¨æ´åŒ…å¥—è®¡ç®—:`);
                    console.log(`- é—¨æ´å°ºå¯¸: ${doorWidthMm}mm Ã— ${doorHeightMm}mm`);
                    console.log(`- ç –å—é•¿åº¦: ${brickLengthMm}mm`);
                    console.log(`- 2*(é—¨æ´å®½åº¦ + é—¨æ´é«˜åº¦): ${totalDoorPerimeter}mm`);
                    console.log(`- åŒ…å¥—ç –å—æ•°: ${doorTotalBricks}å— [2(Wd+Hd)/L]`);
                    
                    totalBricks = Q + doorTotalBricks;
                } else {
                    // åœºæ™¯4ï¼šå¢™é¢+çª—æˆ·+é—¨
                    calculationScenario = "åœºæ™¯4ï¼šå¢™é¢+çª—æˆ·+é—¨";
                    calculationFormula = "Q = [W/L]Ã—[H/L] + 2Ã—[Ww/L] + 2Ã—[Hw/L] + [2(Wd+Hd)/L]";
                    
                    // è®¡ç®—çª—æˆ·å››å‘¨éœ€è¦çš„ç –å—æ•°ï¼š2Ã—[Ww/L] + 2Ã—[Hw/L]
                    const windowWidthMm = windowWidth * 1000; // çª—æˆ·å®½åº¦mm
                    const windowHeightMm = windowHeight * 1000; // çª—æˆ·é«˜åº¦mm
                    
                    // ä¸¥æ ¼æŒ‰ç…§å…¬å¼è®¡ç®—ï¼š2Ã—[Ww/L] + 2Ã—[Hw/L]
                    // [Ww/L] = å‘ä¸Šå–æ•´(çª—æˆ·å®½åº¦ / ç –å—é•¿åº¦)
                    // [Hw/L] = å‘ä¸Šå–æ•´(çª—æˆ·é«˜åº¦ / ç –å—é•¿åº¦)
                    const windowWidthBricks = Math.ceil(windowWidthMm / brickLengthMm); // [Ww/L]
                    const windowHeightBricks = Math.ceil(windowHeightMm / brickLengthMm); // [Hw/L]
                    const windowTotalBricks = 2 * windowWidthBricks + 2 * windowHeightBricks; // 2Ã—[Ww/L] + 2Ã—[Hw/L]
                    
                    console.log(`çª—æˆ·è®¡ç®—:`);
                    console.log(`- çª—æˆ·å°ºå¯¸: ${windowWidthMm}mm Ã— ${windowHeightMm}mm`);
                    console.log(`- ç –å—é•¿åº¦: ${brickLengthMm}mm`);
                    console.log(`- çª—æˆ·å®½åº¦æ–¹å‘ç –å—æ•°: ${windowWidthBricks}å— [Ww/L]`);
                    console.log(`- çª—æˆ·é«˜åº¦æ–¹å‘ç –å—æ•°: ${windowHeightBricks}å— [Hw/L]`);
                    console.log(`- çª—æˆ·å››å‘¨ç –å—æ•°: ${windowTotalBricks}å— 2Ã—[Ww/L] + 2Ã—[Hw/L]`);
                    
                    // è®¡ç®—é—¨æ´åŒ…å¥—éœ€è¦çš„ç –å—æ•°ï¼š[2(Wd+Hd)/L]
                    const doorWidthMm = doorWidth * 1000; // é—¨æ´å®½åº¦mm
                    const doorHeightMm = doorHeight * 1000; // é—¨æ´é«˜åº¦mm
                    
                    // ä¸¥æ ¼æŒ‰ç…§å…¬å¼è®¡ç®—ï¼š[2(Wd+Hd)/L]
                    // 2(Wd+Hd) = 2*(é—¨æ´å®½åº¦ + é—¨æ´é«˜åº¦)
                    const totalDoorPerimeter = 2 * (doorWidthMm + doorHeightMm);
                    
                    // [2(Wd+Hd)/L] = å‘ä¸Šå–æ•´(2*(é—¨æ´å®½åº¦ + é—¨æ´é«˜åº¦) / ç –å—é•¿åº¦)
                    const doorTotalBricks = Math.ceil(totalDoorPerimeter / brickLengthMm);
                    
                    console.log(`é—¨æ´åŒ…å¥—è®¡ç®—:`);
                    console.log(`- é—¨æ´å°ºå¯¸: ${doorWidthMm}mm Ã— ${doorHeightMm}mm`);
                    console.log(`- ç –å—é•¿åº¦: ${brickLengthMm}mm`);
                    console.log(`- 2*(é—¨æ´å®½åº¦ + é—¨æ´é«˜åº¦): ${totalDoorPerimeter}mm`);
                    console.log(`- åŒ…å¥—ç –å—æ•°: ${doorTotalBricks}å— [2(Wd+Hd)/L]`);
                    
                    totalBricks = Q + windowTotalBricks + doorTotalBricks;
                }
                
                console.log(`æœ€ç»ˆè®¡ç®—ç»“æœ:`);
                console.log(`- è®¡ç®—åœºæ™¯: ${calculationScenario}`);
                console.log(`- è®¡ç®—å…¬å¼: ${calculationFormula}`);
                console.log(`- æ€»è®¡éœ€è¦ç –å—æ•°: ${totalBricks}å—`);
            } else {
                // äºŒã€ç Œç­‘ç –æ¨¡å¼ï¼ˆå¢™ä½“ç Œç­‘ï¼ŒæŒ‰ä½“ç§¯ç®—ï¼‰
                calculationMethod = "ç Œç­‘ç –æ¨¡å¼ï¼ˆæŒ‰ä½“ç§¯è®¡ç®—ï¼‰";
                
                // å¢™ä½“å‡€ä½“ç§¯ï¼ˆæ‰£é™¤çª—æˆ·å’Œé—¨æ´ï¼‰ï¼šå¢™ä½“å‡€ä½“ç§¯ = ï¼ˆå¢™ä½“é•¿åº¦ Ã— å¢™ä½“é«˜åº¦ Ã— å¢™ä½“åšåº¦ï¼‰ - ï¼ˆçª—æˆ·å®½åº¦ Ã— çª—æˆ·é«˜åº¦ Ã— å¢™ä½“åšåº¦ï¼‰ - ï¼ˆé—¨æ´å®½åº¦ Ã— é—¨æ´é«˜åº¦ Ã— å¢™ä½“åšåº¦ï¼‰
                const wallVolume = (length * height * (thickness / 100)) - 
                    (hasWindow ? (windowWidth * windowHeight * (thickness / 100)) : 0) - 
                    (hasDoor ? (doorWidth * doorHeight * (thickness / 100)) : 0);
                
                // å•å—ç –ï¼ˆè¿ç°ç¼ï¼‰çš„ä½“ç§¯ï¼šå•å—ç –å¸¦ç¼ä½“ç§¯ = ï¼ˆç –å—é•¿åº¦ + ç°ç¼åšåº¦ï¼‰ Ã— ï¼ˆç –å—å®½åº¦ + ç°ç¼åšåº¦ï¼‰ Ã— ï¼ˆç –å—åšåº¦ + ç°ç¼åšåº¦ï¼‰
                const brickVolumeWithMortar = ((brickLength + mortar) / 100) * ((brickWidth + mortar) / 100) * ((brickThickness + mortar) / 100);
                
                // æ‰€éœ€ç –å—æ•°ï¼šæ‰€éœ€ç –å—æ•° = å¢™ä½“å‡€ä½“ç§¯Ã·å•å—ç –å¸¦ç¼ä½“ç§¯
                totalBricks = Math.ceil(wallVolume / brickVolumeWithMortar);
            }
            
            // æ˜¾ç¤ºç»“æœ - å¯¹æ•°å€¼è¿›è¡Œå››èˆäº”å…¥å¤„ç†ï¼Œé¿å…æµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜
            showCalculationResult({
                type: 'å¢™ä½“ç®—ç –',
                params: {
                    length: Math.round(length * 10000) / 10000, // ä¿ç•™4ä½å°æ•°
                    height: Math.round(height * 10000) / 10000,
                    thickness: Math.round(thickness * 10000) / 10000,
                    mortar: Math.round(mortar * 10000) / 10000,
                    brickLength: Math.round(brickLength * 10000) / 10000,
                    brickWidth: Math.round(brickWidth * 10000) / 10000,
                    brickThickness: Math.round(brickThickness * 10000) / 10000,
                    hasWindow,
                    windowWidth: hasWindow ? Math.round(windowWidth * 10000) / 10000 : 0,
                    windowHeight: hasWindow ? Math.round(windowHeight * 10000) / 10000 : 0,
                    windowSillWidth: hasWindow ? Math.round(windowSillWidth * 10000) / 10000 : 0,
                hasDoor,
                doorWidth: hasDoor ? Math.round(doorWidth * 10000) / 10000 : 0,
                doorHeight: hasDoor ? Math.round(doorHeight * 10000) / 10000 : 0,
                doorThresholdWidth: hasDoor ? Math.round(doorThresholdWidth * 10000) / 10000 : 0
                },
                result: {
                    calculationMethod,
                    calculationScenario,
                    calculationFormula,
                    totalArea,
                    windowArea,
                    windowGlassArea: hasWindow ? windowGlassArea : 0,
                    windowBrickArea: hasWindow ? windowBrickArea : 0,
                    doorArea: hasDoor ? doorArea : 0,
                    doorBrickArea: hasDoor ? doorBrickArea : 0,
                    area,
                    totalBricks
                }
            });
            
            // ä¿å­˜è®¡ç®—å†å² - ä½¿ç”¨ç›¸åŒçš„å››èˆäº”å…¥å¤„ç†
            saveCalculationHistory({
                type: 'å¢™ä½“ç®—ç –',
                params: {
                    length: Math.round(length * 10000) / 10000,
                    height: Math.round(height * 10000) / 10000,
                    thickness: Math.round(thickness * 10000) / 10000,
                    mortar: Math.round(mortar * 10000) / 10000,
                    brickLength: Math.round(brickLength * 10000) / 10000,
                    brickWidth: Math.round(brickWidth * 10000) / 10000,
                    brickThickness: Math.round(brickThickness * 10000) / 10000,
                    hasWindow,
                    windowWidth: hasWindow ? Math.round(windowWidth * 10000) / 10000 : 0,
                    windowHeight: hasWindow ? Math.round(windowHeight * 10000) / 10000 : 0,
                    windowSillWidth: hasWindow ? Math.round(windowSillWidth * 10000) / 10000 : 0,
                hasDoor,
                doorWidth: hasDoor ? Math.round(doorWidth * 10000) / 10000 : 0,
                doorHeight: hasDoor ? Math.round(doorHeight * 10000) / 10000 : 0,
                doorThresholdWidth: hasDoor ? Math.round(doorThresholdWidth * 10000) / 10000 : 0
                },
                result: {
                    calculationMethod,
                    calculationScenario,
                    calculationFormula,
                    totalArea,
                    windowArea,
                    windowGlassArea: hasWindow ? windowGlassArea : 0,
                    windowBrickArea: hasWindow ? windowBrickArea : 0,
                    doorArea: hasDoor ? doorArea : 0,
                    doorBrickArea: hasDoor ? doorBrickArea : 0,
                    area,
                    totalBricks
                },
                timestamp: new Date().toISOString()
            });
        }
        
        // åœ°é¢ç®—ç –
        function calculateFloorBricks() {
            // è·å–è¾“å…¥å€¼ï¼ˆå•ä½ï¼šmmï¼‰
            const length = parseFloat(document.getElementById('floor-length').value) / 1000; // è½¬æ¢ä¸ºç±³
            const width = parseFloat(document.getElementById('floor-width').value) / 1000; // è½¬æ¢ä¸ºç±³
            const mortar = parseFloat(document.getElementById('floor-mortar').value) / 10; // è½¬æ¢ä¸ºcm
            const brickLength = parseFloat(document.getElementById('floor-brick-length').value) / 10; // è½¬æ¢ä¸ºcm
            const brickWidth = parseFloat(document.getElementById('floor-brick-width').value) / 10; // è½¬æ¢ä¸ºcm
            
            // éªŒè¯è¾“å…¥
            if (isNaN(length) || isNaN(width) || isNaN(brickLength) || isNaN(brickWidth) || 
                length <= 0 || width <= 0 || brickLength <= 0 || brickWidth <= 0) {
                showNotification('è®¡ç®—å¤±è´¥', 'è¯·è¾“å…¥æœ‰æ•ˆçš„é•¿åº¦ã€å®½åº¦å’Œç –å—å°ºå¯¸', 'error');
                return;
            }
            
            // è®¡ç®—é¢ç§¯
            const area = length * width;
            
            // è®¡ç®—å•å—ç –çš„é¢ç§¯
            const brickAreaWithMortar = (brickLength / 100) * (brickWidth / 100);
            
            // è®¡ç®—æ¯å¹³æ–¹ç±³æ‰€éœ€ç –å—æ•°
            const tilesPerSquareMeter = 1 / brickAreaWithMortar;
            
            // è®¡ç®—æ€»ç –å—æ•°
            const totalTiles = Math.ceil(area * tilesPerSquareMeter);
            
            // æ˜¾ç¤ºç»“æœ
            showCalculationResult({
                type: 'åœ°é¢ç®—ç –',
                params: {
                    length,
                    width,
                    mortar,
                    brickLength,
                    brickWidth
                },
                result: {
                    area,
                    totalTiles,
                    tilesPerSquareMeter: Math.round(tilesPerSquareMeter * 10) / 10
                }
            });
            
            // ä¿å­˜è®¡ç®—å†å²
            saveCalculationHistory({
                type: 'åœ°é¢ç®—ç –',
                params: {
                    length,
                    width,
                    mortar,
                    brickLength,
                    brickWidth
                },
                result: {
                    area,
                    totalTiles,
                    tilesPerSquareMeter: Math.round(tilesPerSquareMeter * 10) / 10
                },
                timestamp: new Date().toISOString()
            });
        }
        
        // æŸ±å­ç®—ç –
        function calculateColumnBricks() {
            // è·å–è¾“å…¥å€¼ï¼ˆå•ä½ï¼šmmï¼‰
            const perimeter = parseFloat(document.getElementById('column-perimeter').value); // ä¿æŒmmå•ä½
            const height = parseFloat(document.getElementById('column-height').value); // ä¿æŒmmå•ä½
            const mortar = parseFloat(document.getElementById('column-mortar').value); // ä¿æŒmmå•ä½
            const brickLength = parseFloat(document.getElementById('column-brick-length').value); // ä¿æŒmmå•ä½
            const brickWidth = parseFloat(document.getElementById('column-brick-width').value); // ä¿æŒmmå•ä½
            
            // éªŒè¯è¾“å…¥
            if (isNaN(perimeter) || isNaN(height) || isNaN(brickLength) || isNaN(brickWidth) || 
                perimeter <= 0 || height <= 0 || brickLength <= 0 || brickWidth <= 0) {
                showNotification('è®¡ç®—å¤±è´¥', 'è¯·è¾“å…¥æœ‰æ•ˆçš„å‘¨é•¿ã€é«˜åº¦å’Œç –å—å°ºå¯¸', 'error');
                return;
            }
            
            // è®¡ç®—å‘¨é•¿æ–¹å‘åˆ—æ•° = ceil(å‘¨é•¿/ç –å—é•¿åº¦)
            const columnCount = Math.ceil(perimeter / brickLength);
            
            // è®¡ç®—é«˜åº¦æ–¹å‘è¡Œæ•° = ceil(é«˜åº¦/ç –å—å®½åº¦)
            const rowCount = Math.ceil(height / brickWidth);
            
            // è®¡ç®—æ€»ç –å—æ•° = è¡Œæ•° Ã— åˆ—æ•°
            const totalBricks = rowCount * columnCount;
            
            // è®¡ç®—é¢ç§¯ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
            const area = (perimeter / 1000) * (height / 1000); // è½¬æ¢ä¸ºå¹³æ–¹ç±³
            
            // è®¡ç®—æ¯å¹³æ–¹ç±³æ‰€éœ€ç –å—æ•°ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
            const bricksPerSquareMeter = area > 0 ? Math.round((totalBricks / area) * 10) / 10 : 0;
            
            // æ˜¾ç¤ºç»“æœ
            showCalculationResult({
                type: 'æŸ±å­ç®—ç –',
                params: {
                    perimeter: perimeter / 1000, // è½¬æ¢ä¸ºç±³æ˜¾ç¤º
                    height: height / 1000, // è½¬æ¢ä¸ºç±³æ˜¾ç¤º
                    mortar: mortar / 10, // è½¬æ¢ä¸ºcmæ˜¾ç¤º
                    brickLength: brickLength / 10, // è½¬æ¢ä¸ºcmæ˜¾ç¤º
                    brickWidth: brickWidth / 10 // è½¬æ¢ä¸ºcmæ˜¾ç¤º
                },
                result: {
                    area,
                    totalBricks,
                    bricksPerSquareMeter
                }
            });
            
            // ä¿å­˜è®¡ç®—å†å²
            saveCalculationHistory({
                type: 'æŸ±å­ç®—ç –',
                params: {
                    perimeter: perimeter / 1000, // è½¬æ¢ä¸ºç±³ä¿å­˜
                    height: height / 1000, // è½¬æ¢ä¸ºç±³ä¿å­˜
                    mortar: mortar / 10, // è½¬æ¢ä¸ºcmä¿å­˜
                    brickLength: brickLength / 10, // è½¬æ¢ä¸ºcmä¿å­˜
                    brickWidth: brickWidth / 10 // è½¬æ¢ä¸ºcmä¿å­˜
                },
                result: {
                    area,
                    totalBricks,
                    bricksPerSquareMeter
                },
                timestamp: new Date().toISOString()
            });
        }
        
        // é¢ç§¯ç®—ç –
        function calculateAreaBricks() {
            // è·å–è¾“å…¥å€¼ï¼ˆå•ä½ï¼šmmï¼‰
            const area = parseFloat(document.getElementById('total-area').value); // å·²ç»æ˜¯å¹³æ–¹ç±³
            const mortar = parseFloat(document.getElementById('area-mortar').value) / 10; // è½¬æ¢ä¸ºcm
            const brickLength = parseFloat(document.getElementById('area-brick-length').value) / 10; // è½¬æ¢ä¸ºcm
            const brickWidth = parseFloat(document.getElementById('area-brick-width').value) / 10; // è½¬æ¢ä¸ºcm
            
            // éªŒè¯è¾“å…¥
            if (isNaN(area) || isNaN(brickLength) || isNaN(brickWidth) || 
                area <= 0 || brickLength <= 0 || brickWidth <= 0) {
                showNotification('è®¡ç®—å¤±è´¥', 'è¯·è¾“å…¥æœ‰æ•ˆçš„é¢ç§¯å’Œç –å—å°ºå¯¸', 'error');
                return;
            }
            
            // è®¡ç®—å•å—ç –çš„é¢ç§¯
            const brickAreaWithMortar = (brickLength / 100) * (brickWidth / 100);
            
            // è®¡ç®—æ¯å¹³æ–¹ç±³æ‰€éœ€ç –å—æ•°
            const tilesPerSquareMeter = 1 / brickAreaWithMortar;
            
            // è®¡ç®—æ€»ç –å—æ•°
            const totalTiles = Math.ceil(area * tilesPerSquareMeter);
            
            // æ˜¾ç¤ºç»“æœ
            showCalculationResult({
                type: 'é¢ç§¯ç®—ç –',
                params: {
                    area,
                    mortar,
                    brickLength,
                    brickWidth
                },
                result: {
                    totalTiles,
                    tilesPerSquareMeter: Math.round(tilesPerSquareMeter * 10) / 10
                }
            });
            
            // ä¿å­˜è®¡ç®—å†å²
            saveCalculationHistory({
                type: 'é¢ç§¯ç®—ç –',
                params: {
                    area,
                    mortar,
                    brickLength,
                    brickWidth
                },
                result: {
                    totalTiles,
                    tilesPerSquareMeter: Math.round(tilesPerSquareMeter * 10) / 10
                },
                timestamp: new Date().toISOString()
            });
        }
        
        // æ¥¼æ¢¯ç®—ç – - æœ€æ–°ä¼˜åŒ–ç‰ˆï¼ˆåŸºäºæ€»éœ€æ±‚å•ä½æ•°å…¬å¼ï¼‰
        function calculateStairBricks() {
            console.log('å¼€å§‹è®¡ç®—æ¥¼æ¢¯ç –å—...');
            
            // è·å–è¾“å…¥å€¼ï¼ˆå•ä½ï¼šmmï¼‰
            const width = parseFloat(document.getElementById('stair-width').value) / 10; // è½¬æ¢ä¸ºcm
            const height = parseFloat(document.getElementById('stair-height').value) / 10; // è½¬æ¢ä¸ºcm
            const stepCount = parseInt(document.getElementById('stair-step').value);
            const stepHeight = parseFloat(document.getElementById('stair-step-height').value) / 10; // è½¬æ¢ä¸ºcm
            const brickLength = parseFloat(document.getElementById('stair-brick-length').value) / 10; // è½¬æ¢ä¸ºcm
            const brickWidth = parseFloat(document.getElementById('stair-brick-width').value) / 10; // è½¬æ¢ä¸ºcm
            const lossFactor = parseFloat(document.getElementById('stair-loss-factor')?.value || 0.1); // æŸè€—ç³»æ•°ï¼Œé»˜è®¤ä¸º10%
            
            console.log('è¾“å…¥å‚æ•°:', { width, height, stepCount, stepHeight, brickLength, brickWidth, lossFactor });
            
            // éªŒè¯è¾“å…¥
            if (isNaN(width) || isNaN(height) || isNaN(stepCount) || isNaN(stepHeight) || 
                isNaN(brickLength) || isNaN(brickWidth) || 
                width <= 0 || height <= 0 || stepCount <= 0 || stepHeight <= 0 || 
                brickLength <= 0 || brickWidth <= 0) {
                console.error('è¾“å…¥éªŒè¯å¤±è´¥');
                showNotification('è®¡ç®—å¤±è´¥', 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ¥¼æ¢¯å‚æ•°å’Œç –å—å°ºå¯¸', 'error');
                return;
            }
            
            // ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„å°é˜¶é•¿åº¦
            const stepLength = height; // ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„å°é˜¶é•¿åº¦
            console.log('å°é˜¶é•¿åº¦:', stepLength);
            
            // å°†æ‰€æœ‰å•ä½è½¬æ¢ä¸ºå˜ç±³è¿›è¡Œè®¡ç®—
            const widthCM = width * 100; // å°é˜¶å®½åº¦(cm)
            const lengthCM = stepLength * 100; // å°é˜¶é•¿åº¦(cm)
            const stepHeightCM = stepHeight; // å°é˜¶é«˜åº¦(cm)
            const brickLengthCM = brickLength; // ç“·ç –é•¿åº¦(cm)
            const brickWidthCM = brickWidth; // ç“·ç –å®½åº¦(cm)
            
            console.log('è½¬æ¢ä¸ºå˜ç±³åçš„å‚æ•°:', { widthCM, lengthCM, stepHeightCM, brickLengthCM, brickWidthCM });
            
            // æ£€æŸ¥ç“·ç –é•¿åº¦æ˜¯å¦è¶³å¤Ÿè¦†ç›–å°é˜¶é•¿åº¦
            let totalTiles;
            let calculationMethod = 'é¢ç§¯è®¡ç®—';
            let stepsPerBrick = 0;
            let risersPerBrick = 0;
            let cuttingPlan = [];
            let singleStepTiles = 0;
            let maxOutputPerBrick = 0; // Kå€¼ï¼šå•å—ç“·ç –æœ€å¤§äº§å‡ºå•ä½æ•°
            let totalDemandUnits = 0; // Tå€¼ï¼šæ€»éœ€æ±‚å•ä½æ•°
            
            if (brickLengthCM >= lengthCM) {
                console.log('ç“·ç –é•¿åº¦è¶³å¤Ÿè¦†ç›–å°é˜¶é•¿åº¦ï¼Œä½¿ç”¨ä¼˜åŒ–çš„åˆ‡å‰²è®¡ç®—æ–¹æ³•');
                calculationMethod = 'å•ä½æ•°ä¼˜åŒ–è®¡ç®—';
                
                // è®¡ç®—æ€»éœ€æ±‚å•ä½æ•° T = N + N = 2Nï¼ˆNä¸ºå°é˜¶æ•°é‡ï¼‰
                totalDemandUnits = 2 * stepCount;
                console.log('æ€»éœ€æ±‚å•ä½æ•° T = 2 Ã—', stepCount, '=', totalDemandUnits);
                
                // è®¡ç®—å•ä¸ªè¸é¢å’Œè¸¢é¢çš„å°ºå¯¸
                const stepWidthCM = widthCM; // è¸é¢å®½åº¦
                const stepLengthCM = lengthCM; // è¸é¢é•¿åº¦
                const riserHeightCM = stepHeightCM; // è¸¢é¢é«˜åº¦
                const riserLengthCM = lengthCM; // è¸¢é¢é•¿åº¦
                
                console.log('è¸é¢å°ºå¯¸:', stepLengthCM, 'Ã—', stepWidthCM, 'cm');
                console.log('è¸¢é¢å°ºå¯¸:', riserLengthCM, 'Ã—', riserHeightCM, 'cm');
                
                // å¯»æ‰¾æœ€ä¼˜çš„aå’Œbç»„åˆï¼Œä½¿å¾—aÃ—stepWidthCM + bÃ—riserHeightCM â‰¤ brickWidthCMï¼Œä¸”K = a + bæœ€å¤§
                let bestA = 0;
                let bestB = 0;
                maxOutputPerBrick = 0;
                
                // éå†å¯èƒ½çš„aå€¼ï¼ˆè¸é¢æ•°é‡ï¼‰
                for (let a = 0; a <= Math.floor(brickWidthCM / stepWidthCM); a++) {
                    // å¯¹äºæ¯ä¸ªaå€¼ï¼Œè®¡ç®—æœ€å¤§å¯èƒ½çš„bå€¼ï¼ˆè¸¢é¢æ•°é‡ï¼‰
                    const remainingWidthForRisers = brickWidthCM - a * stepWidthCM;
                    const b = Math.floor(remainingWidthForRisers / riserHeightCM);
                    
                    // è®¡ç®—å½“å‰ç»„åˆçš„Kå€¼
                    const currentK = a + b;
                    
                    // å¦‚æœå½“å‰ç»„åˆçš„Kå€¼æ›´å¤§ï¼Œæ›´æ–°æœ€ä¼˜è§£
                    if (currentK > maxOutputPerBrick) {
                        maxOutputPerBrick = currentK;
                        bestA = a;
                        bestB = b;
                    }
                }
                
                console.log('æœ€ä¼˜åˆ‡å‰²æ–¹æ¡ˆ: æ¯å—ç“·ç –å¯åˆ‡å‰²', bestA, 'ä¸ªè¸é¢ +', bestB, 'ä¸ªè¸¢é¢ =', maxOutputPerBrick, 'ä¸ªå•ä½');
                console.log('å•å—ç“·ç –æœ€å¤§äº§å‡º K =', maxOutputPerBrick);
                
                // å¦‚æœæ‰¾åˆ°äº†å¯è¡Œçš„åˆ‡å‰²æ–¹æ¡ˆ
                if (maxOutputPerBrick > 0) {
                    stepsPerBrick = bestA;
                    risersPerBrick = bestB;
                    
                    // è®°å½•åˆ‡å‰²è®¡åˆ’
                    cuttingPlan = [{ type: 'æœ€ä¼˜æ–¹æ¡ˆ', tiles: 1, steps: bestA, risers: bestB, output: maxOutputPerBrick }];
                    
                    // ä½¿ç”¨å…¬å¼è®¡ç®—åŸºç¡€ç“·ç –æ•°é‡ï¼šâŒˆT/KâŒ‰
                    const baseTiles = Math.ceil(totalDemandUnits / maxOutputPerBrick);
                    console.log('åŸºç¡€ç“·ç –æ•°é‡ = âŒˆ', totalDemandUnits, '/', maxOutputPerBrick, 'âŒ‰ =', baseTiles);
                    
                    // è®¡ç®—å«æŸè€—çš„ç“·ç –æ•°é‡ï¼šâŒˆåŸºç¡€æ•°é‡ Ã— (1 + Î·)âŒ‰
                    totalTiles = Math.ceil(baseTiles * (1 + lossFactor));
                    console.log('å«æŸè€—ç“·ç –æ•°é‡ = âŒˆ', baseTiles, 'Ã— (1 +', lossFactor, ')âŒ‰ =', totalTiles);
                    
                    // è®¡ç®—å•ä¸ªå°é˜¶æ‰€éœ€çš„å¹³å‡ç –å—æ•°
                    singleStepTiles = totalTiles / stepCount;
                    
                    // è¯¦ç»†çš„åˆ‡å‰²è®¡åˆ’
                    const exactTilesNeeded = Math.ceil(totalDemandUnits / maxOutputPerBrick);
                    const tilesWithLoss = Math.ceil(exactTilesNeeded * (1 + lossFactor));
                    
                    cuttingPlan = [
                        { 
                            type: 'ç†è®ºéœ€æ±‚', 
                            tiles: exactTilesNeeded, 
                            description: `æ»¡è¶³${totalDemandUnits}ä¸ªå•ä½éœ€æ±‚` 
                        },
                        { 
                            type: 'æŸè€—é¢„ç•™', 
                            tiles: tilesWithLoss - exactTilesNeeded, 
                            description: `é¢„ç•™${(lossFactor * 100).toFixed(0)}%æŸè€—` 
                        }
                    ];
                    
                } else {
                    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å¯è¡Œçš„åˆ‡å‰²æ–¹æ¡ˆï¼Œå›é€€åˆ°ç®€å•çš„åˆ‡å‰²è®¡ç®—
                    console.log('æœªæ‰¾åˆ°å¯è¡Œçš„åˆ‡å‰²æ–¹æ¡ˆï¼Œä½¿ç”¨ç®€å•çš„åˆ‡å‰²è®¡ç®—');
                    
                    // è®¡ç®—ä¸€å—ç“·ç –å¯ä»¥åˆ‡å‰²å‡ºå¤šå°‘ä¸ªå°é˜¶é¢ï¼ˆåŸºäºå°é˜¶å®½åº¦ï¼‰
                    stepsPerBrick = Math.floor(brickWidthCM / stepWidthCM);
                    console.log('ä¸€å—ç“·ç –å¯ä»¥åˆ‡å‰²å‡ºçš„å°é˜¶é¢æ•°é‡:', stepsPerBrick);
                    
                    // è®¡ç®—å‰©ä½™ç“·ç –å®½åº¦å¯ä»¥åˆ‡å‰²å‡ºå¤šå°‘ä¸ªè¸¢é¢ï¼ˆåŸºäºå°é˜¶é«˜åº¦ï¼‰
                    const remainingWidthCM = brickWidthCM % stepWidthCM;
                    risersPerBrick = Math.floor(remainingWidthCM / stepHeightCM);
                    console.log('å‰©ä½™ç“·ç –å®½åº¦:', remainingWidthCM, 'cmï¼Œå¯ä»¥åˆ‡å‰²å‡ºçš„è¸¢é¢æ•°é‡:', risersPerBrick);
                    
                    // è®¡ç®—å•å—ç“·ç –çš„äº§å‡ºå•ä½æ•°
                    maxOutputPerBrick = stepsPerBrick + risersPerBrick;
                    console.log('å•å—ç“·ç –äº§å‡ºå•ä½æ•° K =', maxOutputPerBrick);
                    
                    // è®¡ç®—åŸºç¡€ç“·ç –æ•°é‡
                    const baseTiles = Math.ceil(totalDemandUnits / maxOutputPerBrick);
                    console.log('åŸºç¡€ç“·ç –æ•°é‡ = âŒˆ', totalDemandUnits, '/', maxOutputPerBrick, 'âŒ‰ =', baseTiles);
                    
                    // è®¡ç®—å«æŸè€—çš„ç“·ç –æ•°é‡
                    totalTiles = Math.ceil(baseTiles * (1 + lossFactor));
                    console.log('å«æŸè€—ç“·ç –æ•°é‡ = âŒˆ', baseTiles, 'Ã— (1 +', lossFactor, ')âŒ‰ =', totalTiles);
                    
                    // è®¡ç®—å•ä¸ªå°é˜¶æ‰€éœ€çš„å¹³å‡ç –å—æ•°
                    singleStepTiles = totalTiles / stepCount;
                }
                
            } else {
                console.log('ç“·ç –é•¿åº¦ä¸è¶³ä»¥è¦†ç›–å°é˜¶é•¿åº¦ï¼Œä½¿ç”¨åŸæœ‰çš„é¢ç§¯è®¡ç®—æ–¹æ³•');
                
                // è®¡ç®—å•å—ç –çš„é¢ç§¯
                const brickAreaWithMortar = (brickLength / 100) * (brickWidth / 100);
                console.log('ç –å—é¢ç§¯:', brickAreaWithMortar);
                
                // æŒ‰ç…§å…¬å¼è®¡ç®—ï¼šï¼ˆå°é˜¶å®½åº¦ Ã— å°é˜¶é•¿åº¦ Ã· ç –å—é¢ç§¯ + å°é˜¶é•¿åº¦ Ã— å°é˜¶é«˜åº¦ Ã· ç –å—é¢ç§¯ï¼‰Ã— å°é˜¶æ•°é‡ = ç”¨ç –æ€»é‡
                // å°é˜¶é¢æ‰€éœ€ç –å—æ•° = å°é˜¶å®½åº¦ Ã— å°é˜¶é•¿åº¦ Ã· ç –å—é¢ç§¯
                const stepSurfaceTiles = Math.ceil((width * stepLength) / brickAreaWithMortar);
                console.log('å°é˜¶é¢æ‰€éœ€ç –å—æ•°:', stepSurfaceTiles);
                
                // è¸¢é¢æ‰€éœ€ç –å—æ•° = å°é˜¶é•¿åº¦ Ã— å°é˜¶é«˜åº¦ Ã· ç –å—é¢ç§¯
                const stepVerticalTiles = Math.ceil((stepLength * (stepHeight / 100)) / brickAreaWithMortar);
                console.log('è¸¢é¢æ‰€éœ€ç –å—æ•°:', stepVerticalTiles);
                
                // å•ä¸ªå°é˜¶æ‰€éœ€æ€»ç –å—æ•°
                singleStepTiles = stepSurfaceTiles + stepVerticalTiles;
                console.log('å•ä¸ªå°é˜¶æ‰€éœ€æ€»ç –å—æ•°:', singleStepTiles);
                
                // æ€»ç –å—æ•° = (å°é˜¶é¢æ‰€éœ€ç –å—æ•° + è¸¢é¢æ‰€éœ€ç –å—æ•°) Ã— å°é˜¶æ•°é‡
                const baseTiles = Math.ceil((stepSurfaceTiles + stepVerticalTiles) * stepCount);
                console.log('åŸºç¡€æ€»ç –å—æ•°:', baseTiles);
                
                // è€ƒè™‘æŸè€—
                totalTiles = Math.ceil(baseTiles * (1 + lossFactor));
                console.log('å«æŸè€—æ€»ç –å—æ•°:', totalTiles);
            }
            
            // è®¡ç®—æ¯ä¸ªå°é˜¶çš„é¢ç§¯ï¼ˆå°é˜¶é¢ + è¸¢é¢ï¼‰
            const stepSurfaceArea = width * stepLength; // æ¯ä¸ªå°é˜¶é¢çš„é¢ç§¯ï¼ˆå®½åº¦Ã—é•¿åº¦ï¼‰
            const stepVerticalArea = stepLength * (stepHeight / 100); // æ¯ä¸ªå°é˜¶è¸¢é¢çš„é¢ç§¯ï¼ˆé•¿åº¦Ã—é«˜åº¦ï¼Œå°†cmè½¬æ¢ä¸ºmï¼‰
            
            // è®¡ç®—æ€»è¡¨é¢ç§¯ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
            const totalStepArea = stepSurfaceArea * stepCount; // æ‰€æœ‰å°é˜¶é¢çš„æ€»é¢ç§¯
            const totalRiserArea = stepVerticalArea * stepCount; // æ‰€æœ‰è¸¢é¢çš„æ€»é¢ç§¯
            const totalStairArea = totalStepArea + totalRiserArea; // æ¥¼æ¢¯æ€»è¡¨é¢ç§¯
            
            // è®¡ç®—æ¯å¹³æ–¹ç±³æ‰€éœ€ç –å—æ•°ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
            const brickAreaWithMortar = (brickLength / 100) * (brickWidth / 100);
            const tilesPerSquareMeter = 1 / brickAreaWithMortar;
            
            // æ˜¾ç¤ºç»“æœ
            showCalculationResult({
                type: 'æ¥¼æ¢¯ç®—ç –',
                params: {
                    width,
                    height,
                    stepCount,
                    stepHeight,
                    brickLength,
                    brickWidth
                },
                result: {
                    stepHeight: stepHeight.toFixed(2),
                    stepLength: stepLength.toFixed(2),
                    stepSurfaceArea: stepSurfaceArea.toFixed(2),
                    stepVerticalArea: stepVerticalArea.toFixed(2),
                    singleStepTiles: singleStepTiles,
                    totalStepArea: totalStepArea.toFixed(2),
                    totalRiserArea: totalRiserArea.toFixed(2),
                    totalStairArea: totalStairArea.toFixed(2),
                    totalTiles,
                    tilesPerSquareMeter: Math.round(tilesPerSquareMeter * 10) / 10,
                    calculationMethod: calculationMethod,
                    stepsPerBrick: calculationMethod === 'åˆ‡å‰²ä¼˜åŒ–è®¡ç®—' ? Math.floor(brickWidthMM / widthMM) : 0,
                    risersPerBrick: calculationMethod === 'åˆ‡å‰²ä¼˜åŒ–è®¡ç®—' ? Math.floor((brickWidthMM % widthMM) / stepHeightMM) : 0
                }
            });
            
            // ä¿å­˜è®¡ç®—å†å²
            saveCalculationHistory({
                type: 'æ¥¼æ¢¯ç®—ç –',
                params: {
                    width,
                    height,
                    stepCount,
                    stepHeight,
                    brickLength,
                    brickWidth
                },
                result: {
                    stepHeight: stepHeight.toFixed(2),
                    stepLength: stepLength.toFixed(2),
                    stepSurfaceArea: stepSurfaceArea.toFixed(2),
                    stepVerticalArea: stepVerticalArea.toFixed(2),
                    singleStepTiles: singleStepTiles,
                    totalStepArea: totalStepArea.toFixed(2),
                    totalRiserArea: totalRiserArea.toFixed(2),
                    totalStairArea: totalStairArea.toFixed(2),
                    totalTiles,
                    tilesPerSquareMeter: Math.round(tilesPerSquareMeter * 10) / 10
                },
                timestamp: new Date().toISOString()
            });
            
            console.log('è®¡ç®—å®Œæˆï¼Œç»“æœå·²æ˜¾ç¤º');
        }
        
        // åˆå§‹åŒ–èƒŒæ™¯å¢™ç®—ç –åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            // è¾¹æ¡†è®¾ç½®æ˜¾ç¤º/éšè—é€»è¾‘
            const hasBorderCheckbox = document.getElementById('has-decoration');
            const borderSettings = document.getElementById('decoration-options');
            
            if (hasBorderCheckbox && borderSettings) {
                hasBorderCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        borderSettings.classList.remove('hidden');
                        // å½“å¯ç”¨è¾¹æ¡†æ—¶ï¼ŒåŒæ­¥èƒŒæ™¯å¢™å°ºå¯¸åˆ°è¾¹æ¡†
                        syncWallpaperDimensions();
                    } else {
                        borderSettings.classList.add('hidden');
                    }
                });
            }
            
            // åŒæ­¥èƒŒæ™¯å¢™å°ºå¯¸åˆ°è¾¹æ¡†çš„å‡½æ•°
            function syncWallpaperDimensions() {
                const useWallpaperLength = document.getElementById('use-wallpaper-length');
                const useWallpaperHeight = document.getElementById('use-wallpaper-height');
                const wallpaperLength = document.getElementById('wallpaper-length');
                const wallpaperHeight = document.getElementById('wallpaper-height');
                const borderLength = document.getElementById('border-length');
                const borderHeight = document.getElementById('border-height');
                
                if (useWallpaperLength && useWallpaperLength.checked && wallpaperLength && borderLength) {
                    borderLength.value = wallpaperLength.value || '4';
                    borderLength.disabled = true;
                } else if (borderLength) {
                    borderLength.disabled = false;
                }
                
                if (useWallpaperHeight && useWallpaperHeight.checked && wallpaperHeight && borderHeight) {
                    borderHeight.value = wallpaperHeight.value || '3';
                    borderHeight.disabled = true;
                } else if (borderHeight) {
                    borderHeight.disabled = false;
                }
            }
            
            // ç›‘å¬èƒŒæ™¯å¢™å°ºå¯¸å˜åŒ–
            const wallpaperLength = document.getElementById('wallpaper-length');
            const wallpaperHeight = document.getElementById('wallpaper-height');
            
            if (wallpaperLength) {
                wallpaperLength.addEventListener('input', function() {
                    const useWallpaperLength = document.getElementById('use-wallpaper-length');
                    const borderLength = document.getElementById('border-length');
                    if (useWallpaperLength && useWallpaperLength.checked && borderLength) {
                        borderLength.value = this.value;
                    }
                });
            }
            
            if (wallpaperHeight) {
                wallpaperHeight.addEventListener('input', function() {
                    const useWallpaperHeight = document.getElementById('use-wallpaper-height');
                    const borderHeight = document.getElementById('border-height');
                    if (useWallpaperHeight && useWallpaperHeight.checked && borderHeight) {
                        borderHeight.value = this.value;
                    }
                });
            }
            
            // åŒæ­¥è®¡ç®—å‚æ•°çš„å¤é€‰æ¡†åŠŸèƒ½å·²ç§»é™¤
        });


        

        

        
        // æ˜¾ç¤ºè®¡ç®—ç»“æœ
        function showCalculationResult(data) {
            const resultContainer = document.getElementById('calculation-result');
            
            let resultHtml = '';
            
            if (data.type === 'å¢™ä½“ç®—ç –' || data.type === 'æŸ±å­ç®—ç –') {
                resultHtml = `
                    <div class="space-y-4">
                        <div class="bg-light-1 rounded-lg p-4">
                            <h4 class="font-medium text-dark mb-2">è®¡ç®—ç»“æœ</h4>
                            <div class="grid grid-cols-2 gap-4">
                                ${data.type === 'å¢™ä½“ç®—ç –' ? `
                                    <div class="col-span-2">
                                        <p class="text-sm text-dark-3">è®¡ç®—æ–¹æ³•</p>
                                        <p class="text-lg font-semibold text-dark">${data.result.calculationMethod}</p>
                                    </div>
                                ` : ''}
                                ${data.type === 'å¢™ä½“ç®—ç –' && data.params.hasWindow ? `
                                    <div>
                                        <p class="text-sm text-dark-3">å¢™ä½“æ€»é¢ç§¯</p>
                                        <p class="text-lg font-semibold text-dark">${data.result.totalArea.toFixed(2)} ã¡</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-dark-3">çª—æˆ·é¢ç§¯</p>
                                        <p class="text-lg font-semibold text-dark">${data.result.windowGlassArea ? data.result.windowGlassArea.toFixed(2) : '0.00'} ã¡</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-dark-3">çª—æˆ·è´´ç –é¢ç§¯</p>
                                        <p class="text-lg font-semibold text-dark">${data.result.windowBrickArea ? data.result.windowBrickArea.toFixed(2) : '0.00'} ã¡</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-dark-3">å®é™…è´´ç –é¢ç§¯</p>
                                        <p class="text-lg font-semibold text-dark">${data.result.area.toFixed(2)} ã¡</p>
                                    </div>
                                ` : `
                                    <div>
                                        <p class="text-sm text-dark-3">é¢ç§¯</p>
                                        <p class="text-lg font-semibold text-dark">${data.result.area.toFixed(2)} ã¡</p>
                                    </div>
                                `}
                                <div>
                                    <p class="text-sm text-dark-3">æ‰€éœ€ç –å—</p>
                                    <p class="text-lg font-semibold text-primary">${data.result.totalBricks} å—</p>
                                </div>
                                ${data.type === 'æŸ±å­ç®—ç –' ? `
                                    <div>
                                        <p class="text-sm text-dark-3">æ¯å¹³ç±³ç”¨ç –</p>
                                        <p class="text-base font-medium text-dark">${data.result.bricksPerSquareMeter} å—</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="bg-light-1 rounded-lg p-4">
                            <h4 class="font-medium text-dark mb-2">è®¡ç®—å‚æ•°</h4>
                            <div class="space-y-2 text-sm">
                                ${data.type === 'å¢™ä½“ç®—ç –' ? `
                                    <p><span class="text-dark-3">å¢™ä½“é•¿åº¦:</span> ${data.params.length} m</p>
                                    <p><span class="text-dark-3">å¢™ä½“é«˜åº¦:</span> ${data.params.height} m</p>
                                    <p><span class="text-dark-3">å¢™ä½“åšåº¦:</span> ${data.params.thickness === 0 ? 'æ— ' : data.params.thickness + ' cm'}</p>
                                    ${data.params.hasWindow ? `
                                        <p><span class="text-dark-3">çª—æˆ·å®½åº¦:</span> ${data.params.windowWidth} m</p>
                                        <p><span class="text-dark-3">çª—æˆ·é«˜åº¦:</span> ${data.params.windowHeight} m</p>
                                        <p><span class="text-dark-3">çª—å°å®½åº¦:</span> ${data.params.windowSillWidth} cm</p>
                                    ` : ''}
                                ` : `
                                    <p><span class="text-dark-3">æŸ±å­å‘¨é•¿:</span> ${data.params.perimeter} m</p>
                                    <p><span class="text-dark-3">æŸ±å­é«˜åº¦:</span> ${data.params.height} m</p>
                                `}
                                <p><span class="text-dark-3">ç°ç¼åšåº¦:</span> ${data.params.mortar} cm</p>
                            </div>
                        </div>
                    </div>
                `;
            } else if (data.type === 'åœ°é¢ç®—ç –') {
                resultHtml = `
                    <div class="space-y-4">
                        <div class="bg-light-1 rounded-lg p-4">
                            <h4 class="font-medium text-dark mb-2">è®¡ç®—ç»“æœ</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm text-dark-3">é¢ç§¯</p>
                                    <p class="text-lg font-semibold text-dark">${data.result.area.toFixed(2)} ã¡</p>
                                </div>
                                <div>
                                    <p class="text-sm text-dark-3">æ‰€éœ€ç“·ç –</p>
                                    <p class="text-lg font-semibold text-primary">${data.result.totalTiles} å—</p>
                                </div>
                                <div>
                                    <p class="text-sm text-dark-3">æ¯å¹³ç±³ç”¨ç –</p>
                                    <p class="text-base font-medium text-dark">${data.result.tilesPerSquareMeter.toFixed(2)} å—</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-light-1 rounded-lg p-4">
                            <h4 class="font-medium text-dark mb-2">è®¡ç®—å‚æ•°</h4>
                            <div class="space-y-2 text-sm">
                                <p><span class="text-dark-3">åœ°é¢é•¿åº¦:</span> ${data.params.length} m</p>
                                <p><span class="text-dark-3">åœ°é¢å®½åº¦:</span> ${data.params.width} m</p>
                                <p><span class="text-dark-3">ç°ç¼åšåº¦:</span> ${data.params.mortar} cm</p>
                            </div>
                        </div>
                    </div>
                `;
            } else if (data.type === 'é¢ç§¯ç®—ç –') {
                resultHtml = `
                    <div class="space-y-4">
                        <div class="bg-light-1 rounded-lg p-4">
                            <h4 class="font-medium text-dark mb-2">è®¡ç®—ç»“æœ</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm text-dark-3">é¢ç§¯</p>
                                    <p class="text-lg font-semibold text-dark">${data.params.area.toFixed(2)} ã¡</p>
                                </div>
                                <div>
                                    <p class="text-sm text-dark-3">æ‰€éœ€ç“·ç –</p>
                                    <p class="text-lg font-semibold text-primary">${data.result.totalTiles} å—</p>
                                </div>
                                <div>
                                    <p class="text-sm text-dark-3">æ¯å¹³ç±³ç”¨ç –</p>
                                    <p class="text-base font-medium text-dark">${data.result.tilesPerSquareMeter.toFixed(2)} å—</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-light-1 rounded-lg p-4">
                            <h4 class="font-medium text-dark mb-2">è®¡ç®—å‚æ•°</h4>
                            <div class="space-y-2 text-sm">
                                <p><span class="text-dark-3">æ€»é¢ç§¯:</span> ${data.params.area} ã¡</p>
                                <p><span class="text-dark-3">ç°ç¼åšåº¦:</span> ${data.params.mortar} cm</p>
                            </div>
                        </div>
                    </div>
                `;

                resultHtml = `
                    <div class="space-y-4">
                        <div class="bg-light-1 rounded-lg p-4">
                            <h4 class="font-medium text-dark mb-2">è®¡ç®—ç»“æœ</h4>
                            <div class="mb-4">
                                <p class="text-sm text-dark-3">è´´ç –åœºæ™¯</p>
                                <p class="text-lg font-semibold text-dark">${data.result.scenarioName || 'æœªçŸ¥åœºæ™¯'}</p>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm text-dark-3">æ­£é¢é¢ç§¯</p>
                                    <p class="text-lg font-semibold text-dark">${typeof data.result.frontArea === 'number' ? data.result.frontArea.toFixed(2) : (data.result.frontArea || '0.00')} ã¡</p>
                                </div>
                                <div>
                                    <p class="text-sm text-dark-3">ä¾§é¢é¢ç§¯</p>
                                    <p class="text-lg font-semibold text-dark">${typeof data.result.sideArea === 'number' ? data.result.sideArea.toFixed(2) : (data.result.sideArea || '0.00')} ã¡</p>
                                </div>
                                <div>
                                    <p class="text-sm text-dark-3">æ€»è´´ç –é¢ç§¯</p>
                                    <p class="text-lg font-semibold text-dark">${typeof data.result.totalArea === 'number' ? data.result.totalArea.toFixed(2) : (data.result.totalArea || '0.00')} ã¡</p>
                                </div>
                                <div>
                                    <p class="text-sm text-dark-3">ç†è®ºç –å—æ•°</p>
                                    <p class="text-lg font-semibold text-dark">${typeof data.result.theoreticalTiles === 'number' ? data.result.theoreticalTiles.toFixed(2) : (data.result.theoreticalTiles || '0.00')} å—</p>
                                </div>
                                <div>
                                    <p class="text-sm text-dark-3">å®é™…éœ€è¦ç –å—</p>
                                    <p class="text-lg font-semibold text-primary">${data.result.actualTiles} å—</p>
                                </div>
                                <div>
                                    <p class="text-sm text-dark-3">æ¯å¹³ç±³ç”¨ç –</p>
                                    <p class="text-base font-medium text-dark">${typeof data.result.tilesPerSquareMeter === 'number' ? data.result.tilesPerSquareMeter.toFixed(2) : (data.result.tilesPerSquareMeter || '0.00')} å—</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-light-1 rounded-lg p-4">
                            <h4 class="font-medium text-dark mb-2">è®¡ç®—å‚æ•°</h4>
                            <div class="space-y-2 text-sm">
                                <p><span class="text-dark-3">èƒŒæ™¯å¢™é•¿åº¦:</span> ${data.params.length} mm</p>
                                <p><span class="text-dark-3">èƒŒæ™¯å¢™é«˜åº¦:</span> ${data.params.height} mm</p>
                                <p><span class="text-dark-3">èƒŒæ™¯å¢™åšåº¦:</span> ${data.params.thickness} mm</p>
                                <p><span class="text-dark-3">ç –å—å°ºå¯¸:</span> ${data.params.brickLength} Ã— ${data.params.brickWidth} mm</p>
                                <p><span class="text-dark-3">æµªè´¹ç‡:</span> ${data.params.wasteRate}%</p>
                            </div>
                        </div>
                    </div>
                `;
            } else if (data.type === 'æ¥¼æ¢¯ç®—ç –') {
                resultHtml = `
                    <div class="space-y-4">
                        <div class="bg-light-1 rounded-lg p-4">
                            <h4 class="font-medium text-dark mb-2">è®¡ç®—ç»“æœ</h4>
                            <div class="mb-4">
                                <p class="text-sm text-dark-3">è®¡ç®—æ–¹æ³•</p>
                                <p class="text-lg font-semibold text-dark">${data.result.calculationMethod || 'é¢ç§¯è®¡ç®—'}</p>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm text-dark-3">å°é˜¶æ•°é‡</p>
                                    <p class="text-lg font-semibold text-dark">${data.params.stepCount} çº§</p>
                                </div>
                                <div>
                                    <p class="text-sm text-dark-3">å°é˜¶é«˜åº¦</p>
                                    <p class="text-lg font-semibold text-dark">${data.result.stepHeight} cm</p>
                                </div>
                                <div>
                                    <p class="text-sm text-dark-3">å°é˜¶å®½åº¦</p>
                                    <p class="text-lg font-semibold text-dark">${data.result.stepLength} m</p>
                                </div>
                                <div>
                                    <p class="text-sm text-dark-3">å°é˜¶é¢é¢ç§¯</p>
                                    <p class="text-lg font-semibold text-dark">${data.result.stepSurfaceArea} ã¡</p>
                                </div>
                                <div>
                                    <p class="text-sm text-dark-3">è¸¢é¢é¢ç§¯</p>
                                    <p class="text-lg font-semibold text-dark">${data.result.stepVerticalArea} ã¡</p>
                                </div>
                                <div>
                                    <p class="text-sm text-dark-3">å•å°é˜¶ç –å—æ•°</p>
                                    <p class="text-lg font-semibold text-dark">${data.result.singleStepTiles} å—</p>
                                </div>
                                <div>
                                    <p class="text-sm text-dark-3">æ€»æ¥¼æ¢¯é¢ç§¯</p>
                                    <p class="text-lg font-semibold text-dark">${data.result.totalStairArea} ã¡</p>
                                </div>
                                <div>
                                    <p class="text-sm text-dark-3">æ‰€éœ€ç“·ç –</p>
                                    <p class="text-lg font-semibold text-primary">${data.result.totalTiles} å—</p>
                                </div>
                                <div>
                                    <p class="text-sm text-dark-3">æ¯å¹³ç±³ç”¨ç –</p>
                                    <p class="text-base font-medium text-dark">${data.result.tilesPerSquareMeter} å—</p>
                                </div>
                                <div>
                                    <p class="text-sm text-dark-3">å°é˜¶å®½åº¦</p>
                                    <p class="text-base font-medium text-dark">${data.params.width} m</p>
                                </div>
                                ${data.result.calculationMethod === 'åˆ‡å‰²ä¼˜åŒ–è®¡ç®—' ? `
                                    <div class="col-span-2">
                                        <div class="p-3 bg-blue-50 rounded-lg">
                                            <h4 class="font-semibold text-blue-800 mb-2">åˆ‡å‰²ä¼˜åŒ–è¯¦æƒ…</h4>
                                            <div class="grid grid-cols-2 gap-3">
                                                <div>
                                                    <p class="text-sm text-blue-700">ä¸€å—ç“·ç –å¯åˆ‡å‰²çš„å°é˜¶é¢æ•°é‡</p>
                                                    <p class="text-lg font-bold">${data.result.stepsPerBrick} ä¸ª</p>
                                                </div>
                                                <div>
                                                    <p class="text-sm text-blue-700">ä¸€å—ç“·ç –å¯åˆ‡å‰²çš„è¸¢é¢æ•°é‡</p>
                                                    <p class="text-lg font-bold">${data.result.risersPerBrick} ä¸ª</p>
                                                </div>
                                            </div>
                                            <p class="mt-2 text-sm text-blue-600">
                                                æ³¨ï¼šæ­¤è®¡ç®—åŸºäºç“·ç –çš„å®é™…åˆ‡å‰²å¯èƒ½æ€§ï¼Œè€ƒè™‘äº†ææ–™åˆ©ç”¨ç‡çš„æœ€å¤§åŒ–ã€‚
                                            </p>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="bg-light-1 rounded-lg p-4">
                            <h4 class="font-medium text-dark mb-2">è®¡ç®—å‚æ•°</h4>
                            <div class="space-y-2 text-sm">
                                <p><span class="text-dark-3">æ¥¼æ¢¯å®½åº¦:</span> ${data.params.width} m</p>
                                <p><span class="text-dark-3">æ¥¼æ¢¯é«˜åº¦:</span> ${data.params.height} m</p>
                                <p><span class="text-dark-3">å°é˜¶é«˜åº¦:</span> ${data.params.stepHeight} cm</p>
                                <p><span class="text-dark-3">ç –å—é•¿åº¦:</span> ${data.params.brickLength} cm</p>
                                <p><span class="text-dark-3">ç –å—å®½åº¦:</span> ${data.params.brickWidth} cm</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            resultContainer.innerHTML = resultHtml;
        }
        
        // ä¿å­˜è®¡ç®—å†å²
        function saveCalculationHistory(data) {
            calculationHistory.unshift(data);
            
            // é™åˆ¶å†å²è®°å½•æ•°é‡
            if (calculationHistory.length > 50) {
                calculationHistory = calculationHistory.slice(0, 50);
            }
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('calculationHistory', JSON.stringify(calculationHistory));
            
            // æ›´æ–°è®¡ç®—å†å²æ˜¾ç¤º
            renderCalculationHistory();
            
            // è®°å½•æ“ä½œæ—¥å¿—
            addOperationLog('calculation', `${data.type}è®¡ç®—`);
        }
        
        // æ¸²æŸ“è®¡ç®—å†å²
        function renderCalculationHistory() {
            const container = document.querySelector('#calculation-history tbody');
            const noHistory = document.getElementById('no-history');
            
            // æ¸…ç©ºå®¹å™¨
            container.innerHTML = '';
            
            // æ£€æŸ¥æ˜¯å¦æœ‰å†å²è®°å½•
            if (calculationHistory.length === 0) {
                container.classList.add('hidden');
                noHistory.classList.remove('hidden');
                return;
            }
            
            // æ˜¾ç¤ºå†å²è®°å½•
            container.classList.remove('hidden');
            noHistory.classList.add('hidden');
            
            // æ¸²æŸ“å†å²è®°å½•è¡Œ
            calculationHistory.forEach(history => {
                const row = document.createElement('tr');
                
                // æ ¼å¼åŒ–å‚æ•°æ˜¾ç¤º
                let paramsText = '';
                if (history.type === 'å¢™ä½“ç®—ç –') {
                    paramsText = `é•¿${history.params.length}m Ã— é«˜${history.params.height}m Ã— åš${history.params.thickness === 0 ? 'æ— ' : history.params.thickness + 'cm'}`;
                } else if (history.type === 'åœ°é¢ç®—ç –') {
                    paramsText = `é•¿${history.params.length}m Ã— å®½${history.params.width}m`;
                } else if (history.type === 'æŸ±å­ç®—ç –') {
                    paramsText = `å‘¨é•¿${history.params.perimeter}m Ã— é«˜${history.params.height}m`;
                } else if (history.type === 'é¢ç§¯ç®—ç –') {
                    paramsText = `é¢ç§¯${history.params.area}ã¡`;
                }
                
                // æ ¼å¼åŒ–ç»“æœæ˜¾ç¤º
                let resultText = '';
                if (history.type === 'å¢™ä½“ç®—ç –' || history.type === 'æŸ±å­ç®—ç –') {
                    resultText = `${history.result.totalBricks}å— (${history.result.area.toFixed(2)}ã¡)`;
                } else {
                    resultText = `${history.result.totalTiles}å— (${history.params.area.toFixed(2)}ã¡)`;
                }
                
                // è®¾ç½®è¡Œå†…å®¹
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap">
                        <span class="badge badge-primary">${history.type}</span>
                    </td>
                    <td class="px-4 py-3">
                        <div class="text-sm text-dark-2">${paramsText}</div>
                    </td>
                    <td class="px-4 py-3">
                        <div class="text-sm font-medium text-dark">${resultText}</div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-dark-3">
                        ${formatDate(history.timestamp)}
                    </td>
                `;
                
                container.appendChild(row);
            });
        }
        
        // ä¿å­˜è®¡ç®—ç»“æœ
        function saveCalculation() {
            showNotification('åŠŸèƒ½æç¤º', 'è®¡ç®—ç»“æœå·²è‡ªåŠ¨ä¿å­˜åˆ°å†å²è®°å½•ä¸­', 'info');
        }
        
        // æ¸…ç©ºè®¡ç®—å†å²
        function clearHistory() {
            showConfirmDialog(
                'æ¸…ç©ºè®¡ç®—å†å²',
                'ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è®¡ç®—å†å²å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚',
                () => {
                    calculationHistory = [];
                    localStorage.removeItem('calculationHistory');
                    renderCalculationHistory();
                    showNotification('æ¸…ç©ºæˆåŠŸ', 'è®¡ç®—å†å²å·²æˆåŠŸæ¸…ç©º', 'success');
                    addOperationLog('calculation', 'æ¸…ç©ºè®¡ç®—å†å²');
                }
            );
        }
        
        // æ¸²æŸ“æ“ä½œæ—¥å¿—
        function renderOperationLogs() {
            const container = document.getElementById('logs-list');
            const noLogs = document.getElementById('no-logs');
            
            // æ¸…ç©ºå®¹å™¨
            container.innerHTML = '';
            
            // ç­›é€‰æ—¥å¿—
            let filteredLogs = operationLogs;
            if (currentLogFilter !== 'all') {
                filteredLogs = operationLogs.filter(log => log.type === currentLogFilter);
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ—¥å¿—
            if (filteredLogs.length === 0) {
                container.classList.add('hidden');
                noLogs.classList.remove('hidden');
                return;
            }
            
            // æ˜¾ç¤ºæ—¥å¿—åˆ—è¡¨
            container.classList.remove('hidden');
            noLogs.classList.add('hidden');
            
            // æ¸²æŸ“æ—¥å¿—è¡Œ
            filteredLogs.forEach(log => {
                const row = document.createElement('tr');
                
                // è®¾ç½®è¡Œå†…å®¹
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="badge ${getLogTypeBadgeClass(log.type)}">${getLogTypeText(log.type)}</span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-dark-2">${log.content}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-dark-2">${log.user || 'ç³»ç»Ÿ'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-dark-3">
                        ${formatDate(log.timestamp)}
                    </td>
                `;
                
                container.appendChild(row);
            });
        }
        
        // æ¸²æŸ“ç­›é€‰åçš„æ—¥å¿—
        function renderFilteredLogs(filteredLogs) {
            const container = document.getElementById('logs-list');
            const noLogs = document.getElementById('no-logs');
            
            // æ¸…ç©ºå®¹å™¨
            container.innerHTML = '';
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ—¥å¿—
            if (filteredLogs.length === 0) {
                container.classList.add('hidden');
                noLogs.classList.remove('hidden');
                return;
            }
            
            // æ˜¾ç¤ºæ—¥å¿—åˆ—è¡¨
            container.classList.remove('hidden');
            noLogs.classList.add('hidden');
            
            // æ¸²æŸ“æ—¥å¿—è¡Œ
            filteredLogs.forEach(log => {
                const row = document.createElement('tr');
                
                // è®¾ç½®è¡Œå†…å®¹
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="badge ${getLogTypeBadgeClass(log.type)}">${getLogTypeText(log.type)}</span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-dark-2">${log.content}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-dark-2">${log.user || 'ç³»ç»Ÿ'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-dark-3">
                        ${formatDate(log.timestamp)}
                    </td>
                `;
                
                container.appendChild(row);
            });
        }
        
        // è·å–æ—¥å¿—ç±»å‹æ ‡ç­¾æ ·å¼
        function getLogTypeBadgeClass(type) {
            switch (type) {
                case 'product':
                    return 'badge-primary';
                case 'user':
                    return 'badge-secondary';
                case 'calculation':
                    return 'badge-success';
                case 'system':
                    return 'badge-warning';
                default:
                    return 'badge-secondary';
            }
        }
        
        // è·å–æ—¥å¿—ç±»å‹æ–‡æœ¬
        function getLogTypeText(type) {
            switch (type) {
                case 'product':
                    return 'äº§å“æ“ä½œ';
                case 'user':
                    return 'ç”¨æˆ·æ“ä½œ';
                case 'calculation':
                    return 'è®¡ç®—æ“ä½œ';
                case 'system':
                    return 'ç³»ç»Ÿæ“ä½œ';
                default:
                    return 'å…¶ä»–æ“ä½œ';
            }
        }
        
        // æ·»åŠ æ“ä½œæ—¥å¿—
        async function addOperationLog(type, content) {
            try {
                console.log('å¼€å§‹æ·»åŠ æ“ä½œæ—¥å¿—:', { type, content });
                
                const log = {
                    id: 'log_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    type,
                    content,
                    user: currentUser ? currentUser.username : 'ç³»ç»Ÿ',
                    timestamp: new Date().toISOString()
                };
                
                console.log('åˆ›å»ºæ—¥å¿—å¯¹è±¡:', log);
                
                operationLogs.unshift(log);
                console.log('æ—¥å¿—å·²æ·»åŠ åˆ°æ•°ç»„ï¼Œå½“å‰æ—¥å¿—æ•°é‡:', operationLogs.length);
                
                // é™åˆ¶æ—¥å¿—æ•°é‡
                if (operationLogs.length > 100) {
                    operationLogs = operationLogs.slice(0, 100);
                    console.log('æ—¥å¿—æ•°é‡è¶…è¿‡é™åˆ¶ï¼Œå·²æˆªå–å‰100æ¡');
                }
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆæ·»åŠ é¢å¤–çš„ä¿å­˜é€»è¾‘ï¼‰
                try {
                    localStorage.setItem('operationLogs', JSON.stringify(operationLogs));
                    console.log('æ—¥å¿—å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
                } catch (localStorageError) {
                    console.error('ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨å¤±è´¥:', localStorageError);
                }
                
                // ä¿å­˜åˆ°Supabase
                await saveData('operationLogs', operationLogs);
                console.log('æ—¥å¿—å·²ä¿å­˜åˆ°æ•°æ®å­˜å‚¨');
                
                // å¼ºåˆ¶æ›´æ–°æ—¥å¿—æ˜¾ç¤ºï¼Œæ— è®ºå½“å‰æ˜¯å¦åœ¨æ—¥å¿—é¡µé¢
                renderOperationLogs();
                console.log('æ—¥å¿—åˆ—è¡¨å·²æ›´æ–°');
                
                return true;
            } catch (error) {
                console.error('æ·»åŠ æ“ä½œæ—¥å¿—å¤±è´¥:', error.message);
                return false;
            }
        }
        

        
        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(title, message, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationTitle = document.getElementById('notification-title');
            const notificationMessage = document.getElementById('notification-message');
            const notificationIcon = document.getElementById('notification-icon');
            
            // è®¾ç½®é€šçŸ¥å†…å®¹
            notificationTitle.textContent = title;
            notificationMessage.textContent = message;
            
            // è®¾ç½®é€šçŸ¥ç±»å‹æ ·å¼
            notification.className = 'fixed top-4 right-4 z-50 max-w-xs';
            
            let iconClass = 'fa-check-circle';
            let borderClass = 'border-primary';
            
            switch (type) {
                case 'error':
                    iconClass = 'fa-exclamation-circle';
                    borderClass = 'border-primary'; // ä½¿ç”¨é»˜è®¤é¢œè‰²ä»£æ›¿çº¢è‰²
                    break;
                case 'warning':
                    iconClass = 'fa-exclamation-triangle';
                    borderClass = 'border-warning';
                    break;
                case 'info':
                    iconClass = 'fa-info-circle';
                    borderClass = 'border-secondary';
                    break;
            }
            
            notificationIcon.innerHTML = `<i class="fa ${iconClass} text-xl"></i>`;
            notification.classList.add(`border-l-4`, borderClass);
            notification.classList.add('bg-white', 'rounded-lg', 'shadow-lg', 'p-4');
            
            // æ˜¾ç¤ºé€šçŸ¥
            notification.classList.remove('hidden');
            
            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);
        }
        
        // æ¸…é™¤æ‰€æœ‰æ•°æ®
        function clearAllData() {
            try {
                // æ¸…é™¤æ‰€æœ‰æ•°æ®
                products = [];
                users = [];
                calculationHistory = [];
                operationLogs = [];
                
                // æ¸…é™¤æœ¬åœ°å­˜å‚¨
                localStorage.removeItem('products');
                localStorage.removeItem('users');
                localStorage.removeItem('calculationHistory');
                localStorage.removeItem('operationLogs');
                
                // é‡æ–°æ¸²æŸ“æ‰€æœ‰åˆ—è¡¨
                renderProducts();
                renderUsers();
                renderCalculationHistory();
                renderOperationLogs();
                
                // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
                showNotification('æ¸…é™¤æˆåŠŸ', 'æ‰€æœ‰æ•°æ®å·²æˆåŠŸæ¸…é™¤', 'success');
                
                // è®°å½•æ“ä½œæ—¥å¿—
                addOperationLog('system', 'æ¸…é™¤æ‰€æœ‰æ•°æ®');
            } catch (error) {
                console.error('æ¸…é™¤æ•°æ®å¤±è´¥:', error.message);
                showNotification('æ¸…é™¤å¤±è´¥', 'æ¸…é™¤æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯', 'error');
            }
        }
        
        // å¯¼å‡ºæ•°æ®
        function exportData() {
            try {
                const data = {
                    products,
                    users,
                    calculationHistory,
                    operationLogs,
                    exportDate: new Date().toISOString()
                };
                
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `marco-polo-export-${formatDateForFilename(new Date())}.json`;
                link.click();
                
                showNotification('å¯¼å‡ºæˆåŠŸ', 'æ•°æ®å·²æˆåŠŸå¯¼å‡º', 'success');
                addOperationLog('system', 'å¯¼å‡ºæ•°æ®');
            } catch (error) {
                console.error('å¯¼å‡ºæ•°æ®å¤±è´¥:', error.message);
                showNotification('å¯¼å‡ºå¤±è´¥', 'å¯¼å‡ºæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯', 'error');
            }
        }
        
        // å¯¼å…¥æ•°æ®
        function importData(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const data = JSON.parse(event.target.result);
                    
                    showConfirmDialog(
                        'å¯¼å…¥æ•°æ®',
                        'å¯¼å…¥æ•°æ®å°†è¦†ç›–å½“å‰ç³»ç»Ÿä¸­çš„æ‰€æœ‰æ•°æ®ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ',
                        () => {
                            try {
                                // å¯¼å…¥æ•°æ®
                                if (data.products) products = data.products;
                                if (data.users) users = data.users;
                                if (data.calculationHistory) calculationHistory = data.calculationHistory;
                                if (data.operationLogs) operationLogs = data.operationLogs;
                                
                                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                                localStorage.setItem('products', JSON.stringify(products));
                                localStorage.setItem('users', JSON.stringify(users));
                                localStorage.setItem('calculationHistory', JSON.stringify(calculationHistory));
                                localStorage.setItem('operationLogs', JSON.stringify(operationLogs));
                                
                                // é‡æ–°æ¸²æŸ“æ‰€æœ‰åˆ—è¡¨
                                renderProducts();
                                renderUsers();
                                renderCalculationHistory();
                                renderOperationLogs();
                                
                                // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
                                showNotification('å¯¼å…¥æˆåŠŸ', 'æ•°æ®å·²æˆåŠŸå¯¼å…¥', 'success');
                                addOperationLog('system', 'å¯¼å…¥æ•°æ®');
                            } catch (error) {
                                console.error('å¯¼å…¥æ•°æ®å¤±è´¥:', error.message);
                                showNotification('å¯¼å…¥å¤±è´¥', 'å¯¼å…¥æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯', 'error');
                            }
                        }
                    );
                } catch (error) {
                    console.error('è§£æå¯¼å…¥æ–‡ä»¶å¤±è´¥:', error.message);
                    showNotification('å¯¼å…¥å¤±è´¥', 'å¯¼å…¥æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®', 'error');
                }
            };
            reader.readAsText(file);
            
            // é‡ç½®æ–‡ä»¶è¾“å…¥
            e.target.value = '';
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸç”¨äºæ–‡ä»¶å
        function formatDateForFilename(date) {
            return date.toISOString()
                .replace(/:/g, '-')
                .replace(/T/g, '_')
                .split('.')[0];
        }
        
        // å¯¼å‡ºäº§å“æ•°æ®
        function exportProductsData() {
            try {
                const data = {
                    products,
                    exportDate: new Date().toISOString(),
                    version: '1.0'
                };
                
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `marco-polo-products-${formatDateForFilename(new Date())}.json`;
                link.click();
                
                showNotification('å¯¼å‡ºæˆåŠŸ', 'äº§å“æ•°æ®å·²æˆåŠŸå¯¼å‡º', 'success');
                addOperationLog('system', 'å¯¼å‡ºäº§å“æ•°æ®');
            } catch (error) {
                console.error('å¯¼å‡ºäº§å“æ•°æ®å¤±è´¥:', error.message);
                showNotification('å¯¼å‡ºå¤±è´¥', 'å¯¼å‡ºäº§å“æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯', 'error');
            }
        }
        
        // å¯¼å…¥äº§å“æ•°æ®
        function importProductsData(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const data = JSON.parse(event.target.result);
                    
                    if (!data.products || !Array.isArray(data.products)) {
                        showNotification('å¯¼å…¥å¤±è´¥', 'å¯¼å…¥æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼Œç¼ºå°‘äº§å“æ•°æ®', 'error');
                        return;
                    }
                    
                    showConfirmDialog(
                        'å¯¼å…¥äº§å“æ•°æ®',
                        `ç¡®å®šè¦å¯¼å…¥ ${data.products.length} ä¸ªäº§å“å—ï¼Ÿè¿™å°†è¦†ç›–å½“å‰çš„äº§å“æ•°æ®ã€‚`,
                        () => {
                            try {
                                // å¯¼å…¥äº§å“æ•°æ®
                                products = data.products;
                                
                                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                                localStorage.setItem('products', JSON.stringify(products));
                                
                                // é‡æ–°æ¸²æŸ“äº§å“åˆ—è¡¨
                                renderProducts();
                                
                                // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
                                showNotification('å¯¼å…¥æˆåŠŸ', `æˆåŠŸå¯¼å…¥ ${data.products.length} ä¸ªäº§å“`, 'success');
                                addOperationLog('system', `å¯¼å…¥äº§å“æ•°æ®ï¼Œå…± ${data.products.length} ä¸ªäº§å“`);
                            } catch (error) {
                                console.error('å¯¼å…¥äº§å“æ•°æ®å¤±è´¥:', error.message);
                                showNotification('å¯¼å…¥å¤±è´¥', 'å¯¼å…¥äº§å“æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯', 'error');
                            }
                        }
                    );
                } catch (error) {
                    console.error('è§£æå¯¼å…¥æ–‡ä»¶å¤±è´¥:', error.message);
                    showNotification('å¯¼å…¥å¤±è´¥', 'å¯¼å…¥æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®', 'error');
                }
            };
            reader.readAsText(file);
            
            // é‡ç½®æ–‡ä»¶è¾“å…¥
            e.target.value = '';
        }
        
        // å¯¼å‡ºäº§å“æ•°æ®CSVæ ¼å¼
        function exportProductsCSV() {
            try {
                if (products.length === 0) {
                    showNotification('å¯¼å‡ºå¤±è´¥', 'æ²¡æœ‰äº§å“æ•°æ®å¯å¯¼å‡º', 'warning');
                    return;
                }
                
                // CSVè¡¨å¤´
                const headers = ['äº§å“åç§°', 'ä»·æ ¼', 'å‹å·', 'åˆ†ç±»', 'å°ºå¯¸', 'é£æ ¼', 'æè¿°', 'æ ‡ç­¾', 'åˆ›å»ºæ—¶é—´', 'æ›´æ–°æ—¶é—´'];
                
                // è½¬æ¢äº§å“æ•°æ®ä¸ºCSVè¡Œ
                const rows = products.map(product => {
                    return [
                        `"${product.name.replace(/"/g, '""')}"`, // è½¬ä¹‰åŒå¼•å·
                        product.price.toFixed(2),
                        `"${product.model.replace(/"/g, '""')}"`,
                        getCategoryName(product.category),
                        `"${(product.size || '').replace(/"/g, '""')}"`,
                        `"${(product.style || '').replace(/"/g, '""')}"`,
                        `"${(product.description || '').replace(/"/g, '""')}"`,
                        `"${(product.badges || []).map(getBadgeName).join(', ')}"`,
                        formatDate(product.createdAt),
                        formatDate(product.updatedAt)
                    ].join(',');
                });
                
                // ç»„åˆCSVå†…å®¹
                const csvContent = [
                    headers.join(','), // è¡¨å¤´
                    ...rows // æ•°æ®è¡Œ
                ].join('\n');
                
                // åˆ›å»ºBlobå¹¶ä¸‹è½½
                const dataBlob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `marco-polo-products-${formatDateForFilename(new Date())}.csv`;
                link.click();
                
                showNotification('å¯¼å‡ºæˆåŠŸ', 'äº§å“æ•°æ®å·²æˆåŠŸå¯¼å‡ºä¸ºCSVæ ¼å¼', 'success');
                addOperationLog('system', 'å¯¼å‡ºäº§å“æ•°æ®CSVæ ¼å¼');
            } catch (error) {
                console.error('å¯¼å‡ºCSVå¤±è´¥:', error.message);
                showNotification('å¯¼å‡ºå¤±è´¥', 'å¯¼å‡ºCSVæ ¼å¼æ—¶å‘ç”Ÿé”™è¯¯', 'error');
            }
        }
        
        // å¯¼å…¥äº§å“æ•°æ®CSVæ ¼å¼
        function importProductsCSV(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const csvContent = event.target.result;
                    const lines = csvContent.split('\n');
                    
                    if (lines.length < 2) {
                        showNotification('å¯¼å…¥å¤±è´¥', 'CSVæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼Œè‡³å°‘éœ€è¦åŒ…å«è¡¨å¤´å’Œä¸€è¡Œæ•°æ®', 'error');
                        return;
                    }
                    
                    // è§£æCSV
                    const importedProducts = [];
                    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                    
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        // è§£æCSVè¡Œï¼Œå¤„ç†å¼•å·å†…çš„é€—å·
                        const values = [];
                        let current = '';
                        let inQuotes = false;
                        
                        for (let j = 0; j < line.length; j++) {
                            const char = line[j];
                            const nextChar = line[j + 1];
                            
                            if (char === '"' && nextChar === '"') {
                                // å¤„ç†è½¬ä¹‰çš„åŒå¼•å·
                                current += '"';
                                j++; // è·³è¿‡ä¸‹ä¸€ä¸ªå¼•å·
                            } else if (char === '"') {
                                inQuotes = !inQuotes;
                            } else if (char === ',' && !inQuotes) {
                                values.push(current.trim());
                                current = '';
                            } else {
                                current += char;
                            }
                        }
                        values.push(current.trim());
                        
                        // åˆ›å»ºäº§å“å¯¹è±¡
                        const product = {
                            id: 'prod_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                            name: values[0] || '',
                            price: parseFloat(values[1]) || 0,
                            model: values[2] || '',
                            category: getCategoryValue(values[3]) || 'other',
                            size: values[4] || '',
                            style: values[5] || '',
                            description: values[6] || '',
                            badges: values[7] ? values[7].split(',').map(b => getBadgeValue(b.trim())) : [],
                            image: 'https://p3-doubao-search-sign.byteimg.com/labis/b25bf99ea85ce428883f6bb2054bb3a3~tplv-be4g95zd3a-image.jpeg?rk3s=542c0f93&x-expires=1779614297&x-signature=em5LkupK5eTit6quyY0Ne413gRI%3D',
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        };
                        
                        importedProducts.push(product);
                    }
                    
                    if (importedProducts.length === 0) {
                        showNotification('å¯¼å…¥å¤±è´¥', 'æœªæ‰¾åˆ°æœ‰æ•ˆçš„äº§å“æ•°æ®', 'error');
                        return;
                    }
                    
                    showConfirmDialog(
                        'å¯¼å…¥äº§å“æ•°æ®',
                        `ç¡®å®šè¦å¯¼å…¥ ${importedProducts.length} ä¸ªäº§å“å—ï¼Ÿè¿™å°†è¦†ç›–å½“å‰çš„äº§å“æ•°æ®ã€‚`,
                        () => {
                            try {
                                // å¯¼å…¥äº§å“æ•°æ®
                                products = importedProducts;
                                
                                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                                localStorage.setItem('products', JSON.stringify(products));
                                
                                // é‡æ–°æ¸²æŸ“äº§å“åˆ—è¡¨
                                renderProducts();
                                
                                // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
                                showNotification('å¯¼å…¥æˆåŠŸ', `æˆåŠŸå¯¼å…¥ ${importedProducts.length} ä¸ªäº§å“`, 'success');
                                addOperationLog('system', `å¯¼å…¥äº§å“æ•°æ®CSVæ ¼å¼ï¼Œå…± ${importedProducts.length} ä¸ªäº§å“`);
                            } catch (error) {
                                console.error('å¯¼å…¥äº§å“æ•°æ®å¤±è´¥:', error.message);
                                showNotification('å¯¼å…¥å¤±è´¥', 'å¯¼å…¥äº§å“æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯', 'error');
                            }
                        }
                    );
                } catch (error) {
                    console.error('è§£æCSVæ–‡ä»¶å¤±è´¥:', error.message);
                    showNotification('å¯¼å…¥å¤±è´¥', 'CSVæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®', 'error');
                }
            };
            reader.readAsText(file);
            
            // é‡ç½®æ–‡ä»¶è¾“å…¥
            e.target.value = '';
        }
        
        // æ¸…é™¤äº§å“æ•°æ®
        function clearProductsData() {
            try {
                const productCount = products.length;
                products = [];
                localStorage.removeItem('products');
                renderProducts();
                
                showNotification('æ¸…é™¤æˆåŠŸ', `å·²æˆåŠŸæ¸…é™¤ ${productCount} ä¸ªäº§å“æ•°æ®`, 'success');
                addOperationLog('system', `æ¸…é™¤æ‰€æœ‰äº§å“æ•°æ®ï¼Œå…± ${productCount} ä¸ªäº§å“`);
            } catch (error) {
                console.error('æ¸…é™¤äº§å“æ•°æ®å¤±è´¥:', error.message);
                showNotification('æ¸…é™¤å¤±è´¥', 'æ¸…é™¤äº§å“æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯', 'error');
            }
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šè·å–åˆ†ç±»åç§°
        function getCategoryName(category) {
            const categories = {
                'tile': 'ç“·ç –',
                'stone': 'çŸ³æ',
                'floor': 'åœ°æ¿',
                'other': 'å…¶ä»–'
            };
            return categories[category] || category || 'å…¶ä»–';
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šè·å–åˆ†ç±»å€¼
        function getCategoryValue(categoryName) {
            const categoryMap = {
                'ç“·ç –': 'tile',
                'çŸ³æ': 'stone',
                'åœ°æ¿': 'floor',
                'å…¶ä»–': 'other'
            };
            
            // å°è¯•ç›´æ¥åŒ¹é…
            if (categoryMap[categoryName]) {
                return categoryMap[categoryName];
            }
            
            // å°è¯•æ¨¡ç³ŠåŒ¹é…
            for (const [name, value] of Object.entries(categoryMap)) {
                if (categoryName.includes(name)) {
                    return value;
                }
            }
            
            return 'other';
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šè·å–æ ‡ç­¾åç§°
        function getBadgeName(badge) {
            const badges = {
                'on-sale': 'åœ¨å”®',
                'hot': 'çˆ†æ¬¾',
                'bargain': 'ç‰¹ä»·',
                'new': 'æ–°å“',
                'discontinued': 'åœå”®'
            };
            return badges[badge] || badge;
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šè·å–æ ‡ç­¾å€¼
        function getBadgeValue(badgeName) {
            const badgeMap = {
                'åœ¨å”®': 'on-sale',
                'çˆ†æ¬¾': 'hot',
                'ç‰¹ä»·': 'bargain',
                'æ–°å“': 'new',
                'åœå”®': 'discontinued'
            };
            
            // å°è¯•ç›´æ¥åŒ¹é…
            if (badgeMap[badgeName]) {
                return badgeMap[badgeName];
            }
            
            // å°è¯•æ¨¡ç³ŠåŒ¹é…
            for (const [name, value] of Object.entries(badgeMap)) {
                if (badgeName.includes(name)) {
                    return value;
                }
            }
            
            return 'on-sale'; // é»˜è®¤å€¼
        }
    </script>
    
    <!-- ç®—ç –è®¡ç®—å™¨JavaScript -->
    <script>
        /**
         * ç –å—æ’åˆ—å¹³é¢å›¾æ¨¡æ€æ¡†ç®¡ç†å™¨
         */
        class BrickPlanarModalManager {
            constructor() {
                this.modal = document.getElementById('brick-planar-modal');
                this.openBtn = document.getElementById('brick-open-modal-btn');
                this.closeBtn = document.getElementById('brick-close-modal-btn');
                this.zoomInBtn = document.getElementById('brick-zoom-in-btn');
                this.zoomOutBtn = document.getElementById('brick-zoom-out-btn');
                this.resetViewBtn = document.getElementById('brick-zoom-reset-btn');
                this.exportImageBtn = document.getElementById('brick-export-btn');
                this.zoomLevel = document.getElementById('brick-zoom-level');
                this.modalContainer = document.getElementById('brick-modal-planar-container');
                this.planarContainer = document.getElementById('brick-planar-container');
                
                // ç¼©æ”¾å’Œå¹³ç§»çŠ¶æ€
                this.scale = 1;
                this.translateX = 0;
                this.translateY = 0;
                this.isDragging = false;
                this.startX = 0;
                this.startY = 0;
                
                this.init();
            }
            
            init() {
                this.bindEvents();
            }
            
            bindEvents() {
                // æ‰“å¼€æ¨¡æ€æ¡†
                this.openBtn.addEventListener('click', () => this.openModal());
                this.planarContainer.addEventListener('click', () => this.openModal());
                
                // å…³é—­æ¨¡æ€æ¡†
                this.closeBtn.addEventListener('click', () => this.closeModal());
                this.modal.querySelector('.bg-black.bg-opacity-50').addEventListener('click', (e) => {
                    if (e.target === this.modal.querySelector('.bg-black.bg-opacity-50')) {
                        this.closeModal();
                    }
                });
                
                // ç¼©æ”¾æ§åˆ¶
                this.zoomInBtn.addEventListener('click', () => this.zoom(1.2));
                this.zoomOutBtn.addEventListener('click', () => this.zoom(0.8));
                this.resetViewBtn.addEventListener('click', () => this.resetView());
                
                // é”®ç›˜å¿«æ·é”®
                document.addEventListener('keydown', (e) => {
                    if (this.modal.classList.contains('hidden')) return;
                    
                    if (e.key === 'Escape') {
                        this.closeModal();
                    } else if (e.key === '+' || e.key === '=') {
                        this.zoom(1.2);
                    } else if (e.key === '-' || e.key === '_') {
                        this.zoom(0.8);
                    } else if (e.key === 'r' || e.key === 'R') {
                        this.resetView();
                    }
                });
                
                // é¼ æ ‡æ»šè½®ç¼©æ”¾
                this.modalContainer.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    const delta = e.deltaY > 0 ? 0.9 : 1.1;
                    this.zoom(delta);
                });
                
                // æ‹–æ‹½å¹³ç§»
                this.modalContainer.addEventListener('mousedown', (e) => {
                    this.startDrag(e);
                });
                
                document.addEventListener('mousemove', (e) => {
                    this.drag(e);
                });
                
                document.addEventListener('mouseup', () => {
                    this.stopDrag();
                });
                
                // å¯¼å‡ºå›¾ç‰‡
                this.exportImageBtn.addEventListener('click', () => this.exportImage());
            }
            
            openModal() {
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                this.modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                
                // å¤åˆ¶å¹³é¢å›¾å†…å®¹åˆ°æ¨¡æ€æ¡†
                this.modalContainer.innerHTML = '';
                const planarClone = this.planarContainer.cloneNode(true);
                planarClone.style.cursor = 'move';
                this.modalContainer.appendChild(planarClone);
                
                // é‡ç½®è§†å›¾
                this.resetView();
            }
            
            closeModal() {
                this.modal.classList.add('hidden');
                document.body.style.overflow = '';
            }
            
            zoom(factor) {
                this.scale *= factor;
                // é™åˆ¶ç¼©æ”¾èŒƒå›´
                this.scale = Math.max(0.1, Math.min(this.scale, 5));
                this.updateTransform();
                this.updateZoomLevel();
            }
            
            resetView() {
                this.scale = 1;
                this.translateX = 0;
                this.translateY = 0;
                this.updateTransform();
                this.updateZoomLevel();
            }
            
            startDrag(e) {
                if (e.button !== 0) return; // åªå“åº”å·¦é”®
                this.isDragging = true;
                this.startX = e.clientX - this.translateX;
                this.startY = e.clientY - this.translateY;
                this.modalContainer.style.cursor = 'grabbing';
            }
            
            drag(e) {
                if (!this.isDragging) return;
                this.translateX = e.clientX - this.startX;
                this.translateY = e.clientY - this.startY;
                this.updateTransform();
            }
            
            stopDrag() {
                this.isDragging = false;
                this.modalContainer.style.cursor = 'grab';
            }
            
            updateTransform() {
                this.modalContainer.style.transform = `scale(${this.scale}) translate(${this.translateX / this.scale}px, ${this.translateY / this.scale}px)`;
            }
            
            updateZoomLevel() {
                this.zoomLevel.textContent = `${Math.round(this.scale * 100)}%`;
            }
            
            exportImage() {
                try {
                    // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„canvaså…ƒç´ 
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // è·å–å¹³é¢å›¾å®¹å™¨çš„å°ºå¯¸
                    const planarElement = this.modalContainer.querySelector('.brick-planar-container');
                    const rect = planarElement.getBoundingClientRect();
                    
                    // è®¾ç½®canvaså°ºå¯¸
                    canvas.width = rect.width;
                    canvas.height = rect.height;
                    
                    // è®¾ç½®ç™½è‰²èƒŒæ™¯
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // ä½¿ç”¨html2canvasåº“å°†DOMå…ƒç´ ç»˜åˆ¶åˆ°canvasä¸Š
                    if (typeof html2canvas !== 'undefined') {
                        html2canvas(planarElement).then(canvas => {
                            // åˆ›å»ºä¸‹è½½é“¾æ¥
                            const link = document.createElement('a');
                            link.download = 'ç –å—æ’åˆ—å¹³é¢å›¾.png';
                            link.href = canvas.toDataURL();
                            link.click();
                        });
                    } else {
                        // å¦‚æœhtml2canvasä¸å¯ç”¨ï¼Œä½¿ç”¨ç®€å•çš„æ–¹æ³•
                        const dataUrl = canvas.toDataURL('image/png');
                        const link = document.createElement('a');
                        link.download = 'ç –å—æ’åˆ—å¹³é¢å›¾.png';
                        link.href = dataUrl;
                        link.click();
                        
                        showNotification('å¯¼å‡ºæˆåŠŸ', 'å¹³é¢å›¾å·²å¯¼å‡ºä¸ºPNGå›¾ç‰‡', 'success');
                    }
                } catch (error) {
                    console.error('å¯¼å‡ºå›¾ç‰‡å¤±è´¥:', error);
                    showNotification('å¯¼å‡ºå¤±è´¥', 'å¯¼å‡ºå›¾ç‰‡æ—¶å‘ç”Ÿé”™è¯¯', 'error');
                }
            }
        }
        
        /**
         * å¹³é¢å›¾ç®—ç –è®¡ç®—å™¨æ¨¡æ€æ¡†ç®¡ç†å™¨
         */
        class PlanarModalManager {
            constructor(calculator) {
                this.calculator = calculator;
                this.modal = document.getElementById('planar-modal');
                this.backdrop = document.getElementById('modal-backdrop');
                this.openBtn = document.getElementById('open-planar-modal');
                this.closeBtn = document.getElementById('close-modal');
                this.closeModalBtn = document.getElementById('close-modal-btn');
                this.zoomInBtn = document.getElementById('zoom-in');
                this.zoomOutBtn = document.getElementById('zoom-out');
                this.resetViewBtn = document.getElementById('reset-view');
                this.exportImageBtn = document.getElementById('export-image');
                this.modalContainer = document.getElementById('modal-planar-container');
                this.modalLoading = document.getElementById('modal-loading');
                
                // ç¼©æ”¾å’Œå¹³ç§»çŠ¶æ€
                this.scale = 1;
                this.translateX = 0;
                this.translateY = 0;
                this.isDragging = false;
                this.startX = 0;
                this.startY = 0;
                
                this.init();
            }
            
            init() {
                this.bindEvents();
            }
            
            bindEvents() {
                // æ‰“å¼€æ¨¡æ€æ¡†
                this.openBtn.addEventListener('click', () => this.openModal());
                
                // å…³é—­æ¨¡æ€æ¡†
                this.closeBtn.addEventListener('click', () => this.closeModal());
                this.closeModalBtn.addEventListener('click', () => this.closeModal());
                this.backdrop.addEventListener('click', (e) => {
                    if (e.target === this.backdrop) {
                        this.closeModal();
                    }
                });
                
                // ç¼©æ”¾æ§åˆ¶
                this.zoomInBtn.addEventListener('click', () => this.zoom(1.2));
                this.zoomOutBtn.addEventListener('click', () => this.zoom(0.8));
                this.resetViewBtn.addEventListener('click', () => this.resetView());
                
                // é”®ç›˜å¿«æ·é”®
                document.addEventListener('keydown', (e) => {
                    if (this.modal.classList.contains('hidden')) return;
                    
                    if (e.key === 'Escape') {
                        this.closeModal();
                    } else if (e.key === '+' || e.key === '=') {
                        this.zoom(1.2);
                    } else if (e.key === '-' || e.key === '_') {
                        this.zoom(0.8);
                    } else if (e.key === 'r' || e.key === 'R') {
                        this.resetView();
                    }
                });
                
                // é¼ æ ‡æ»šè½®ç¼©æ”¾
                this.modalContainer.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    const delta = e.deltaY > 0 ? 0.9 : 1.1;
                    this.zoom(delta);
                });
                
                // æ‹–æ‹½å¹³ç§»
                this.modalContainer.addEventListener('mousedown', (e) => {
                    this.startDrag(e);
                });
                
                document.addEventListener('mousemove', (e) => {
                    this.drag(e);
                });
                
                document.addEventListener('mouseup', () => {
                    this.stopDrag();
                });
                
                // å¯¼å‡ºå›¾ç‰‡
                this.exportImageBtn.addEventListener('click', () => this.exportImage());
            }
            
            openModal() {
                this.modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                
                // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
                this.modalLoading.style.display = 'flex';
                
                // å»¶è¿Ÿä¸€ä¸‹ç¡®ä¿æ¨¡æ€æ¡†å®Œå…¨æ˜¾ç¤º
                setTimeout(() => {
                    this.renderPlanarView();
                    this.modalLoading.style.display = 'none';
                }, 300);
            }
            
            closeModal() {
                this.modal.classList.add('hidden');
                document.body.style.overflow = '';
                this.resetView();
            }
            
            renderPlanarView() {
                // æ¸…ç©ºå®¹å™¨
                this.modalContainer.innerHTML = '';
                
                // è·å–è®¡ç®—ç»“æœ
                const { 
                    wallWidth, wallHeight, brickLength, brickWidth,
                    widthIntegerColumns, heightIntegerColumns,
                    remainingWidth, remainingHeight
                } = this.calculator;
                
                // è®¾ç½®å®¹å™¨å°ºå¯¸
                const scale = 0.1; // ç¼©å°æ¯”ä¾‹ä»¥ä¾¿åœ¨æ¨¡æ€æ¡†ä¸­æ˜¾ç¤ºå®Œæ•´
                const containerWidth = wallWidth * scale;
                const containerHeight = wallHeight * scale;
                
                this.modalContainer.style.width = `${containerWidth}px`;
                this.modalContainer.style.height = `${containerHeight}px`;
                
                // ç»˜åˆ¶ç –å—
                const brickW = brickWidth * scale;
                const brickH = brickLength * scale;
                let brickNum = 1;
                
                // æ•´ç –
                for (let row = 0; row < heightIntegerColumns; row++) {
                    for (let col = 0; col < widthIntegerColumns; col++) {
                        this.createBrick(col * brickW, row * brickH, brickW, brickH, brickNum++, 'whole');
                    }
                }
                
                // å®½åº¦å‰©ä½™
                if (remainingWidth > 0) {
                    const remW = remainingWidth * scale;
                    for (let row = 0; row < heightIntegerColumns; row++) {
                        this.createBrick(widthIntegerColumns * brickW, row * brickH, remW, brickH, brickNum++, 'width-remaining');
                    }
                }
                
                // é«˜åº¦å‰©ä½™
                if (remainingHeight > 0) {
                    const remH = remainingHeight * scale;
                    for (let col = 0; col < widthIntegerColumns; col++) {
                        this.createBrick(col * brickW, heightIntegerColumns * brickH, brickW, remH, brickNum++, 'height-remaining');
                    }
                }
                
                // è§’è½
                if (remainingWidth > 0 && remainingHeight > 0) {
                    this.createBrick(widthIntegerColumns * brickW, heightIntegerColumns * brickH, 
                                  remainingWidth * scale, remainingHeight * scale, brickNum++, 'corner');
                }
                
                // æ›´æ–°ç –å—æ•°é‡ä¿¡æ¯
                document.getElementById('brick-count-info').textContent = `æ€»è®¡: ${brickNum - 1} å—ç –`;
            }
            
            createBrick(x, y, width, height, number, type) {
                const brick = document.createElement('div');
                
                // åŸºæœ¬æ ·å¼
                brick.style.position = 'absolute';
                brick.style.left = `${x}px`;
                brick.style.top = `${y}px`;
                brick.style.width = `${width}px`;
                brick.style.height = `${height}px`;
                brick.style.display = 'flex';
                brick.style.alignItems = 'center';
                brick.style.justifyContent = 'center';
                brick.style.fontSize = '14px';
                brick.style.fontWeight = 'bold';
                brick.style.color = '#333';
                brick.style.boxSizing = 'border-box';
                brick.style.border = '1px solid';
                brick.style.transition = 'all 0.2s ease';
                brick.style.cursor = 'pointer';
                brick.style.zIndex = '10';
                
                // é¢œè‰²
                const colors = {
                    'whole': ['#fff9c4', '#ffd54f'],
                    'width-remaining': ['#bbdefb', '#64b5f6'],
                    'height-remaining': ['#c8e6c9', '#81c784'],
                    'corner': ['#e1bee7', '#ba68c8']
                };
                
                const [bg, border] = colors[type] || colors.whole;
                brick.style.backgroundColor = bg;
                brick.style.borderColor = border;
                
                // ç¼–å·
                brick.textContent = number;
                
                // æ‚¬åœæ•ˆæœ
                brick.addEventListener('mouseenter', () => {
                    brick.style.transform = 'scale(1.05)';
                    brick.style.zIndex = '20';
                    brick.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
                });
                
                brick.addEventListener('mouseleave', () => {
                    brick.style.transform = 'scale(1)';
                    brick.style.zIndex = '10';
                    brick.style.boxShadow = 'none';
                });
                
                // ç‚¹å‡»æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
                brick.addEventListener('click', () => {
                    this.showBrickInfo(brick, number, type, x, y, width, height);
                });
                
                this.modalContainer.appendChild(brick);
            }
            
            showBrickInfo(brick, number, type, x, y, width, height) {
                // åˆ›å»ºä¿¡æ¯æç¤ºæ¡†
                let tooltip = document.getElementById('brick-tooltip');
                if (!tooltip) {
                    tooltip = document.createElement('div');
                    tooltip.id = 'brick-tooltip';
                    tooltip.style.position = 'fixed';
                    tooltip.style.background = 'white';
                    tooltip.style.border = '1px solid #ddd';
                    tooltip.style.borderRadius = '8px';
                    tooltip.style.padding = '12px';
                    tooltip.style.boxShadow = '0 4px 20px rgba(0,0,0,0.15)';
                    tooltip.style.zIndex = '1000';
                    tooltip.style.maxWidth = '300px';
                    tooltip.style.fontSize = '14px';
                    tooltip.style.pointerEvents = 'none';
                    document.body.appendChild(tooltip);
                }
                
                // ç –å—ç±»å‹åç§°
                const typeNames = {
                    'whole': 'æ•´ç –',
                    'width-remaining': 'å®½åº¦å‰©ä½™åŒºåŸŸ',
                    'height-remaining': 'é«˜åº¦å‰©ä½™åŒºåŸŸ',
                    'corner': 'è§’è½åŒºåŸŸ'
                };
                
                // è®¡ç®—å®é™…å°ºå¯¸ï¼ˆæ¯«ç±³ï¼‰
                const scale = this.calculator.wallWidth / this.modalContainer.offsetWidth;
                const realWidth = Math.round(width * scale);
                const realHeight = Math.round(height * scale);
                const realX = Math.round(x * scale);
                const realY = Math.round(y * scale);
                
                // è®¾ç½®å†…å®¹
                tooltip.innerHTML = `
                    <div class="font-bold text-gray-800 mb-2">ç –å— #${number}</div>
                    <div class="space-y-1 text-sm">
                        <div><span class="text-gray-500">ç±»å‹:</span> ${typeNames[type] || type}</div>
                        <div><span class="text-gray-500">ä½ç½®:</span> X: ${realX}mm, Y: ${realY}mm</div>
                        <div><span class="text-gray-500">å°ºå¯¸:</span> ${realWidth}mm Ã— ${realHeight}mm</div>
                        <div><span class="text-gray-500">é¢ç§¯:</span> ${((realWidth * realHeight) / 1000000).toFixed(2)}mÂ²</div>
                    </div>
                `;
                
                // å®šä½
                const rect = brick.getBoundingClientRect();
                tooltip.style.left = `${rect.right + 10}px`;
                tooltip.style.top = `${rect.top}px`;
                
                // ç¡®ä¿ä¸è¶…å‡ºè§†å£
                const tooltipRect = tooltip.getBoundingClientRect();
                if (tooltipRect.right > window.innerWidth) {
                    tooltip.style.left = `${rect.left - tooltipRect.width - 10}px`;
                }
                
                // 3ç§’åè‡ªåŠ¨éšè—
                setTimeout(() => {
                    if (tooltip.parentNode) {
                        tooltip.parentNode.removeChild(tooltip);
                    }
                }, 3000);
            }
            
            zoom(factor) {
                this.scale = Math.max(0.1, Math.min(5, this.scale * factor));
                this.updateTransform();
            }
            
            resetView() {
                this.scale = 1;
                this.translateX = 0;
                this.translateY = 0;
                this.updateTransform();
            }
            
            updateTransform() {
                this.modalContainer.style.transform = `translate(${this.translateX}px, ${this.translateY}px) scale(${this.scale})`;
            }
            
            startDrag(e) {
                if (e.button !== 0) return; // åªå“åº”å·¦é”®
                
                this.isDragging = true;
                this.startX = e.clientX - this.translateX;
                this.startY = e.clientY - this.translateY;
                this.modalContainer.style.cursor = 'grabbing';
            }
            
            drag(e) {
                if (!this.isDragging) return;
                
                this.translateX = e.clientX - this.startX;
                this.translateY = e.clientY - this.startY;
                this.updateTransform();
            }
            
            stopDrag() {
                this.isDragging = false;
                this.modalContainer.style.cursor = 'grab';
            }
            
            exportImage() {
                // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„canvas
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // è®¾ç½®canvaså°ºå¯¸
                const container = this.modalContainer;
                const rect = container.getBoundingClientRect();
                
                canvas.width = rect.width * this.scale;
                canvas.height = rect.height * this.scale;
                
                // è®¾ç½®ç™½è‰²èƒŒæ™¯
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // æ·»åŠ æ ‡é¢˜
                ctx.font = 'bold 24px Arial';
                ctx.fillStyle = '#333';
                ctx.fillText('ç –å—æ’åˆ—å¹³é¢å›¾', 20, 40);
                
                // æ·»åŠ æ—¥æœŸ
                const date = new Date().toLocaleDateString();
                ctx.font = '14px Arial';
                ctx.fillStyle = '#666';
                ctx.fillText(`ç”Ÿæˆæ—¥æœŸ: ${date}`, 20, 70);
                
                // ç»˜åˆ¶å¹³é¢å›¾ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼Œå®é™…é¡¹ç›®ä¸­å¯èƒ½éœ€è¦æ›´å¤æ‚çš„æ¸²æŸ“ï¼‰
                ctx.save();
                ctx.translate(this.translateX * this.scale, this.translateY * this.scale);
                
                // è¿™é‡Œå¯ä»¥å®ç°æ›´å¤æ‚çš„ç»˜åˆ¶é€»è¾‘
                // ä¸ºäº†æ¼”ç¤ºï¼Œæˆ‘ä»¬åªæ˜¯ç®€å•åœ°ç»˜åˆ¶ä¸€äº›çŸ©å½¢
                
                ctx.restore();
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const link = document.createElement('a');
                link.download = `ç –å—å¹³é¢å›¾_${date.replace(/\//g, '-')}.png`;
                link.href = canvas.toDataURL();
                link.click();
            }
        }
        
        /**
         * å¹³é¢å›¾ç®—ç –è®¡ç®—å™¨
         */
        class PlanarBrickCalculator {
            constructor() {
                console.log('=== å¹³é¢å›¾ç®—ç –è®¡ç®—å™¨åˆå§‹åŒ– ===');
                
                // åˆå§‹åŒ–å±æ€§
                this.wallWidth = 5000;
                this.wallHeight = 5000;
                this.brickLength = 1500;
                this.brickWidth = 750;
                this.calculationType = 'wall';
                
                // è®¡ç®—ç»“æœ
                this.wholeBricks = 0;
                this.widthRemainingBricks = 0;
                this.heightRemainingBricks = 0;
                this.cornerBricks = 0;
                this.totalBricks = 0;
                
                // ä¸­é—´è®¡ç®—å€¼
                this.widthIntegerColumns = 0;
                this.heightIntegerColumns = 0;
                this.remainingWidth = 0;
                this.remainingHeight = 0;
            }
            
            /**
             * åˆå§‹åŒ–è®¡ç®—å™¨
             */
            init() {
                console.log('=== åˆå§‹åŒ–è®¡ç®—å™¨ ===');
                
                // è®¾ç½®é»˜è®¤å€¼
                this.setDefaultValues();
                
                // ç»‘å®šäº‹ä»¶
                this.bindEvents();
                
                // ç«‹å³è®¡ç®—ä¸€æ¬¡
                this.calculate();
            }
            
            /**
             * è®¾ç½®é»˜è®¤å€¼
             */
            setDefaultValues() {
                console.log('=== è®¾ç½®é»˜è®¤å€¼ ===');
                
                const defaults = {
                    'brick-wall-width': 5000,
                    'brick-wall-height': 3000,
                    'brick-column-width': 600,
                    'brick-column-height': 3000,
                    'brick-stair-length': 4000,
                    'brick-stair-width': 1200,
                    'brick-brick-length': 1200,
                    'brick-brick-width': 600,
                    'brick-calculation-type': 'wall'
                };
                
                for (const [id, value] of Object.entries(defaults)) {
                    const element = document.getElementById(id);
                    if (element) {
                        element.value = value;
                        console.log(`è®¾ç½® ${id} = ${value}`);
                    }
                }
            }
            
            /**
             * ç»‘å®šäº‹ä»¶
             */
            bindEvents() {
                console.log('=== ç»‘å®šäº‹ä»¶ ===');
                
                // è®¡ç®—æŒ‰é’®
                const calcBtn = document.getElementById('brick-calculate-btn');
                if (calcBtn) {
                    calcBtn.onclick = () => {
                        console.log('è®¡ç®—æŒ‰é’®ç‚¹å‡»');
                        this.calculate();
                    };
                }
                
                // è®¡ç®—ç±»å‹é€‰æ‹©
                const typeSelect = document.getElementById('brick-calculation-type');
                if (typeSelect) {
                    typeSelect.onchange = (e) => {
                        console.log('è®¡ç®—ç±»å‹æ”¹å˜ä¸º:', e.target.value);
                        this.calculationType = e.target.value;
                        this.togglePanels();
                        this.calculate();
                    };
                }
                
                // è¾“å…¥æ¡†å˜åŒ–
                const inputs = ['brick-wall-width', 'brick-wall-height', 'brick-column-width', 'brick-column-height', 
                               'brick-stair-length', 'brick-stair-width', 'brick-brick-length', 'brick-brick-width'];
                for (const id of inputs) {
                    const input = document.getElementById(id);
                    if (input) {
                        input.onchange = () => {
                            console.log(`${id} å€¼æ”¹å˜`);
                            this.calculate();
                        };
                    }
                }
            }
            
            /**
             * åˆ‡æ¢é¢æ¿æ˜¾ç¤º
             */
            togglePanels() {
                console.log('=== åˆ‡æ¢é¢æ¿ ===');
                
                const panels = {
                    'wall': document.getElementById('brick-wall-dimensions'),
                    'column': document.getElementById('brick-column-dimensions'),
                    'stair': document.getElementById('brick-stair-dimensions')
                };
                
                // éšè—æ‰€æœ‰é¢æ¿
                for (const panel of Object.values(panels)) {
                    if (panel) panel.classList.add('hidden');
                }
                
                // æ˜¾ç¤ºå½“å‰é¢æ¿
                const activePanel = panels[this.calculationType];
                if (activePanel) {
                    activePanel.classList.remove('hidden');
                    console.log(`æ˜¾ç¤º ${this.calculationType} é¢æ¿`);
                }
            }
            
            /**
             * è·å–è¾“å…¥å€¼
             */
            getInputValue(id, defaultValue) {
                const element = document.getElementById(id);
                return element ? parseInt(element.value) || defaultValue : defaultValue;
            }
            
            /**
             * ä¸»è®¡ç®—å‡½æ•°
             */
            calculate() {
                console.log('=== å¼€å§‹è®¡ç®— ===');
                
                // è·å–å‚æ•°
                this.brickLength = this.getInputValue('brick-brick-length', 1500);
                this.brickWidth = this.getInputValue('brick-brick-width', 750);
                
                // æ ¹æ®ç±»å‹è®¡ç®—
                switch (this.calculationType) {
                    case 'wall':
                        this.calculateWall();
                        break;
                    case 'column':
                        this.calculateColumn();
                        break;
                    case 'stair':
                        this.calculateStair();
                        break;
                }
                
                // æ›´æ–°UI
                this.updateUI();
                
                // ç»˜åˆ¶å¹³é¢å›¾ï¼ˆä»…å¢™é¢ï¼‰
                if (this.calculationType === 'wall') {
                    this.drawPlan();
                } else {
                    // æ¸…ç©ºå¹³é¢å›¾å®¹å™¨
                    const container = document.getElementById('brick-planar-container');
                    if (container) {
                        container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #999; font-size: 1.2rem;">ä»…å¢™é¢è®¡ç®—æ”¯æŒå¹³é¢å›¾å±•ç¤º</div>';
                    }
                }
            }
            
            /**
             * è®¡ç®—å¢™é¢
             */
            calculateWall() {
                console.log('=== è®¡ç®—å¢™é¢ ===');
                
                this.wallWidth = this.getInputValue('brick-wall-width', 5000);
                this.wallHeight = this.getInputValue('brick-wall-height', 5000);
                
                console.log(`å¢™é¢: ${this.wallWidth}Ã—${this.wallHeight}mm, ç –å—: ${this.brickLength}Ã—${this.brickWidth}mm`);
                
                // è®¡ç®—æ•´æ•°åˆ—
                this.widthIntegerColumns = Math.floor(this.wallWidth / this.brickWidth);
                this.heightIntegerColumns = Math.floor(this.wallHeight / this.brickLength);
                
                // è®¡ç®—å‰©ä½™
                this.remainingWidth = this.wallWidth - this.widthIntegerColumns * this.brickWidth;
                this.remainingHeight = this.wallHeight - this.heightIntegerColumns * this.brickLength;
                
                // è®¡ç®—ç –å—æ•°
                this.wholeBricks = this.widthIntegerColumns * this.heightIntegerColumns;
                this.widthRemainingBricks = this.remainingWidth > 0 ? this.heightIntegerColumns : 0;
                this.heightRemainingBricks = this.remainingHeight > 0 ? this.widthIntegerColumns : 0;
                this.cornerBricks = (this.remainingWidth > 0 && this.remainingHeight > 0) ? 1 : 0;
                
                // æ€»ç –å—æ•°
                this.totalBricks = this.wholeBricks + this.widthRemainingBricks + 
                                  this.heightRemainingBricks - this.cornerBricks;
                
                console.log(`ç»“æœ: æ•´ç –=${this.wholeBricks}, å®½ä½™=${this.widthRemainingBricks}, é«˜ä½™=${this.heightRemainingBricks}, è§’è½=${this.cornerBricks}, æ€»è®¡=${this.totalBricks}`);
            }
            
            /**
             * è®¡ç®—æŸ±å­
             */
            calculateColumn() {
                console.log('=== è®¡ç®—æŸ±å­ ===');
                
                const columnWidth = this.getInputValue('brick-column-width', 600);
                const columnHeight = this.getInputValue('brick-column-height', 3000);
                
                console.log(`æŸ±å­: ${columnWidth}Ã—${columnHeight}mm, ç –å—: ${this.brickLength}Ã—${this.brickWidth}mm`);
                
                // å‘¨é•¿å’Œé¢ç§¯
                const perimeter = columnWidth * 4;
                const area = perimeter * columnHeight / 1000000; // è½¬æ¢ä¸ºå¹³æ–¹ç±³
                
                // æ¯å¹³æ–¹ç±³ç”¨ç –é‡
                const bricksPerM2 = 1000000 / (this.brickLength * this.brickWidth);
                
                // æ€»ç”¨ç –é‡ï¼ˆåŠ 10%æŸè€—ï¼‰
                this.totalBricks = Math.ceil(area * bricksPerM2 * 1.1);
                
                // é‡ç½®å…¶ä»–è®¡æ•°
                this.wholeBricks = 0;
                this.widthRemainingBricks = 0;
                this.heightRemainingBricks = 0;
                this.cornerBricks = 0;
                
                console.log(`ç»“æœ: æ€»é¢ç§¯=${area.toFixed(2)}mÂ², æ¯å¹³ç”¨ç –=${bricksPerM2.toFixed(2)}, æ€»è®¡=${this.totalBricks}`);
            }
            
            /**
             * è®¡ç®—æ¥¼æ¢¯
             */
            calculateStair() {
                console.log('=== è®¡ç®—æ¥¼æ¢¯ ===');
                
                const stairLength = this.getInputValue('brick-stair-length', 4000);
                const stairWidth = this.getInputValue('brick-stair-width', 1200);
                
                console.log(`æ¥¼æ¢¯: ${stairLength}Ã—${stairWidth}mm, ç –å—: ${this.brickLength}Ã—${this.brickWidth}mm`);
                
                // æŠ•å½±é¢ç§¯
                const area = stairLength * stairWidth / 1000000; // è½¬æ¢ä¸ºå¹³æ–¹ç±³
                
                // æ¯å¹³æ–¹ç±³ç”¨ç –é‡
                const bricksPerM2 = 1000000 / (this.brickLength * this.brickWidth);
                
                // æ€»ç”¨ç –é‡ï¼ˆåŠ 20%æŸè€—ï¼‰
                this.totalBricks = Math.ceil(area * bricksPerM2 * 1.2);
                
                // é‡ç½®å…¶ä»–è®¡æ•°
                this.wholeBricks = 0;
                this.widthRemainingBricks = 0;
                this.heightRemainingBricks = 0;
                this.cornerBricks = 0;
                
                console.log(`ç»“æœ: æŠ•å½±é¢ç§¯=${area.toFixed(2)}mÂ², æ¯å¹³ç”¨ç –=${bricksPerM2.toFixed(2)}, æ€»è®¡=${this.totalBricks}`);
            }
            
            /**
             * æ›´æ–°UIæ˜¾ç¤º
             */
            updateUI() {
                console.log('=== æ›´æ–°UI ===');
                
                // æ›´æ–°ç»“æœæ˜¾ç¤º
                this.updateResults();
                
                // æ›´æ–°è®¡ç®—æ­¥éª¤
                this.updateSteps();
            }
            
            /**
             * æ›´æ–°ç»“æœæ˜¾ç¤º
             */
            updateResults() {
                const results = {
                    'brick-whole-bricks': this.wholeBricks,
                    'brick-whole-bricks-detail': this.calculationType === 'wall' ? `${this.widthIntegerColumns}Ã—${this.heightIntegerColumns} ç‰‡` : '',
                    'brick-width-remaining-bricks': this.widthRemainingBricks,
                    'brick-width-remaining-detail': this.calculationType === 'wall' ? `${this.widthRemainingBricks} ç‰‡` : '',
                    'brick-height-remaining-bricks': this.heightRemainingBricks,
                    'brick-height-remaining-detail': this.calculationType === 'wall' ? `${this.heightRemainingBricks} ç‰‡` : '',
                    'brick-total-bricks': this.totalBricks,
                    'brick-total-bricks-detail': `${this.totalBricks} ç‰‡`
                };
                
                for (const [id, value] of Object.entries(results)) {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = value;
                        console.log(`æ›´æ–° ${id} = ${value}`);
                    }
                }
            }
            
            /**
             * æ›´æ–°è®¡ç®—æ­¥éª¤
             */
            updateSteps() {
                const stepsContainer = document.getElementById('brick-calculation-steps');
                if (!stepsContainer) return;
                
                let steps = [];
                
                switch (this.calculationType) {
                    case 'wall':
                        steps = this.getWallSteps();
                        break;
                    case 'column':
                        steps = this.getColumnSteps();
                        break;
                    case 'stair':
                        steps = this.getStairSteps();
                        break;
                }
                
                stepsContainer.innerHTML = steps.join('');
                console.log('è®¡ç®—æ­¥éª¤å·²æ›´æ–°');
            }
            
            /**
             * è·å–å¢™é¢è®¡ç®—æ­¥éª¤
             */
            getWallSteps() {
                return [
                    `<p><strong>æ­¥éª¤1ï¼š</strong>è®¡ç®—æ•´æ•°åˆ—</p>`,
                    `<p class="pl-4">å¢™é¢å®½åº¦Ã·ç“·ç –å®½åº¦ = ${this.wallWidth}Ã·${this.brickWidth} = ${(this.wallWidth/this.brickWidth).toFixed(4)} â†’ å‘ä¸‹å–æ•´ä¸º ${this.widthIntegerColumns} åˆ—</p>`,
                    `<p class="pl-4">å¢™é¢é«˜åº¦Ã·ç“·ç –é«˜åº¦ = ${this.wallHeight}Ã·${this.brickLength} = ${(this.wallHeight/this.brickLength).toFixed(4)} â†’ å‘ä¸‹å–æ•´ä¸º ${this.heightIntegerColumns} åˆ—</p>`,
                    `<p><strong>æ­¥éª¤2ï¼š</strong>è®¡ç®—å‰©ä½™æœªé“ºè´´å°ºå¯¸</p>`,
                    `<p class="pl-4">å‰©ä½™æœªé“ºè´´å®½åº¦ = ${this.wallWidth} - ${this.widthIntegerColumns}Ã—${this.brickWidth} = ${this.remainingWidth}mm</p>`,
                    `<p class="pl-4">å‰©ä½™æœªé“ºè´´é«˜åº¦ = ${this.wallHeight} - ${this.heightIntegerColumns}Ã—${this.brickLength} = ${this.remainingHeight}mm</p>`,
                    `<p><strong>æ­¥éª¤3ï¼š</strong>è®¡ç®—å„åŒºåŸŸç”¨ç –é‡</p>`,
                    `<p class="pl-4">æ•´ç –åŒºåŸŸç”¨ç – = ${this.widthIntegerColumns}Ã—${this.heightIntegerColumns} = ${this.wholeBricks}ç‰‡</p>`,
                    this.remainingWidth > 0 ? `<p class="pl-4">å®½åº¦å‰©ä½™åŒºåŸŸç”¨ç – = ${this.heightIntegerColumns} = ${this.widthRemainingBricks}ç‰‡ï¼ˆè¦†ç›–æ•´ä¸ªå¢™é¢é«˜åº¦ï¼‰</p>` : '',
                    this.remainingHeight > 0 ? `<p class="pl-4">é«˜åº¦å‰©ä½™åŒºåŸŸç”¨ç – = ${this.widthIntegerColumns} = ${this.heightRemainingBricks}ç‰‡ï¼ˆè¦†ç›–æ•´ä¸ªå¢™é¢å®½åº¦ï¼‰</p>` : '',
                    this.cornerBricks > 0 ? `<p class="pl-4">è§’è½åŒºåŸŸé‡å¤è®¡ç®—ï¼Œéœ€è¦å‡å» = ${this.cornerBricks}ç‰‡</p>` : '',
                    `<p><strong>æ­¥éª¤4ï¼š</strong>è®¡ç®—æ€»ç”¨ç –é‡</p>`,
                    `<p class="pl-4">æ€»ç”¨ç –é‡ = ${this.wholeBricks}${this.widthRemainingBricks > 0 ? ` + ${this.widthRemainingBricks}` : ''}${this.heightRemainingBricks > 0 ? ` + ${this.heightRemainingBricks}` : ''}${this.cornerBricks > 0 ? ` - ${this.cornerBricks}` : ''} = ${this.totalBricks}ç‰‡</p>`
                ].filter(Boolean);
            }
            
            /**
             * è·å–æŸ±å­è®¡ç®—æ­¥éª¤
             */
            getColumnSteps() {
                const columnWidth = this.getInputValue('brick-column-width', 600);
                const columnHeight = this.getInputValue('brick-column-height', 3000);
                const perimeter = columnWidth * 4;
                const area = perimeter * columnHeight / 1000000;
                const bricksPerM2 = 1000000 / (this.brickLength * this.brickWidth);
                
                return [
                    `<p><strong>æ­¥éª¤1ï¼š</strong>è®¡ç®—æŸ±å­å‘¨é•¿</p>`,
                    `<p class="pl-4">æŸ±å­å‘¨é•¿ = ${columnWidth}Ã—4 = ${perimeter}mm</p>`,
                    `<p><strong>æ­¥éª¤2ï¼š</strong>è®¡ç®—æŸ±å­è¡¨é¢ç§¯</p>`,
                    `<p class="pl-4">æŸ±å­è¡¨é¢ç§¯ = ${perimeter}Ã—${columnHeight}Ã·1000000 = ${area.toFixed(2)}mÂ²</p>`,
                    `<p><strong>æ­¥éª¤3ï¼š</strong>è®¡ç®—æ¯å¹³æ–¹ç±³ç”¨ç –é‡</p>`,
                    `<p class="pl-4">æ¯å¹³æ–¹ç±³ç”¨ç –é‡ = 1000000Ã·(${this.brickLength}Ã—${this.brickWidth}) = ${bricksPerM2.toFixed(2)}ç‰‡</p>`,
                    `<p><strong>æ­¥éª¤4ï¼š</strong>è®¡ç®—æ€»ç”¨ç –é‡ï¼ˆåŠ 10%æŸè€—ï¼‰</p>`,
                    `<p class="pl-4">æ€»ç”¨ç –é‡ = ${area.toFixed(2)}Ã—${bricksPerM2.toFixed(2)}Ã—1.1 = ${this.totalBricks}ç‰‡</p>`
                ];
            }
            
            /**
             * è·å–æ¥¼æ¢¯è®¡ç®—æ­¥éª¤
             */
            getStairSteps() {
                const stairLength = this.getInputValue('brick-stair-length', 4000);
                const stairWidth = this.getInputValue('brick-stair-width', 1200);
                const area = stairLength * stairWidth / 1000000;
                const bricksPerM2 = 1000000 / (this.brickLength * this.brickWidth);
                
                return [
                    `<p><strong>æ­¥éª¤1ï¼š</strong>è®¡ç®—æ¥¼æ¢¯æŠ•å½±é¢ç§¯</p>`,
                    `<p class="pl-4">æŠ•å½±é¢ç§¯ = ${stairLength}Ã—${stairWidth}Ã·1000000 = ${area.toFixed(2)}mÂ²</p>`,
                    `<p><strong>æ­¥éª¤2ï¼š</strong>è®¡ç®—æ¯å¹³æ–¹ç±³ç”¨ç –é‡</p>`,
                    `<p class="pl-4">æ¯å¹³æ–¹ç±³ç”¨ç –é‡ = 1000000Ã·(${this.brickLength}Ã—${this.brickWidth}) = ${bricksPerM2.toFixed(2)}ç‰‡</p>`,
                    `<p><strong>æ­¥éª¤3ï¼š</strong>è®¡ç®—æ€»ç”¨ç –é‡ï¼ˆåŠ 20%æŸè€—ï¼‰</p>`,
                    `<p class="pl-4">æ€»ç”¨ç –é‡ = ${area.toFixed(2)}Ã—${bricksPerM2.toFixed(2)}Ã—1.2 = ${this.totalBricks}ç‰‡</p>`
                ];
            }
            
            /**
             * ç»˜åˆ¶å¹³é¢å›¾
             */
            drawPlan() {
                console.log('=== ç»˜åˆ¶å¹³é¢å›¾ ===');
                
                const container = document.getElementById('brick-planar-container');
                if (!container) {
                    console.error('å¹³é¢å›¾å®¹å™¨ä¸å­˜åœ¨!');
                    return;
                }
                
                // æ¸…ç©ºå®¹å™¨
                container.innerHTML = '';
                
                // è®¾ç½®å®¹å™¨æ ·å¼
                container.style.position = 'relative';
                container.style.width = '100%';
                container.style.height = '500px';
                container.style.border = '2px solid #607d8b';
                container.style.backgroundColor = '#f9fafb';
                container.style.margin = '0 auto';
                container.style.boxSizing = 'border-box';
                container.style.borderRadius = '8px';
                
                // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
                const maxDim = Math.max(this.wallWidth, this.wallHeight);
                const scale = 450 / maxDim; // ç•™50pxè¾¹è·
                
                console.log(`ç¼©æ”¾æ¯”ä¾‹: ${scale}`);
                
                // ç»˜åˆ¶ç –å—
                const brickW = this.brickWidth * scale;
                const brickH = this.brickLength * scale;
                
                console.log(`ç –å—å°ºå¯¸: ${brickW.toFixed(2)}Ã—${brickH.toFixed(2)}px`);
                
                // ç»˜åˆ¶æ•´ç –
                let brickNum = 1;
                
                for (let row = 0; row < this.heightIntegerColumns; row++) {
                    for (let col = 0; col < this.widthIntegerColumns; col++) {
                        this.drawBrick(container, col * brickW, row * brickH, brickW, brickH, brickNum++, 'whole');
                    }
                }
                
                // ç»˜åˆ¶å®½åº¦å‰©ä½™
                if (this.remainingWidth > 0) {
                    const remW = this.remainingWidth * scale;
                    for (let row = 0; row < this.heightIntegerColumns; row++) {
                        this.drawBrick(container, this.widthIntegerColumns * brickW, row * brickH, remW, brickH, brickNum++, 'width-remaining');
                    }
                }
                
                // ç»˜åˆ¶é«˜åº¦å‰©ä½™
                if (this.remainingHeight > 0) {
                    const remH = this.remainingHeight * scale;
                    for (let col = 0; col < this.widthIntegerColumns; col++) {
                        this.drawBrick(container, col * brickW, this.heightIntegerColumns * brickH, brickW, remH, brickNum++, 'height-remaining');
                    }
                }
                
                // ç»˜åˆ¶è§’è½
                if (this.remainingWidth > 0 && this.remainingHeight > 0) {
                    this.drawBrick(container, this.widthIntegerColumns * brickW, this.heightIntegerColumns * brickH, 
                                  this.remainingWidth * scale, this.remainingHeight * scale, brickNum++, 'corner');
                }
                
                console.log('å¹³é¢å›¾ç»˜åˆ¶å®Œæˆ');
            }
            
            /**
             * ç»˜åˆ¶å•ä¸ªç –å—
             */
            drawBrick(container, x, y, width, height, number, type) {
                const brick = document.createElement('div');
                
                // åŸºæœ¬æ ·å¼
                brick.style.position = 'absolute';
                brick.style.left = `${x}px`;
                brick.style.top = `${y}px`;
                brick.style.width = `${width}px`;
                brick.style.height = `${height}px`;
                brick.style.display = 'flex';
                brick.style.alignItems = 'center';
                brick.style.justifyContent = 'center';
                brick.style.fontSize = '12px';
                brick.style.fontWeight = 'bold';
                brick.style.color = '#333';
                brick.style.boxSizing = 'border-box';
                brick.style.border = '1px solid';
                brick.style.transition = 'all 0.3s ease';
                brick.classList.add('brick-item', type);
                
                // é¢œè‰²
                const colors = {
                    'whole': ['#fff9c4', '#ffd54f'],
                    'width-remaining': ['#bbdefb', '#64b5f6'],
                    'height-remaining': ['#c8e6c9', '#81c784'],
                    'corner': ['#e1bee7', '#ba68c8']
                };
                
                const [bg, border] = colors[type] || colors.whole;
                brick.style.backgroundColor = bg;
                brick.style.borderColor = border;
                
                // ç¼–å·
                brick.textContent = number;
                
                // æ·»åŠ 
                container.appendChild(brick);
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–è®¡ç®—å™¨
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–è®¡ç®—å™¨');
            const calculator = new PlanarBrickCalculator();
            calculator.init();
            
            // åˆå§‹åŒ–æ¨¡æ€æ¡†ç®¡ç†å™¨
            const modalManager = new PlanarModalManager(calculator);
            
            // åˆå§‹åŒ–ç –å—æ’åˆ—å¹³é¢å›¾æ¨¡æ€æ¡†ç®¡ç†å™¨
            const brickModalManager = new BrickPlanarModalManager();
        });
    </script>

    <!-- é€šçŸ¥æç¤º -->
    <div id="notification" class="fixed top-4 right-4 z-50 max-w-xs hidden">
        <div class="bg-white/80 backdrop-blur-sm rounded-lg shadow-lg p-4 border-l-4 border-primary">
            <div class="flex items-start">
                <div id="notification-icon" class="flex-shrink-0 text-primary mr-3">
                    <i class="fa fa-check-circle text-xl"></i>
                </div>
                <div class="flex-1">
                    <h4 id="notification-title" class="text-sm font-medium text-dark">æ“ä½œæˆåŠŸ</h4>
                    <p id="notification-message" class="text-xs text-dark-3 mt-1">æ‚¨çš„æ“ä½œå·²æˆåŠŸå®Œæˆ</p>
                </div>
                <button id="close-notification" class="text-dark-3 hover:text-dark ml-4">
                    <i class="fa fa-times"></i>
                </button>
            </div>
        </div>
    </div>

</body></html>